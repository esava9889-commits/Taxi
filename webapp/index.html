<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–û–±–µ—Ä—ñ—Ç—å –º—ñ—Å—Ü–µ –Ω–∞ –∫–∞—Ä—Ç—ñ</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            overflow: hidden;
            background: var(--tg-theme-bg-color, #ffffff);
        }
        
        #map {
            width: 100vw;
            height: 100vh;
            position: absolute;
            top: 0;
            left: 0;
        }
        
        .info-panel {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--tg-theme-bg-color, #ffffff);
            padding: 12px 20px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 1000;
            max-width: 90%;
            text-align: center;
            color: var(--tg-theme-text-color, #000000);
        }
        
        .info-panel h3 {
            font-size: 16px;
            margin-bottom: 5px;
            font-weight: 600;
        }
        
        .info-panel p {
            font-size: 13px;
            color: var(--tg-theme-hint-color, #999999);
        }
        
        .coordinates {
            position: absolute;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--tg-theme-bg-color, #ffffff);
            padding: 10px 16px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            z-index: 1000;
            font-size: 12px;
            color: var(--tg-theme-text-color, #000000);
            display: none;
        }
        
        .marker-icon {
            background: transparent;
            border: none;
        }
        
        .pulse {
            width: 30px;
            height: 30px;
            border: 5px solid var(--tg-theme-button-color, #3390ec);
            border-radius: 50%;
            background: var(--tg-theme-button-color, #3390ec);
            opacity: 0.8;
            position: relative;
        }
        
        .pulse::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 40px;
            height: 40px;
            border: 2px solid var(--tg-theme-button-color, #3390ec);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            animation: pulse 1.5s ease-out infinite;
            opacity: 0;
        }
        
        @keyframes pulse {
            0% {
                transform: translate(-50%, -50%) scale(0.5);
                opacity: 1;
            }
            100% {
                transform: translate(-50%, -50%) scale(1.5);
                opacity: 0;
            }
        }
        
        .locate-button {
            position: absolute;
            bottom: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            background: var(--tg-theme-button-color, #3390ec);
            border: none;
            border-radius: 50%;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            cursor: pointer;
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--tg-theme-button-text-color, #ffffff);
            font-size: 24px;
        }
        
        .locate-button:active {
            transform: scale(0.95);
        }
        
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 2000;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 20px 30px;
            border-radius: 10px;
            display: none;
        }
        
        /* üîç DEBUG –ü–ê–ù–ï–õ–¨ - –ø–æ–∫–∞–∑—É—î —Å—Ç–∞—Ç—É—Å –¥–ª—è –¥—ñ–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ */
        .debug-panel {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.9);
            color: #00ff00;
            font-family: monospace;
            font-size: 11px;
            padding: 8px;
            z-index: 9999;
            max-height: 150px;
            overflow-y: auto;
            border-top: 2px solid #00ff00;
        }
        
        .debug-panel .debug-line {
            margin: 2px 0;
            padding: 2px 4px;
        }
        
        .debug-panel .debug-success {
            color: #00ff00;
        }
        
        .debug-panel .debug-error {
            color: #ff0000;
            font-weight: bold;
        }
        
        .debug-panel .debug-warning {
            color: #ffaa00;
        }
        
        .debug-panel .debug-info {
            color: #00aaff;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    
    <div class="info-panel">
        <h3>üó∫ –û–±–µ—Ä—ñ—Ç—å –º—ñ—Å—Ü–µ –Ω–∞ –∫–∞—Ä—Ç—ñ</h3>
        <p>–ù–∞—Ç–∏—Å–Ω—ñ—Ç—å –Ω–∞ –∫–∞—Ä—Ç—É, —â–æ–± –≤—Å—Ç–∞–Ω–æ–≤–∏—Ç–∏ —Ç–æ—á–∫—É</p>
    </div>
    
    <div class="coordinates" id="coordinates">
        <strong>üìç –û–±—Ä–∞–Ω–æ:</strong> <span id="coords-text"></span>
    </div>
    
    <button class="locate-button" id="locate-btn" title="–ú–æ—è –≥–µ–æ–ª–æ–∫–∞—Ü—ñ—è">
        üìç
    </button>
    
    <div class="loading" id="loading">
        <p>‚è≥ –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</p>
    </div>
    
    <!-- üîç DEBUG –ü–ê–ù–ï–õ–¨ - –ø–æ–∫–∞–∑—É—î —Å—Ç–∞—Ç—É—Å –æ–ø–µ—Ä–∞—Ü—ñ–π -->
    <div class="debug-panel" id="debug-panel">
        <div class="debug-line debug-info">üîç DEBUG MODE: –ü–æ–∫–∞–∑—É—î —Å—Ç–∞—Ç—É—Å –æ–ø–µ—Ä–∞—Ü—ñ–π</div>
    </div>
    
    <!-- Telegram WebApp SDK -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script>
        // ===== –§–£–ù–ö–¶–Ü–Ø –î–õ–Ø DEBUG –ü–ê–ù–ï–õ–Ü =====
        function addDebugLog(message, type = 'info') {
            const debugPanel = document.getElementById('debug-panel');
            const line = document.createElement('div');
            line.className = `debug-line debug-${type}`;
            const time = new Date().toLocaleTimeString('uk-UA');
            line.textContent = `[${time}] ${message}`;
            debugPanel.appendChild(line);
            
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∏–π scroll –≤–Ω–∏–∑
            debugPanel.scrollTop = debugPanel.scrollHeight;
            
            // –¢–∞–∫–æ–∂ –≤ console
            console.log(`[DEBUG] ${message}`);
        }
        
        // ===== –î–ï–¢–ê–õ–¨–ù–ï –õ–û–ì–£–í–ê–ù–ù–Ø =====
        console.log('='.repeat(60));
        console.log('üöÄ WEBAPP START:', new Date().toISOString());
        console.log('='.repeat(60));
        
        addDebugLog('üöÄ WebApp –∑–∞–ø—É—â–µ–Ω–æ', 'success');
        
        // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è Telegram WebApp
        const tg = window.Telegram.WebApp;
        console.log('‚úÖ Telegram WebApp initialized:', tg);
        addDebugLog('‚úÖ Telegram WebApp —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–æ–≤–∞–Ω–æ', 'success');
        
        console.log('üì± Version:', tg.version);
        console.log('üì± Platform:', tg.platform);
        addDebugLog(`üì± Platform: ${tg.platform}, v${tg.version}`, 'info');
        
        console.log('üé® Color scheme:', tg.colorScheme);
        console.log('üë§ User:', tg.initDataUnsafe?.user);
        console.log('üîç initData present:', !!tg.initData);
        console.log('üîç initData length:', tg.initData ? tg.initData.length : 0);
        console.log('üîç initData (first 100 chars):', tg.initData ? tg.initData.substring(0, 100) : 'EMPTY');
        
        // ‚ö†Ô∏è –ö–†–ò–¢–ò–ß–ù–ê –ü–ï–†–ï–í–Ü–†–ö–ê: initData –º–∞—î –±—É—Ç–∏!
        if (!tg.initData || tg.initData.length === 0) {
            console.error('‚ùå‚ùå‚ùå CRITICAL ERROR: initData is EMPTY!');
            console.error('‚ùå This means WebApp was NOT opened through bot button!');
            console.error('‚ùå tg.sendData() will NOT work without initData!');
            addDebugLog('‚ùå initData –ü–û–†–û–ñ–ù–Ñ! WebApp –≤—ñ–¥–∫—Ä–∏—Ç–æ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ!', 'error');
            addDebugLog('‚ö†Ô∏è –í—ñ–¥–∫—Ä–∏–π—Ç–µ —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫—É –≤ –±–æ—Ç—ñ!', 'warning');
        } else {
            console.log('‚úÖ initData is present - WebApp opened correctly through bot');
            addDebugLog(`‚úÖ initData –ø—Ä–∏—Å—É—Ç–Ω—î (${tg.initData.length} —Å–∏–º–≤–æ–ª—ñ–≤)`, 'success');
        }
        
        // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ API
        console.log('üîç API methods available:');
        console.log('  - MainButton:', typeof tg.MainButton);
        console.log('  - sendData:', typeof tg.sendData);
        console.log('  - close:', typeof tg.close);
        console.log('  - expand:', typeof tg.expand);
        
        tg.expand(); // –†–æ–∑–≥–æ—Ä–Ω—É—Ç–∏ –Ω–∞ –≤–µ—Å—å –µ–∫—Ä–∞–Ω
        console.log('‚úÖ WebApp expanded');
        
        tg.MainButton.setText('‚úÖ –ü—ñ–¥—Ç–≤–µ—Ä–¥–∏—Ç–∏ –º—ñ—Å—Ü–µ');
        tg.MainButton.hide(); // –°–ø–æ—á–∞—Ç–∫—É —Å—Ö–æ–≤–∞—Ç–∏
        
        console.log('üîò MainButton configured');
        console.log('  - Text:', tg.MainButton.text);
        console.log('  - isVisible:', tg.MainButton.isVisible);
        console.log('='.repeat(60));
        
        // –ó–∞—Å—Ç–æ—Å—É–≤–∞—Ç–∏ —Ç–µ–º—É Telegram
        document.body.style.backgroundColor = tg.themeParams.bg_color || '#ffffff';
        
        // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è –∫–∞—Ä—Ç–∏ (—Ü–µ–Ω—Ç—Ä –£–∫—Ä–∞—ó–Ω–∏)
        const map = L.map('map', {
            zoomControl: false, // –ü—Ä–∏–±—Ä–∞—Ç–∏ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∏–π zoom control
        }).setView([48.3794, 31.1656], 6); // –£–∫—Ä–∞—ó–Ω–∞
        
        // üåô –¢–ï–ú–ù–ê –ö–ê–†–¢–ê (—è–∫ Uber/Apple Maps Dark)
        // Dark Matter - —Å–ø—Ä–∞–≤–¥—ñ —Ç–µ–º–Ω–∞ –∫–∞—Ä—Ç–∞ –∑ —á–æ—Ä–Ω–∏–º —Ñ–æ–Ω–æ–º!
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
            attribution: '¬© CARTO ¬© OpenStreetMap',
            maxZoom: 19,
            subdomains: 'abcd'
        }).addTo(map);
        
        console.log('üåô Dark Matter map theme loaded (true dark mode)');
        
        // –î–æ–¥–∞—Ç–∏ zoom control –≤ —ñ–Ω—à–µ –º—ñ—Å—Ü–µ
        L.control.zoom({
            position: 'bottomleft'
        }).addTo(map);
        
        // –ó–º—ñ–Ω–Ω—ñ –¥–ª—è –∑–±–µ—Ä—ñ–≥–∞–Ω–Ω—è –º–∞—Ä–∫–µ—Ä–∞ —Ç–∞ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç
        let selectedMarker = null;
        let selectedCoords = null;
        
        // –°—Ç–≤–æ—Ä–µ–Ω–Ω—è –∫–∞—Å—Ç–æ–º–Ω–æ–≥–æ –º–∞—Ä–∫–µ—Ä–∞
        const createMarkerIcon = () => {
            return L.divIcon({
                className: 'marker-icon',
                html: '<div class="pulse"></div>',
                iconSize: [30, 30],
                iconAnchor: [15, 15]
            });
        };
        
        // –û–±—Ä–æ–±–Ω–∏–∫ –∫–ª—ñ–∫—É –ø–æ –∫–∞—Ä—Ç—ñ
        map.on('click', (e) => {
            const { lat, lng } = e.latlng;
            console.log('='.repeat(60));
            console.log('üó∫ MAP CLICKED:', new Date().toISOString());
            console.log('='.repeat(60));
            console.log('üìç Click position:', lat, lng);
            console.log('üìç e.latlng object:', e.latlng);
            
            addDebugLog(`üó∫ –ö–ª—ñ–∫ –Ω–∞ –∫–∞—Ä—Ç—É: ${lat.toFixed(4)}, ${lng.toFixed(4)}`, 'info');
            
            // üîî –î–Ü–ê–ì–ù–û–°–¢–ò–ö–ê: Alert –ø—Ä–∏ –∫–ª—ñ–∫—É –Ω–∞ –∫–∞—Ä—Ç—É
            // (–ó–∞–∫–æ–º–µ–Ω—Ç–æ–≤–∞–Ω–æ —â–æ–± –Ω–µ –∑–∞–≤–∞–∂–∞–ª–æ, —Ä–æ–∑–∫–æ–º–µ–Ω—Ç—É–π—Ç–µ —è–∫—â–æ –ø–æ—Ç—Ä—ñ–±–Ω–æ)
            // alert('üó∫ –ö–ª—ñ–∫ –ø–æ –∫–∞—Ä—Ç—ñ!\nLat: ' + lat.toFixed(4) + '\nLng: ' + lng.toFixed(4));
            
            // –í–∏–¥–∞–ª–∏—Ç–∏ –ø–æ–ø–µ—Ä–µ–¥–Ω—ñ–π –º–∞—Ä–∫–µ—Ä
            if (selectedMarker) {
                console.log('üóë Removing previous marker');
                map.removeLayer(selectedMarker);
            }
            
            // –î–æ–¥–∞—Ç–∏ –Ω–æ–≤–∏–π –º–∞—Ä–∫–µ—Ä
            console.log('üìå Adding new marker...');
            selectedMarker = L.marker([lat, lng], {
                icon: createMarkerIcon()
            }).addTo(map);
            console.log('‚úÖ Marker added to map');
            
            // –ó–±–µ—Ä–µ–≥—Ç–∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏
            selectedCoords = { lat, lng };
            console.log('üíæ Coordinates saved to selectedCoords:', selectedCoords);
            console.log('üîç Type of selectedCoords:', typeof selectedCoords);
            console.log('üîç selectedCoords.lat:', selectedCoords.lat);
            console.log('üîç selectedCoords.lng:', selectedCoords.lng);
            
            // –ü–æ–∫–∞–∑–∞—Ç–∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏
            const coordsText = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
            document.getElementById('coords-text').textContent = coordsText;
            document.getElementById('coordinates').style.display = 'block';
            console.log('‚úÖ Coordinates displayed:', coordsText);
            
            // –ü–æ–∫–∞–∑–∞—Ç–∏ –∫–Ω–æ–ø–∫—É –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è
            console.log('üîò Showing MainButton...');
            console.log('  - BEFORE show(): isVisible =', tg.MainButton.isVisible);
            tg.MainButton.show();
            console.log('  - AFTER show(): isVisible =', tg.MainButton.isVisible);
            console.log('‚úÖ MainButton.show() executed');
            console.log('='.repeat(60));
            
            addDebugLog('üîò –ö–Ω–æ–ø–∫–∞ "–ü—ñ–¥—Ç–≤–µ—Ä–¥–∏—Ç–∏" –ø–æ–∫–∞–∑–∞–Ω–∞', 'success');
            
            // –õ–µ–≥–∫–∞ –≤—ñ–±—Ä–∞—Ü—ñ—è (—è–∫—â–æ –¥–æ—Å—Ç—É–ø–Ω–∞)
            if (tg.HapticFeedback) {
                tg.HapticFeedback.impactOccurred('light');
            }
        });
        
        // –û–±—Ä–æ–±–Ω–∏–∫ –∫–Ω–æ–ø–∫–∏ "–ü—ñ–¥—Ç–≤–µ—Ä–¥–∏—Ç–∏"
        console.log('üîß Registering MainButton.onClick handler...');
        addDebugLog('üîß –û–±—Ä–æ–±–Ω–∏–∫ –∫–Ω–æ–ø–∫–∏ –∑–∞—Ä–µ—î—Å—Ç—Ä–æ–≤–∞–Ω–æ', 'info');
        
        tg.MainButton.onClick(() => {
            console.log('='.repeat(60));
            console.log('üîò MAINBUTTON CLICK EVENT:', new Date().toISOString());
            console.log('='.repeat(60));
            console.log('üìç Selected coords:', selectedCoords);
            console.log('üîç Type of selectedCoords:', typeof selectedCoords);
            console.log('üîç selectedCoords value:', JSON.stringify(selectedCoords));
            
            addDebugLog('üîò –ù–∞—Ç–∏—Å–Ω—É—Ç–æ "–ü—ñ–¥—Ç–≤–µ—Ä–¥–∏—Ç–∏ –º—ñ—Å—Ü–µ"', 'warning');

            if (selectedCoords) {
                console.log('‚úÖ Coordinates are valid, preparing data...');
                addDebugLog('‚úÖ –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏ –≤–∞–ª—ñ–¥–Ω—ñ, –≥–æ—Ç—É—î–º–æ –¥–∞–Ω—ñ...', 'success');
                
                const dataToSend = {
                    type: 'location',
                    latitude: selectedCoords.lat,
                    longitude: selectedCoords.lng
                };

                console.log('üì§ Data to send:', dataToSend);
                console.log('  - type:', dataToSend.type);
                console.log('  - latitude:', dataToSend.latitude);
                console.log('  - longitude:', dataToSend.longitude);

                try {
                    // –í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ –¥–∞–Ω—ñ –≤ –±–æ—Ç–∞
                    const jsonData = JSON.stringify(dataToSend);
                    console.log('üì¶ JSON string:', jsonData);
                    console.log('üì¶ JSON length:', jsonData.length);
                    addDebugLog(`üì¶ JSON: ${jsonData.substring(0, 50)}...`, 'info');

                    console.log('üì° Calling tg.sendData()...');
                    addDebugLog('üì° –í–∏–∫–ª–∏–∫–∞—î–º–æ tg.sendData()...', 'warning');
                    
                    tg.sendData(jsonData);
                    
                    console.log('‚úÖ tg.sendData() called successfully!');
                    addDebugLog('‚úÖ tg.sendData() –≤–∏–∫–ª–∏–∫–∞–Ω–æ —É—Å–ø—ñ—à–Ω–æ!', 'success');

                    // –í—ñ–±—Ä–∞—Ü—ñ—è —É—Å–ø—ñ—Ö—É
                    if (tg.HapticFeedback) {
                        console.log('üì≥ Triggering success haptic');
                        tg.HapticFeedback.notificationOccurred('success');
                    }

                    // üß™ –¢–ï–°–¢–û–í–ò–ô –†–ï–ñ–ò–ú: tg.close() –í–ò–ú–ö–ù–ï–ù–û!
                    // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —á–∏ –¥–∞–Ω—ñ –ø–µ—Ä–µ–¥–∞—é—Ç—å—Å—è –ë–ï–ó –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ–≥–æ –∑–∞–∫—Ä–∏—Ç—Ç—è WebApp
                    console.log('üß™ TEST MODE: tg.close() is DISABLED');
                    addDebugLog('üß™ –¢–ï–°–¢: tg.close() –í–ò–ú–ö–ù–ï–ù–û', 'warning');
                    addDebugLog('üì± –ö–∞—Ä—Ç–∞ –ù–ï –∑–∞–∫—Ä–∏—î—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ', 'info');
                    addDebugLog('‚úÖ –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ —á–∏ –¥–∞–Ω—ñ –ø—Ä–∏–π—à–ª–∏ –≤ –±–æ—Ç–∞!', 'success');
                    addDebugLog('üîô –ó–∞–∫—Ä–∏–π—Ç–µ –∫–∞—Ä—Ç—É –í–†–£–ß–ù–£ (–∫–Ω–æ–ø–∫–∞ –ù–∞–∑–∞–¥)', 'info');
                    
                    // ‚è∞ –ó–ê–¢–†–ò–ú–ö–ê: –¥–∞—Ç–∏ Telegram —á–∞—Å –æ–±—Ä–æ–±–∏—Ç–∏ sendData()
                    // –ë–µ–∑ –∑–∞—Ç—Ä–∏–º–∫–∏ tg.close() –º–æ–∂–µ –∑–∞–∫—Ä–∏—Ç–∏ WebApp –î–û –≤—ñ–¥–ø—Ä–∞–≤–∫–∏ –¥–∞–Ω–∏—Ö!
                    // console.log('‚è∞ Waiting 300ms before closing...');
                    // addDebugLog('‚è∞ –ß–µ–∫–∞—î–º–æ 300ms –ø–µ—Ä–µ–¥ –∑–∞–∫—Ä–∏—Ç—Ç—è–º...', 'info');
                    
                    // setTimeout(() => {
                    //     console.log('üö™ CALLING tg.close() after delay');
                    //     console.log('‚è∞ Time before close:', new Date().toISOString());
                    //     addDebugLog('üö™ –í–∏–∫–ª–∏–∫–∞—î–º–æ tg.close() –ø—ñ—Å–ª—è –∑–∞—Ç—Ä–∏–º–∫–∏...', 'warning');
                    //     
                    //     tg.close();
                    //     
                    //     console.log('‚úÖ tg.close() called!');
                    //     console.log('‚è∞ Time after close:', new Date().toISOString());
                    //     console.log('='.repeat(60));
                    //     addDebugLog('‚úÖ tg.close() –≤–∏–∫–ª–∏–∫–∞–Ω–æ! –ö–∞—Ä—Ç–∞ –º–∞—î –∑–∞–∫—Ä–∏—Ç–∏—Å—å...', 'success');
                    // }, 300); // 300ms –∑–∞—Ç—Ä–∏–º–∫–∞

                } catch (error) {
                    console.error('='.repeat(60));
                    console.error('‚ùå ERROR in try block:', new Date().toISOString());
                    console.error('='.repeat(60));
                    console.error('Error type:', error.constructor.name);
                    console.error('Error message:', error.message);
                    console.error('Error stack:', error.stack);
                    console.error('='.repeat(60));
                    
                    addDebugLog(`‚ùå –ü–û–ú–ò–õ–ö–ê: ${error.message}`, 'error');
                }
            } else {
                console.warn('='.repeat(60));
                console.warn('‚ö†Ô∏è NO COORDINATES SELECTED!');
                console.warn('='.repeat(60));
                console.warn('selectedCoords is:', selectedCoords);
                
                addDebugLog('‚ö†Ô∏è –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏ –Ω–µ –æ–±—Ä–∞–Ω–æ!', 'warning');
            }
        });
        console.log('‚úÖ MainButton.onClick handler registered');
        
        // –ö–Ω–æ–ø–∫–∞ "–ú–æ—è –≥–µ–æ–ª–æ–∫–∞—Ü—ñ—è"
        document.getElementById('locate-btn').addEventListener('click', () => {
            const loading = document.getElementById('loading');
            loading.style.display = 'block';
            
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const { latitude, longitude } = position.coords;
                        
                        // –ü–µ—Ä–µ–º—ñ—Å—Ç–∏—Ç–∏ –∫–∞—Ä—Ç—É –¥–æ –ø–æ—Ç–æ—á–Ω–æ—ó –ª–æ–∫–∞—Ü—ñ—ó
                        map.setView([latitude, longitude], 15);
                        
                        // –î–æ–¥–∞—Ç–∏ –º–∞—Ä–∫–µ—Ä
                        if (selectedMarker) {
                            map.removeLayer(selectedMarker);
                        }
                        
                        selectedMarker = L.marker([latitude, longitude], {
                            icon: createMarkerIcon()
                        }).addTo(map);
                        
                        selectedCoords = { lat: latitude, lng: longitude };
                        
                        // –ü–æ–∫–∞–∑–∞—Ç–∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏
                        document.getElementById('coords-text').textContent = 
                            `${latitude.toFixed(6)}, ${longitude.toFixed(6)}`;
                        document.getElementById('coordinates').style.display = 'block';
                        
                        // –ü–æ–∫–∞–∑–∞—Ç–∏ –∫–Ω–æ–ø–∫—É
                        tg.MainButton.show();
                        
                        loading.style.display = 'none';
                        
                        if (tg.HapticFeedback) {
                            tg.HapticFeedback.notificationOccurred('success');
                        }
                    },
                    (error) => {
                        loading.style.display = 'none';
                        alert('‚ùå –ù–µ –≤–¥–∞–ª–æ—Å—è –æ—Ç—Ä–∏–º–∞—Ç–∏ –≥–µ–æ–ª–æ–∫–∞—Ü—ñ—é. –û–±–µ—Ä—ñ—Ç—å –º—ñ—Å—Ü–µ –Ω–∞ –∫–∞—Ä—Ç—ñ –≤—Ä—É—á–Ω—É.');
                        
                        if (tg.HapticFeedback) {
                            tg.HapticFeedback.notificationOccurred('error');
                        }
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 0
                    }
                );
            } else {
                loading.style.display = 'none';
                alert('‚ùå –í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø—ñ–¥—Ç—Ä–∏–º—É—î –≥–µ–æ–ª–æ–∫–∞—Ü—ñ—é');
            }
        });
        
        // –û–±—Ä–æ–±–∫–∞ –∑–∞–∫—Ä–∏—Ç—Ç—è WebApp
        tg.onEvent('backButtonClicked', () => {
            tg.close();
        });
        
        // –ü–æ–∫–∞–∑–∞—Ç–∏ –∫–Ω–æ–ø–∫—É "–ù–∞–∑–∞–¥" –≤ Telegram
        tg.BackButton.show();
    </script>
</body>
</html>
