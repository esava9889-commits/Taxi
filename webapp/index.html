<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–û–±–µ—Ä—ñ—Ç—å –º—ñ—Å—Ü–µ –Ω–∞ –∫–∞—Ä—Ç—ñ</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <!-- Leaflet Control Geocoder CSS (–¥–ª—è –ø–æ—à—É–∫—É –∞–¥—Ä–µ—Å) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder@2.4.0/dist/Control.Geocoder.css" />
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            overflow: hidden;
            background: var(--tg-theme-bg-color, #ffffff);
        }
        
        #map {
            width: 100vw;
            height: 100vh;
            position: absolute;
            top: 0;
            left: 0;
        }
        
        .info-panel {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--tg-theme-bg-color, #ffffff);
            padding: 12px 20px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 1000;
            max-width: 90%;
            text-align: center;
            color: var(--tg-theme-text-color, #000000);
        }
        
        .info-panel h3 {
            font-size: 16px;
            margin-bottom: 5px;
            font-weight: 600;
        }
        
        .info-panel p {
            font-size: 13px;
            color: var(--tg-theme-hint-color, #999999);
        }
        
        .coordinates {
            position: absolute;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--tg-theme-bg-color, #ffffff);
            padding: 10px 16px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            z-index: 1000;
            font-size: 12px;
            color: var(--tg-theme-text-color, #000000);
            display: none;
        }
        
        .marker-icon {
            background: transparent;
            border: none;
        }
        
        .pulse {
            width: 30px;
            height: 30px;
            border: 5px solid var(--tg-theme-button-color, #3390ec);
            border-radius: 50%;
            background: var(--tg-theme-button-color, #3390ec);
            opacity: 0.8;
            position: relative;
        }
        
        .pulse::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 40px;
            height: 40px;
            border: 2px solid var(--tg-theme-button-color, #3390ec);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            animation: pulse 1.5s ease-out infinite;
            opacity: 0;
        }
        
        @keyframes pulse {
            0% {
                transform: translate(-50%, -50%) scale(0.5);
                opacity: 1;
            }
            100% {
                transform: translate(-50%, -50%) scale(1.5);
                opacity: 0;
            }
        }
        
        .locate-button {
            position: absolute;
            bottom: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            background: var(--tg-theme-button-color, #3390ec);
            border: none;
            border-radius: 50%;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            cursor: pointer;
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--tg-theme-button-text-color, #ffffff);
            font-size: 24px;
        }
        
        .locate-button:active {
            transform: scale(0.95);
        }
        
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 2000;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 20px 30px;
            border-radius: 10px;
            display: none;
        }
        
        /* DEBUG –ø–∞–Ω–µ–ª—å –≤–∏–¥–∞–ª–µ–Ω–æ –¥–ª—è —á–∏—Å—Ç–æ—Ç–∏ —ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å—É */
    </style>
</head>
<body>
    <div id="map"></div>
    
    <div class="coordinates" id="coordinates">
        <strong>üìç –û–±—Ä–∞–Ω–æ:</strong> <span id="coords-text"></span>
    </div>
    
    <button class="locate-button" id="locate-btn" title="–ú–æ—è –≥–µ–æ–ª–æ–∫–∞—Ü—ñ—è">
        üìç
    </button>
    
    <div class="loading" id="loading">
        <p>‚è≥ –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</p>
    </div>
    
    <!-- Telegram WebApp SDK -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- Leaflet Control Geocoder JS (–¥–ª—è –ø–æ—à—É–∫—É –∞–¥—Ä–µ—Å) -->
    <script src="https://unpkg.com/leaflet-control-geocoder@2.4.0/dist/Control.Geocoder.js"></script>
    
    <script>
        // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è Telegram WebApp
        const tg = window.Telegram.WebApp;
        tg.expand();
        
        // –ù–û–í–ê –õ–û–ì–Ü–ö–ê: 3 —Å—Ç–∞–Ω–∏
        // 1. pickup - –æ–±–∏—Ä–∞—î–º–æ –º—ñ—Å—Ü–µ –ø–æ—Å–∞–¥–∫–∏
        // 2. destination - –æ–±–∏—Ä–∞—î–º–æ –º—ñ—Å—Ü–µ –ø—Ä–∏–∑–Ω–∞—á–µ–Ω–Ω—è (–ø–æ–∫–∞–∑—É—î—Ç—å—Å—è –º–∞—Ä—à—Ä—É—Ç)
        // 3. confirm - –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂—É—î–º–æ –æ–±–∏–¥–≤—ñ —Ç–æ—á–∫–∏ (–≤—ñ–¥–ø—Ä–∞–≤–ª—è—î–º–æ –≤ –±–æ—Ç)
        
        let currentState = 'pickup';  // pickup ‚Üí destination ‚Üí confirm
        let pickupCoords = null;
        let destinationCoords = null;
        
        tg.MainButton.setText('‚úÖ –ü—ñ–¥—Ç–≤–µ—Ä–¥–∏—Ç–∏ –º—ñ—Å—Ü–µ –ø–æ—Å–∞–¥–∫–∏');
        tg.MainButton.color = tg.themeParams.button_color || '#3390ec';
        tg.MainButton.textColor = tg.themeParams.button_text_color || '#ffffff';
        tg.MainButton.hide(); // –°–ø–æ—á–∞—Ç–∫—É —Å—Ö–æ–≤–∞—Ç–∏
        
        // –ó–∞—Å—Ç–æ—Å—É–≤–∞—Ç–∏ —Ç–µ–º—É Telegram
        document.body.style.backgroundColor = tg.themeParams.bg_color || '#ffffff';
        
        // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è –∫–∞—Ä—Ç–∏ (—Ü–µ–Ω—Ç—Ä –£–∫—Ä–∞—ó–Ω–∏)
        const map = L.map('map', {
            zoomControl: false, // –ü—Ä–∏–±—Ä–∞—Ç–∏ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∏–π zoom control
        }).setView([48.3794, 31.1656], 6); // –£–∫—Ä–∞—ó–Ω–∞
        
        // ‚òÄÔ∏è –°–í–Ü–¢–õ–ê –ö–ê–†–¢–ê (—è–∫ Google Maps)
        // CartoDB Positron - —Å–≤—ñ—Ç–ª–∞, —á–∏—Å—Ç–∞ –∫–∞—Ä—Ç–∞ —Å—Ö–æ–∂–∞ –Ω–∞ Google Maps
        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
            attribution: '¬© CARTO ¬© OpenStreetMap',
            maxZoom: 19,
            subdomains: 'abcd'
        }).addTo(map);
        
        // –î–æ–¥–∞—Ç–∏ zoom control –≤ —ñ–Ω—à–µ –º—ñ—Å—Ü–µ
        L.control.zoom({
            position: 'bottomleft'
        }).addTo(map);
        
        // –ó–º—ñ–Ω–Ω—ñ –¥–ª—è –∑–±–µ—Ä—ñ–≥–∞–Ω–Ω—è –º–∞—Ä–∫–µ—Ä—ñ–≤ —Ç–∞ –º–∞—Ä—à—Ä—É—Ç—É
        let pickupMarker = null;       // –ó–µ–ª–µ–Ω–∏–π –º–∞—Ä–∫–µ—Ä pickup
        let destinationMarker = null;  // –°–∏–Ω—ñ–π –º–∞—Ä–∫–µ—Ä destination
        let routePolyline = null;      // –õ—ñ–Ω—ñ—è –º–∞—Ä—à—Ä—É—Ç—É
        
        // –§—É–Ω–∫—Ü—ñ—è —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –∫–∞—Å—Ç–æ–º–Ω–æ–≥–æ –º–∞—Ä–∫–µ—Ä–∞
        const createMarkerIcon = (isPickup = false) => {
            const color = isPickup ? '#4CAF50' : '#2196F3';  // –ó–µ–ª–µ–Ω–∏–π –¥–ª—è pickup, —Å–∏–Ω—ñ–π –¥–ª—è destination
            return L.divIcon({
                className: 'marker-icon',
                html: `<div class="pulse" style="background: ${color}; border-color: ${color};"></div>`,
                iconSize: [30, 30],
                iconAnchor: [15, 15]
            });
        };
        
        // –§—É–Ω–∫—Ü—ñ—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ç–∞ –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è –º–∞—Ä—à—Ä—É—Ç—É
        async function loadAndShowRoute(fromLat, fromLon, toLat, toLon) {
            try {
                // –í–∏–¥–∞–ª–∏—Ç–∏ –ø–æ–ø–µ—Ä–µ–¥–Ω—ñ–π –º–∞—Ä—à—Ä—É—Ç
                if (routePolyline) {
                    map.removeLayer(routePolyline);
                }
                
                // –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –º–∞—Ä—à—Ä—É—Ç –∑ OSRM
                const url = `http://router.project-osrm.org/route/v1/driving/${fromLon},${fromLat};${toLon},${toLat}?overview=full&geometries=geojson`;
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.code === 'Ok' && data.routes && data.routes.length > 0) {
                    const route = data.routes[0];
                    const coords = route.geometry.coordinates.map(c => [c[1], c[0]]); // [lng, lat] ‚Üí [lat, lng]
                    
                    // –í—ñ–¥–æ–±—Ä–∞–∑–∏—Ç–∏ –º–∞—Ä—à—Ä—É—Ç
                    routePolyline = L.polyline(coords, {
                        color: '#2196F3',
                        weight: 4,
                        opacity: 0.7
                    }).addTo(map);
                    
                    // –¶–µ–Ω—Ç—Ä—É–≤–∞—Ç–∏ –∫–∞—Ä—Ç—É –Ω–∞ –º–∞—Ä—à—Ä—É—Ç
                    map.fitBounds(routePolyline.getBounds(), { padding: [50, 50] });
                    
                    console.log('‚úÖ –ú–∞—Ä—à—Ä—É—Ç –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ:', (route.distance / 1000).toFixed(1), '–∫–º');
                }
            } catch (error) {
                console.error('‚ùå –ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –º–∞—Ä—à—Ä—É—Ç—É:', error);
            }
        }
        
        // üîç –ü–û–®–£–ö –ê–î–†–ï–° (Geocoder) –∑ –ø–æ–∫—Ä–∞—â–µ–Ω–∏–º–∏ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è–º–∏
        const geocoder = L.Control.Geocoder.nominatim({
            serviceUrl: 'http://nominatim.openstreetmap.org',  // HTTP –∑–∞–º—ñ—Å—Ç—å HTTPS
            geocodingQueryParams: {
                countrycodes: 'ua',  // –¢—ñ–ª—å–∫–∏ –£–∫—Ä–∞—ó–Ω–∞
                'accept-language': 'uk',  // –£–∫—Ä–∞—ó–Ω—Å—å–∫–∞ –º–æ–≤–∞
                addressdetails: 1,  // –î–µ—Ç–∞–ª—å–Ω–∞ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è –ø—Ä–æ –∞–¥—Ä–µ—Å—É
                limit: 10  // –ü–æ–∫–∞–∑—É–≤–∞—Ç–∏ –¥–æ 10 –≤–∞—Ä—ñ–∞–Ω—Ç—ñ–≤
            }
        });
        
        const geocoderControl = L.Control.geocoder({
            geocoder: geocoder,
            defaultMarkGeocode: false,  // –ú–∏ —Å–∞–º—ñ –∫–æ–Ω—Ç—Ä–æ–ª—é—î–º–æ –º–∞—Ä–∫–µ—Ä
            position: 'topright',
            placeholder: 'üîç –í–≤–µ–¥—ñ—Ç—å –∞–¥—Ä–µ—Å—É –∞–±–æ –º—ñ—Å—Ü–µ...',
            errorMessage: '‚ùå –ê–¥—Ä–µ—Å—É –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ',
            collapsed: false,  // –ó–∞–≤–∂–¥–∏ –ø–æ–∫–∞–∑—É–≤–∞—Ç–∏ –ø–æ–ª–µ –ø–æ—à—É–∫—É
            suggestMinLength: 3,  // –ü–æ—á–∏–Ω–∞—Ç–∏ –ø–æ—à—É–∫ –∑ 3 —Å–∏–º–≤–æ–ª—ñ–≤
            suggestTimeout: 250  // –ó–∞—Ç—Ä–∏–º–∫–∞ –ø–µ—Ä–µ–¥ –ø–æ—à—É–∫–æ–º (–º—Å)
        }).on('markgeocode', function(e) {
            const latlng = e.geocode.center;
            
            if (currentState === 'pickup') {
                // –í–∏–¥–∞–ª–∏—Ç–∏ —Å—Ç–∞—Ä–∏–π –º–∞—Ä–∫–µ—Ä pickup
                if (pickupMarker) {
                    map.removeLayer(pickupMarker);
                }
                
                // –î–æ–¥–∞—Ç–∏ –º–∞—Ä–∫–µ—Ä pickup (–∑–µ–ª–µ–Ω–∏–π)
                pickupMarker = L.marker(latlng, {
                    icon: createMarkerIcon(true)
                }).addTo(map);
                
                // –ó–±–µ—Ä–µ–≥—Ç–∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏
                pickupCoords = { lat: latlng.lat, lng: latlng.lng };
                
                // –ü–æ–∫–∞–∑–∞—Ç–∏ –∫–Ω–æ–ø–∫—É
                tg.MainButton.show();
                
            } else if (currentState === 'destination') {
                // –í–∏–¥–∞–ª–∏—Ç–∏ —Å—Ç–∞—Ä–∏–π –º–∞—Ä–∫–µ—Ä destination
                if (destinationMarker) {
                    map.removeLayer(destinationMarker);
                }
                
                // –î–æ–¥–∞—Ç–∏ –º–∞—Ä–∫–µ—Ä destination (—Å–∏–Ω—ñ–π)
                destinationMarker = L.marker(latlng, {
                    icon: createMarkerIcon(false)
                }).addTo(map);
                
                // –ó–±–µ—Ä–µ–≥—Ç–∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏
                destinationCoords = { lat: latlng.lat, lng: latlng.lng };
                
                // –ú–ê–õ–Æ–í–ê–¢–ò –º–∞—Ä—à—Ä—É—Ç –≤—ñ–¥—Ä–∞–∑—É –ø—ñ—Å–ª—è –≤–∏–±–æ—Ä—É destination!
                if (pickupCoords && destinationCoords) {
                    console.log('üó∫Ô∏è –ú–∞–ª—é—é –º–∞—Ä—à—Ä—É—Ç –ø—ñ—Å–ª—è geocoder...');
                    loadAndShowRoute(
                        pickupCoords.lat, pickupCoords.lng,
                        destinationCoords.lat, destinationCoords.lng
                    );
                }
                
                // –ü–æ–∫–∞–∑–∞—Ç–∏ –∫–Ω–æ–ø–∫—É
                tg.MainButton.show();
            }
            
            // –¶–µ–Ω—Ç—Ä—É–≤–∞—Ç–∏ –∫–∞—Ä—Ç—É
            map.setView(latlng, 16);
            
            // –í—ñ–±—Ä–∞—Ü—ñ—è
            if (tg.HapticFeedback) {
                tg.HapticFeedback.impactOccurred('medium');
            }
        }).addTo(map);
        
        // –û–±—Ä–æ–±–Ω–∏–∫ –∫–ª—ñ–∫—É –ø–æ –∫–∞—Ä—Ç—ñ
        map.on('click', (e) => {
            const { lat, lng } = e.latlng;
            
            if (currentState === 'pickup') {
                // –í–∏–¥–∞–ª–∏—Ç–∏ —Å—Ç–∞—Ä–∏–π –º–∞—Ä–∫–µ—Ä pickup —è–∫—â–æ —î
                if (pickupMarker) {
                    map.removeLayer(pickupMarker);
                }
                
                // –î–æ–¥–∞—Ç–∏ –º–∞—Ä–∫–µ—Ä pickup (–∑–µ–ª–µ–Ω–∏–π)
                pickupMarker = L.marker([lat, lng], {
                    icon: createMarkerIcon(true)
                }).addTo(map);
                
                // –ó–±–µ—Ä–µ–≥—Ç–∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏ pickup
                pickupCoords = { lat, lng };
                
                // –ü–æ–∫–∞–∑–∞—Ç–∏ –∫–Ω–æ–ø–∫—É
                tg.MainButton.show();
                
            } else if (currentState === 'destination') {
                // –í–∏–¥–∞–ª–∏—Ç–∏ —Å—Ç–∞—Ä–∏–π –º–∞—Ä–∫–µ—Ä destination —è–∫—â–æ —î
                if (destinationMarker) {
                    map.removeLayer(destinationMarker);
                }
                
                // –î–æ–¥–∞—Ç–∏ –º–∞—Ä–∫–µ—Ä destination (—Å–∏–Ω—ñ–π)
                destinationMarker = L.marker([lat, lng], {
                    icon: createMarkerIcon(false)
                }).addTo(map);
                
                // –ó–±–µ—Ä–µ–≥—Ç–∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏ destination
                destinationCoords = { lat, lng };
                
                // –ú–ê–õ–Æ–í–ê–¢–ò –º–∞—Ä—à—Ä—É—Ç –≤—ñ–¥—Ä–∞–∑—É –ø—ñ—Å–ª—è –≤–∏–±–æ—Ä—É destination!
                if (pickupCoords && destinationCoords) {
                    console.log('üó∫Ô∏è –ú–∞–ª—é—é –º–∞—Ä—à—Ä—É—Ç –ø—ñ—Å–ª—è –∫–ª—ñ–∫—É –Ω–∞ –∫–∞—Ä—Ç—É...');
                    loadAndShowRoute(
                        pickupCoords.lat, pickupCoords.lng,
                        destinationCoords.lat, destinationCoords.lng
                    );
                }
                
                // –ü–æ–∫–∞–∑–∞—Ç–∏ –∫–Ω–æ–ø–∫—É
                tg.MainButton.show();
            }
            
            // –í—ñ–±—Ä–∞—Ü—ñ—è
            if (tg.HapticFeedback) {
                tg.HapticFeedback.impactOccurred('light');
            }
        });
        
        // –û–±—Ä–æ–±–Ω–∏–∫ –∫–Ω–æ–ø–∫–∏ (3 —Å—Ç–∞–Ω–∏)
        tg.MainButton.offClick();
        tg.MainButton.onClick(async () => {
            if (currentState === 'pickup') {
                // –°–¢–ê–ù 1: –ü—ñ–¥—Ç–≤–µ—Ä–¥–∂—É—î–º–æ pickup ‚Üí –ø–µ—Ä–µ—Ö–æ–¥–∏–º–æ –¥–æ destination
                if (!pickupCoords) return;
                
                currentState = 'destination';
                tg.MainButton.setText('‚úÖ –ü—ñ–¥—Ç–≤–µ—Ä–¥–∏—Ç–∏ –º—ñ—Å—Ü–µ –ø—Ä–∏–∑–Ω–∞—á–µ–Ω–Ω—è');
                tg.MainButton.hide();  // –°—Ö–æ–≤–∞—Ç–∏ –ø–æ–∫–∏ –Ω–µ –æ–±–µ—Ä–µ destination
                
                console.log('‚úÖ Pickup –∑–±–µ—Ä–µ–∂–µ–Ω–æ, –æ—á—ñ–∫—É—é destination');
                
                if (tg.HapticFeedback) {
                    tg.HapticFeedback.impactOccurred('medium');
                }
                
            } else if (currentState === 'destination') {
                // –°–¢–ê–ù 2: –ü—ñ–¥—Ç–≤–µ—Ä–¥–∂—É—î–º–æ destination (–º–∞—Ä—à—Ä—É—Ç –≤–∂–µ –Ω–∞–º–∞–ª—å–æ–≤–∞–Ω–æ!)
                if (!destinationCoords) return;
                
                // –ú–∞—Ä—à—Ä—É—Ç –≤–∂–µ –Ω–∞–º–∞–ª—å–æ–≤–∞–Ω–æ –ø—Ä–∏ –≤–∏–±–æ—Ä—ñ —Ç–æ—á–∫–∏, –ø—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ—Ö–æ–¥–∏–º–æ –¥–æ confirm
                currentState = 'confirm';
                tg.MainButton.setText('‚úÖ –ü—ñ–¥—Ç–≤–µ—Ä–¥–∏—Ç–∏ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è');
                
                console.log('‚úÖ Destination –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–æ, –ø–µ—Ä–µ—Ö–æ–¥–∂—É –¥–æ confirm');
                console.log('üìç Pickup:', pickupCoords);
                console.log('üìç Destination:', destinationCoords);
                
                if (tg.HapticFeedback) {
                    tg.HapticFeedback.impactOccurred('medium');
                }
                
            } else if (currentState === 'confirm') {
                // –°–¢–ê–ù 3: –í—ñ–¥–ø—Ä–∞–≤–ª—è—î–º–æ –æ–±–∏–¥–≤—ñ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏ –≤ API
                try {
                    const userId = tg.initDataUnsafe?.user?.id;
                    
                    if (!userId) {
                        console.error('‚ùå User ID –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ!');
                        return;
                    }
                    
                    // –í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ –û–ë–ò–î–í–Ü –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏ –æ–¥—Ä–∞–∑—É
                    const apiData = {
                        user_id: userId,
                        pickup_lat: pickupCoords.lat,
                        pickup_lon: pickupCoords.lng,
                        dest_lat: destinationCoords.lat,
                        dest_lon: destinationCoords.lng
                    };
                    
                    console.log('üì§ –í—ñ–¥–ø—Ä–∞–≤–ª—è—é –æ–±–∏–¥–≤—ñ —Ç–æ—á–∫–∏:', apiData);
                    
                    const response = await fetch('/api/webapp/order', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(apiData)
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        console.log('‚úÖ –î–∞–Ω—ñ –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ —É—Å–ø—ñ—à–Ω–æ');
                        
                        // –í—ñ–±—Ä–∞—Ü—ñ—è —É—Å–ø—ñ—Ö—É
                        if (tg.HapticFeedback) {
                            tg.HapticFeedback.notificationOccurred('success');
                        }
                        
                        // –ó–∞–∫—Ä–∏—Ç–∏ WebApp
                        setTimeout(() => {
                            tg.close();
                        }, 500);
                    } else {
                        console.error('‚ùå –ü–æ–º–∏–ª–∫–∞ API:', result.error);
                    }
                    
                } catch (error) {
                    console.error('‚ùå –ü–æ–º–∏–ª–∫–∞ –≤—ñ–¥–ø—Ä–∞–≤–∫–∏:', error);
                }
            }
        });
        
        // –ö–Ω–æ–ø–∫–∞ "–ú–æ—è –≥–µ–æ–ª–æ–∫–∞—Ü—ñ—è"
        document.getElementById('locate-btn').addEventListener('click', () => {
            const loading = document.getElementById('loading');
            loading.style.display = 'block';
            
            if (navigator.geolocation) {
                // –¢–∞–π–º–∞—É—Ç –¥–ª—è –≥–∞—Ä–∞–Ω—Ç–æ–≤–∞–Ω–æ–≥–æ –ø—Ä–∏—Ö–æ–≤—É–≤–∞–Ω–Ω—è loading
                const timeoutId = setTimeout(() => {
                    loading.style.display = 'none';
                    console.error('‚è±Ô∏è –ì–µ–æ–ª–æ–∫–∞—Ü—ñ—è: timeout');
                    if (tg.HapticFeedback) {
                        tg.HapticFeedback.notificationOccurred('error');
                    }
                }, 15000); // 15 —Å–µ–∫—É–Ω–¥ –º–∞–∫—Å–∏–º—É–º
                
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        clearTimeout(timeoutId);
                        const { latitude, longitude } = position.coords;
                        
                        loading.style.display = 'none';
                        
                        console.log('‚úÖ –ì–µ–æ–ª–æ–∫–∞—Ü—ñ—è –æ—Ç—Ä–∏–º–∞–Ω–∞:', latitude, longitude);
                        
                        // –ü–µ—Ä–µ–º—ñ—Å—Ç–∏—Ç–∏ –∫–∞—Ä—Ç—É –¥–æ –ø–æ—Ç–æ—á–Ω–æ—ó –ª–æ–∫–∞—Ü—ñ—ó
                        map.setView([latitude, longitude], 15);
                        
                        // –î–æ–¥–∞—Ç–∏ –º–∞—Ä–∫–µ—Ä –∑–∞–ª–µ–∂–Ω–æ –≤—ñ–¥ —Å—Ç–∞–Ω—É
                        if (currentState === 'pickup') {
                            if (pickupMarker) {
                                map.removeLayer(pickupMarker);
                            }
                            pickupMarker = L.marker([latitude, longitude], {
                                icon: createMarkerIcon(true)
                            }).addTo(map);
                            pickupCoords = { lat: latitude, lng: longitude };
                            
                        } else if (currentState === 'destination') {
                            if (destinationMarker) {
                                map.removeLayer(destinationMarker);
                            }
                            destinationMarker = L.marker([latitude, longitude], {
                                icon: createMarkerIcon(false)
                            }).addTo(map);
                            destinationCoords = { lat: latitude, lng: longitude };
                            
                            // –ú–ê–õ–Æ–í–ê–¢–ò –º–∞—Ä—à—Ä—É—Ç –≤—ñ–¥—Ä–∞–∑—É –ø—ñ—Å–ª—è –≤–∏–±–æ—Ä—É destination!
                            if (pickupCoords && destinationCoords) {
                                console.log('üó∫Ô∏è –ú–∞–ª—é—é –º–∞—Ä—à—Ä—É—Ç –ø—ñ—Å–ª—è –≥–µ–æ–ª–æ–∫–∞—Ü—ñ—ó...');
                                loadAndShowRoute(
                                    pickupCoords.lat, pickupCoords.lng,
                                    destinationCoords.lat, destinationCoords.lng
                                );
                            }
                        }
                        
                        // –ü–æ–∫–∞–∑–∞—Ç–∏ –∫–Ω–æ–ø–∫—É
                        tg.MainButton.show();
                        
                        if (tg.HapticFeedback) {
                            tg.HapticFeedback.notificationOccurred('success');
                        }
                    },
                    (error) => {
                        clearTimeout(timeoutId);
                        loading.style.display = 'none';
                        console.error('‚ùå –ì–µ–æ–ª–æ–∫–∞—Ü—ñ—è –ø–æ–º–∏–ª–∫–∞:', error);
                        console.error('  - code:', error.code);
                        console.error('  - message:', error.message);
                        
                        // –ü–æ–∫–∞–∑–∞—Ç–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –ø—Ä–æ –ø–æ–º–∏–ª–∫—É
                        alert('‚ùå –ù–µ –≤–¥–∞–ª–æ—Å—è –æ—Ç—Ä–∏–º–∞—Ç–∏ –≥–µ–æ–ª–æ–∫–∞—Ü—ñ—é.\n–î–æ–∑–≤–æ–ª—å—Ç–µ –¥–æ—Å—Ç—É–ø –¥–æ –≥–µ–æ–ª–æ–∫–∞—Ü—ñ—ó –≤ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è—Ö –±—Ä–∞—É–∑–µ—Ä–∞.');
                        
                        if (tg.HapticFeedback) {
                            tg.HapticFeedback.notificationOccurred('error');
                        }
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 12000,  // 12 —Å–µ–∫—É–Ω–¥
                        maximumAge: 0
                    }
                );
            } else {
                loading.style.display = 'none';
                console.error('‚ùå –ì–µ–æ–ª–æ–∫–∞—Ü—ñ—è –Ω–µ –ø—ñ–¥—Ç—Ä–∏–º—É—î—Ç—å—Å—è');
                alert('‚ùå –í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø—ñ–¥—Ç—Ä–∏–º—É—î –≥–µ–æ–ª–æ–∫–∞—Ü—ñ—é.');
            }
        });
        
        // –û–±—Ä–æ–±–∫–∞ –∑–∞–∫—Ä–∏—Ç—Ç—è WebApp
        tg.onEvent('backButtonClicked', () => {
            tg.close();
        });
        
        // –ü–æ–∫–∞–∑–∞—Ç–∏ –∫–Ω–æ–ø–∫—É "–ù–∞–∑–∞–¥" –≤ Telegram
        tg.BackButton.show();
    </script>
</body>
</html>
