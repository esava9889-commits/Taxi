<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–û–±–µ—Ä—ñ—Ç—å –º—ñ—Å—Ü–µ –Ω–∞ –∫–∞—Ä—Ç—ñ</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <!-- Leaflet Control Geocoder CSS (–¥–ª—è –ø–æ—à—É–∫—É –∞–¥—Ä–µ—Å) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder@2.4.0/dist/Control.Geocoder.css" />
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            overflow: hidden;
            background: #ffffff;
        }
        
        #map {
            width: 100vw;
            height: 100vh;
            position: absolute;
            top: 0;
            left: 0;
        }
        
        .info-panel {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--tg-theme-bg-color, #ffffff);
            padding: 12px 20px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 1000;
            max-width: 90%;
            text-align: center;
            color: var(--tg-theme-text-color, #000000);
        }
        
        .info-panel h3 {
            font-size: 16px;
            margin-bottom: 5px;
            font-weight: 600;
        }
        
        .info-panel p {
            font-size: 13px;
            color: var(--tg-theme-hint-color, #999999);
        }
        
        .coordinates {
            position: absolute;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--tg-theme-bg-color, #ffffff);
            padding: 10px 16px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            z-index: 1000;
            font-size: 12px;
            color: var(--tg-theme-text-color, #000000);
            display: none;
        }
        
        .marker-icon {
            background: transparent;
            border: none;
        }
        
        .pulse {
            width: 35px;
            height: 35px;
            border: 6px solid #FFD700;
            border-radius: 50%;
            background: linear-gradient(135deg, #FFD700, #FFA500);
            opacity: 0.95;
            position: relative;
            box-shadow: 0 4px 20px rgba(255, 215, 0, 0.7), 0 0 40px rgba(255, 215, 0, 0.4);
            animation: markerBounce 0.6s ease-out, glowPulse 2s ease-in-out infinite;
        }
        
        .pulse::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 10px;
            height: 10px;
            background: white;
            border-radius: 50%;
            transform: translate(-50%, -50%);
        }
        
        .pulse::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 45px;
            height: 45px;
            border: 3px solid #FFD700;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            animation: pulse 2s ease-out infinite;
            opacity: 0;
        }
        
        @keyframes pulse {
            0% {
                transform: translate(-50%, -50%) scale(0.5);
                opacity: 1;
            }
            100% {
                transform: translate(-50%, -50%) scale(1.8);
                opacity: 0;
            }
        }
        
        /* üéØ Bounce –∞–Ω—ñ–º–∞—Ü—ñ—è –¥–ª—è –º–∞—Ä–∫–µ—Ä—ñ–≤ */
        @keyframes markerBounce {
            0% {
                transform: translateY(-200px) scale(0);
                opacity: 0;
            }
            50% {
                transform: translateY(-10px) scale(1.1);
            }
            70% {
                transform: translateY(5px) scale(0.95);
            }
            100% {
                transform: translateY(0) scale(1);
                opacity: 1;
            }
        }
        
        /* üåü Glow –µ—Ñ–µ–∫—Ç - –ó–û–õ–û–¢–ò–ô */
        @keyframes glowPulse {
            0%, 100% {
                box-shadow: 0 4px 20px rgba(255, 215, 0, 0.7), 0 0 40px rgba(255, 215, 0, 0.4);
            }
            50% {
                box-shadow: 0 4px 30px rgba(255, 215, 0, 0.9), 0 0 60px rgba(255, 215, 0, 0.6);
            }
        }
        
        /* üåä –ê–Ω—ñ–º–∞—Ü—ñ—è –º–∞–ª—é–≤–∞–Ω–Ω—è –º–∞—Ä—à—Ä—É—Ç—É */
        @keyframes drawRoute {
            from {
                stroke-dashoffset: 2000;
            }
            to {
                stroke-dashoffset: 0;
            }
        }
        
        /* –ü–ª–∞–≤–Ω–∞ –ø–æ—è–≤–∞ –µ–ª–µ–º–µ–Ω—Ç—ñ–≤ */
        .route-info {
            animation: slideDown 0.3s ease-out;
        }
        
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .locate-button {
            position: absolute;
            bottom: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #FFD700, #FFA500);
            border: 2px solid rgba(255, 215, 0, 0.5);
            border-radius: 50%;
            box-shadow: 0 4px 20px rgba(255, 215, 0, 0.5), 0 0 25px rgba(255, 215, 0, 0.3);
            cursor: pointer;
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #1a1a1a;
            font-size: 24px;
            transition: all 0.3s ease;
        }
        
        .locate-button:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 30px rgba(255, 215, 0, 0.7), 0 0 40px rgba(255, 215, 0, 0.5);
        }
        
        .locate-button:active {
            transform: scale(0.95);
        }
        
        /* üöó –ö–ê–°–¢–û–ú–ù–ò–ô LOADER "URBAN" - –¢–ï–ú–ù–ò–ô –ó –ñ–û–í–¢–ò–ú */
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 2000;
            background: linear-gradient(135deg, rgba(26, 26, 26, 0.98), rgba(45, 45, 45, 0.98));
            color: #FFD700;
            padding: 30px 40px;
            border-radius: 20px;
            display: none;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.6), 0 0 50px rgba(255, 215, 0, 0.4);
            text-align: center;
            border: 2px solid #FFD700;
            backdrop-filter: blur(10px);
        }
        
        /* Typing text –¥–ª—è "Urban" - –ñ–û–í–¢–ò–ô */
        .loading-text {
            font-size: 32px;
            font-weight: bold;
            color: #FFD700;
            font-family: 'Segoe UI', Roboto, sans-serif;
            letter-spacing: 2px;
            margin-bottom: 20px;
            overflow: hidden;
            border-right: 3px solid #FFD700;
            white-space: nowrap;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
            animation: typing 1.5s steps(5) forwards, blinkCursor 0.75s step-end infinite;
        }
        
        @keyframes typing {
            from { width: 0; }
            to { width: 100%; }
        }
        
        @keyframes blinkCursor {
            from, to { border-color: transparent; }
            50% { border-color: #FFD700; }
        }
        
        /* üöó –ö–æ–ª–µ—Å–æ —â–æ –∫—Ä—É—Ç–∏—Ç—å—Å—è - –ñ–û–í–¢–ï */
        .loading-wheel {
            width: 60px;
            height: 60px;
            margin: 0 auto;
            position: relative;
        }
        
        .wheel {
            width: 60px;
            height: 60px;
            border: 6px solid #3a3a3a;
            border-top: 6px solid #FFD700;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.4);
        }
        
        .wheel-center {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 20px;
            height: 20px;
            background: #FFD700;
            border-radius: 50%;
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.6);
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* –Ü–Ω—Ñ–æ –ø—Ä–æ –º–∞—Ä—à—Ä—É—Ç - –ß–û–†–ù–û-–ó–û–õ–û–¢–ò–ô */
        .route-info {
            position: absolute;
            bottom: 80px;
            left: 10px;
            right: 10px;
            background: linear-gradient(135deg, rgba(26, 26, 26, 0.98), rgba(45, 45, 45, 0.98));
            padding: 14px 18px;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.5), 0 0 30px rgba(255, 215, 0, 0.3);
            z-index: 1000;
            font-size: 14px;
            color: rgba(255, 215, 0, 0.9);
            display: none;
            border: 2px solid #FFD700;
            backdrop-filter: blur(10px);
        }
        
        .route-info strong {
            color: #FFD700;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
        }
        
        /* –ö–Ω–æ–ø–∫–∞ —Å–∫–∏–¥–∞–Ω–Ω—è */
        .reset-button {
            position: absolute;
            bottom: 20px;
            left: 20px;
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, rgba(26, 26, 26, 0.95), rgba(45, 45, 45, 0.95));
            border: 2px solid #FFD700;
            border-radius: 50%;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5), 0 0 20px rgba(255, 215, 0, 0.3);
            cursor: pointer;
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #FFD700;
            font-size: 24px;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }
        
        .reset-button:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 25px rgba(0, 0, 0, 0.6), 0 0 35px rgba(255, 215, 0, 0.5);
        }
        
        .reset-button:active {
            transform: scale(0.95);
        }
        
        /* üé® –ê–Ω—ñ–º–∞—Ü—ñ—è –¥–ª—è –º–∞—Ä—à—Ä—É—Ç—É - –ó–û–õ–û–¢–ò–ô –ó GLOW */
        .route-line {
            stroke-dasharray: 10, 5;
            animation: dash 20s linear infinite;
            filter: drop-shadow(0 0 8px rgba(255, 215, 0, 0.8)) drop-shadow(0 0 15px rgba(255, 215, 0, 0.5));
        }
        
        @keyframes dash {
            to {
                stroke-dashoffset: -1000;
            }
        }
        
        /* üîç –°–¢–ò–õ–Ü –î–õ–Ø –ü–û–®–£–ö–£ - –ß–û–†–ù–û-–ó–û–õ–û–¢–ò–ô –°–¢–ò–õ–¨ */
        .leaflet-control-geocoder {
            border: none !important;
            border-radius: 16px !important;
            background: linear-gradient(145deg, rgba(26, 26, 26, 0.98), rgba(45, 45, 45, 0.98)) !important;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.5), 0 0 30px rgba(255, 215, 0, 0.2) !important;
            width: calc(100vw - 20px) !important;
            max-width: calc(100vw - 20px) !important;
            min-width: calc(100vw - 20px) !important;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            backdrop-filter: blur(14px);
            border: 2px solid #FFD700 !important;
            position: fixed !important;
            left: 10px !important;
            top: 10px !important;
            cursor: move !important;
            touch-action: none !important;
            z-index: 1001 !important;
        }
        
        .leaflet-control-geocoder.dragging {
            box-shadow: 0 12px 32px rgba(0, 0, 0, 0.6), 0 0 50px rgba(255, 215, 0, 0.4) !important;
            transition: none !important;
        }

        .leaflet-control-geocoder-form {
            background: transparent !important;
            border-radius: 16px !important;
            padding: 12px 14px !important;
        }

        .leaflet-control-geocoder-form input {
            font-size: 16px !important;
            padding: 14px 18px !important;
            border: 1px solid rgba(255, 215, 0, 0.3) !important;
            border-radius: 14px !important;
            background: rgba(20, 20, 20, 0.9) !important;
            color: #FFD700 !important;
            width: 100% !important;
            box-sizing: border-box !important;
            transition: border-color 0.2s ease, box-shadow 0.2s ease !important;
        }

        .leaflet-control-geocoder-form input:focus {
            border-color: #FFD700 !important;
            outline: none !important;
            box-shadow: 0 4px 20px rgba(255, 215, 0, 0.3) !important;
        }

        .leaflet-control-geocoder-form input::placeholder {
            color: rgba(255, 215, 0, 0.6) !important;
            opacity: 1 !important;
        }

        .leaflet-control-geocoder-form input:disabled {
            background: rgba(20, 20, 20, 0.5) !important;
            color: rgba(255, 215, 0, 0.3) !important;
            cursor: not-allowed !important;
            opacity: 0.7 !important;
        }

        /* –ö–Ω–æ–ø–∫–∞ –ø–æ—à—É–∫—É - –ó–û–õ–û–¢–ê */
        .leaflet-control-geocoder-icon {
            background: linear-gradient(135deg, #FFD700, #FFA500) !important;
            border-radius: 12px !important;
            width: 44px !important;
            height: 44px !important;
            margin: 4px !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            box-shadow: 0 6px 18px rgba(255, 215, 0, 0.5), 0 0 20px rgba(255, 215, 0, 0.3) !important;
            cursor: pointer !important;
            transition: all 0.2s ease !important;
            border: 1px solid rgba(255, 215, 0, 0.5) !important;
        }
        
        .leaflet-control-geocoder-icon:hover {
            transform: scale(1.05) !important;
            box-shadow: 0 8px 22px rgba(255, 215, 0, 0.6), 0 0 30px rgba(255, 215, 0, 0.4) !important;
        }
        
        .leaflet-control-geocoder-icon:active {
            transform: scale(0.95) !important;
        }
        
        /* –Ü–∫–æ–Ω–∫–∞ –ø–æ—à—É–∫—É –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ –∫–Ω–æ–ø–∫–∏ */
        .leaflet-control-geocoder-icon::before {
            content: "üîç" !important;
            font-size: 20px !important;
            display: block !important;
            filter: drop-shadow(0 0 2px rgba(0, 0, 0, 0.5));
        }

        /* –°–ø–∏—Å–æ–∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ñ–≤ - –¢–ï–ú–ù–ò–ô */
        .leaflet-control-geocoder-alternatives {
            background: rgba(20, 20, 20, 0.98) !important;
            border: 1px solid rgba(255, 215, 0, 0.3) !important;
            border-radius: 0 0 18px 18px !important;
            box-shadow: 0 18px 32px rgba(0, 0, 0, 0.5) !important;
            max-height: 320px !important;
            overflow-y: auto !important;
            margin-top: 10px !important;
            backdrop-filter: blur(14px);
        }

        .leaflet-control-geocoder-alternatives-minimized {
            display: none !important;
        }

        /* –û–∫—Ä–µ–º–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç */
        .leaflet-control-geocoder-alternative {
            padding: 16px 18px !important;
            border-bottom: 1px solid rgba(255, 215, 0, 0.15) !important;
            color: #FFD700 !important;
            cursor: pointer !important;
            transition: background 0.2s ease, transform 0.2s ease, color 0.2s ease !important;
            font-size: 15px !important;
        }

        .leaflet-control-geocoder-alternative:hover {
            background: rgba(255, 215, 0, 0.15) !important;
            transform: translateY(-1px);
            color: #FFED4E !important;
        }

        .leaflet-control-geocoder-alternative:last-child {
            border-bottom: none !important;
            border-radius: 0 0 18px 18px !important;
        }

        .leaflet-control-geocoder-alternative-first {
            background: rgba(255, 215, 0, 0.2) !important;
            font-weight: 600 !important;
            color: #FFD700 !important;
        }
        
        /* –ü—Ä–∏–±—Ä–∞—Ç–∏ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∏–π spinner */
        .leaflet-control-geocoder-throbber {
            display: none !important;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    
    <!-- –Ü–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è –ø—Ä–æ –º–∞—Ä—à—Ä—É—Ç -->
    <div class="route-info" id="route-info" style="display: none;">
        <strong>üìè –ú–∞—Ä—à—Ä—É—Ç:</strong><br>
        –í—ñ–¥—Å—Ç–∞–Ω—å: 0 –∫–º<br>
        –ß–∞—Å: ~0 —Ö–≤
    </div>
    
    <!-- –ö–Ω–æ–ø–∫–∞ —Å–∫–∏–¥–∞–Ω–Ω—è -->
    <button class="reset-button" id="reset-btn" title="–ü–æ—á–∞—Ç–∏ —Å–ø–æ—á–∞—Ç–∫—É">
        üîÑ
    </button>
    
    <!-- –ö–Ω–æ–ø–∫–∞ –≥–µ–æ–ª–æ–∫–∞—Ü—ñ—ó -->
    <button class="locate-button" id="locate-btn" title="–ú–æ—è –≥–µ–æ–ª–æ–∫–∞—Ü—ñ—è">
        üìç
    </button>
    
    <!-- üöó –ö–∞—Å—Ç–æ–º–Ω–∏–π loader "Urban" -->
    <div class="loading" id="loading">
        <div class="loading-text" id="loading-text">Urban</div>
        <div class="loading-wheel">
            <div class="wheel"></div>
            <div class="wheel-center"></div>
        </div>
    </div>
    
    <!-- Telegram WebApp SDK -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- Leaflet Control Geocoder JS (–¥–ª—è –ø–æ—à—É–∫—É –∞–¥—Ä–µ—Å) -->
    <script src="https://unpkg.com/leaflet-control-geocoder@2.4.0/dist/Control.Geocoder.js"></script>
    
    <script>
        // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è Telegram WebApp
        const tg = window.Telegram.WebApp;
        tg.expand();
        
        // –ù–û–í–ê –õ–û–ì–Ü–ö–ê: 3 —Å—Ç–∞–Ω–∏
        // 1. pickup - –æ–±–∏—Ä–∞—î–º–æ –º—ñ—Å—Ü–µ –ø–æ—Å–∞–¥–∫–∏
        // 2. destination - –æ–±–∏—Ä–∞—î–º–æ –º—ñ—Å—Ü–µ –ø—Ä–∏–∑–Ω–∞—á–µ–Ω–Ω—è (–ø–æ–∫–∞–∑—É—î—Ç—å—Å—è –º–∞—Ä—à—Ä—É—Ç)
        // 3. confirm - –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂—É—î–º–æ –æ–±–∏–¥–≤—ñ —Ç–æ—á–∫–∏ (–≤—ñ–¥–ø—Ä–∞–≤–ª—è—î–º–æ –≤ –±–æ—Ç)
        
        let currentState = 'pickup';  // pickup ‚Üí destination ‚Üí confirm
        let pickupCoords = null;
        let destinationCoords = null;
        
        tg.MainButton.setText('‚úÖ –ü—ñ–¥—Ç–≤–µ—Ä–¥–∏—Ç–∏ –º—ñ—Å—Ü–µ –ø–æ—Å–∞–¥–∫–∏');
        tg.MainButton.color = '#FFD700'; // –ó–æ–ª–æ—Ç–∞ –∫–Ω–æ–ø–∫–∞
        tg.MainButton.textColor = '#1a1a1a'; // –ß–æ—Ä–Ω–∏–π —Ç–µ–∫—Å—Ç
        tg.MainButton.hide(); // –°–ø–æ—á–∞—Ç–∫—É —Å—Ö–æ–≤–∞—Ç–∏
        
        // –ó–∞—Å—Ç–æ—Å—É–≤–∞—Ç–∏ —Ç–µ–º—É Telegram
        document.body.style.backgroundColor = tg.themeParams.bg_color || '#ffffff';
        
        // üêõ DEBUG —Ñ—É–Ω–∫—Ü—ñ—ó (–ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω—ñ —É –∫–æ–Ω—Å–æ–ª—å)
        function debugLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString('uk-UA');
            let icon = '‚ÑπÔ∏è';
            let logFn = console.log;

            if (type === 'error') {
                icon = '‚ùå';
                logFn = console.error;
            } else if (type === 'success') {
                icon = '‚úÖ';
                logFn = console.log;
            } else if (type === 'warning') {
                icon = '‚ö†Ô∏è';
                logFn = console.warn;
            } else if (type === 'search') {
                icon = 'üîç';
                logFn = console.log;
            }

            logFn(`[${timestamp}] ${icon} ${message}`);
        }
        
        // –ü–æ—á–∞—Ç–∫–æ–≤–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
        debugLog('WebApp —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–æ–≤–∞–Ω–æ', 'success');
        debugLog(`–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á: ${tg.initDataUnsafe?.user?.id || '–Ω–µ–≤—ñ–¥–æ–º–∏–π'}`, 'info');
        debugLog(`–ü–æ—Ç–æ—á–Ω–∏–π —Å—Ç–∞–Ω: ${currentState}`, 'info');
        
        // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è –∫–∞—Ä—Ç–∏ (—Ü–µ–Ω—Ç—Ä –£–∫—Ä–∞—ó–Ω–∏)
        const map = L.map('map', {
            zoomControl: false, // –ü—Ä–∏–±—Ä–∞—Ç–∏ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∏–π zoom control
        }).setView([48.3794, 31.1656], 6); // –£–∫—Ä–∞—ó–Ω–∞
        
        // üó∫Ô∏è –°–í–Ü–¢–õ–ê –ö–û–ù–¢–†–ê–°–¢–ù–ê –ö–ê–†–¢–ê
        // OpenStreetMap Standard - –∫–ª–∞—Å–∏—á–Ω–∞ –∫–∞—Ä—Ç–∞ –∑ –≤–∏—Å–æ–∫–æ—é –∫–æ–Ω—Ç—Ä–∞—Å—Ç–Ω—ñ—Å—Ç—é
        const baseLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap contributors',
            maxZoom: 19,
            subdomains: 'abc'
        }).addTo(map);

        // –ü—ñ–¥–≤–∏—â–µ–Ω–∞ –∫–æ–Ω—Ç—Ä–∞—Å—Ç–Ω—ñ—Å—Ç—å: –≤—É–ª–∏—Ü—ñ —á—ñ—Ç–∫—ñ—à—ñ, —Ç—Ä–∞–≤–∞ –∑–µ–ª–µ–Ω—ñ—à–∞, –≤–æ–¥–∞ —Å–∏–Ω—ñ—à–∞
        const tilePane = map.getPane('tilePane');
        if (tilePane) {
            tilePane.style.filter = 'contrast(1.15) saturate(1.25) brightness(0.98)';
        }
        
        // –î–æ–¥–∞—Ç–∏ zoom control –≤ —ñ–Ω—à–µ –º—ñ—Å—Ü–µ
        L.control.zoom({
            position: 'bottomleft'
        }).addTo(map);
        
        // üéØ –ê–í–¢–û–ú–ê–¢–ò–ß–ù–ï –¶–ï–ù–¢–†–£–í–ê–ù–ù–Ø –ù–ê –ú–Ü–°–¢–û –ö–õ–Ü–Ñ–ù–¢–ê
        async function centerMapOnClientCity() {
            try {
                const userId = tg.initDataUnsafe?.user?.id;
                if (!userId) {
                    debugLog('‚ö†Ô∏è –ù–µ –≤–¥–∞–ª–æ—Å—å –æ—Ç—Ä–∏–º–∞—Ç–∏ ID –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞', 'error');
                    return;
                }
                
                debugLog(`üîç –û—Ç—Ä–∏–º—É—é –º—ñ—Å—Ç–æ –¥–ª—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ ${userId}...`, 'info');
                
                const response = await fetch('/api/webapp/get-user-city', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: userId })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.success && data.city && data.coordinates) {
                    const { lat, lon, city } = data.coordinates;
                    debugLog(`üèôÔ∏è –ú—ñ—Å—Ç–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞: ${city} (${lat}, ${lon})`, 'success');
                    
                    // –¶–µ–Ω—Ç—Ä—É–≤–∞—Ç–∏ –∫–∞—Ä—Ç—É –Ω–∞ –º—ñ—Å—Ç—ñ –∫–ª—ñ—î–Ω—Ç–∞
                    map.setView([lat, lon], 13, {
                        animate: true,
                        duration: 1.5
                    });
                    
                    // –ü–æ–∫–∞–∑–∞—Ç–∏ –Ω–∞–∑–≤—É –º—ñ—Å—Ç–∞ –Ω–∞ –∫–∞—Ä—Ç—ñ
                    const cityMarker = L.marker([lat, lon], {
                        icon: L.divIcon({
                            className: 'city-label',
                            html: `<div style="
                                background: linear-gradient(135deg, rgba(26, 26, 26, 0.95), rgba(40, 40, 40, 0.95));
                                color: #FFD700;
                                padding: 8px 16px;
                                border-radius: 20px;
                                font-weight: 600;
                                font-size: 14px;
                                border: 2px solid rgba(255, 215, 0, 0.5);
                                box-shadow: 0 4px 12px rgba(255, 215, 0, 0.3), 0 0 20px rgba(255, 215, 0, 0.2);
                                text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
                                white-space: nowrap;
                            ">üèôÔ∏è ${city}</div>`,
                            iconSize: [120, 40],
                            iconAnchor: [60, 20]
                        })
                    }).addTo(map);
                    
                    // –í–∏–¥–∞–ª–∏—Ç–∏ –º—ñ—Ç–∫—É —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥–∏
                    setTimeout(() => {
                        map.removeLayer(cityMarker);
                    }, 3000);
                    
                } else {
                    debugLog('‚ö†Ô∏è –ú—ñ—Å—Ç–æ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ –¥–ª—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞', 'warning');
                }
                
            } catch (error) {
                debugLog(`‚ùå –ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –æ—Ç—Ä–∏–º–∞–Ω–Ω—ñ –º—ñ—Å—Ç–∞: ${error.message}`, 'error');
                console.error('–ü–æ–º–∏–ª–∫–∞ —Ü–µ–Ω—Ç—Ä—É–≤–∞–Ω–Ω—è –Ω–∞ –º—ñ—Å—Ç–æ:', error);
            }
        }
        
        // –ó–∞–ø—É—Å—Ç–∏—Ç–∏ —Ü–µ–Ω—Ç—Ä—É–≤–∞–Ω–Ω—è –ø—ñ—Å–ª—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∫–∞—Ä—Ç–∏
        setTimeout(() => {
            centerMapOnClientCity();
        }, 500);
        
        // –ó–º—ñ–Ω–Ω—ñ –¥–ª—è –∑–±–µ—Ä—ñ–≥–∞–Ω–Ω—è –º–∞—Ä–∫–µ—Ä—ñ–≤ —Ç–∞ –º–∞—Ä—à—Ä—É—Ç—É
        let pickupMarker = null;       // –ó–µ–ª–µ–Ω–∏–π –º–∞—Ä–∫–µ—Ä pickup
        let destinationMarker = null;  // –°–∏–Ω—ñ–π –º–∞—Ä–∫–µ—Ä destination
        let routePolyline = null;      // –õ—ñ–Ω—ñ—è –º–∞—Ä—à—Ä—É—Ç—É
        
        // –§—É–Ω–∫—Ü—ñ—è —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –∫–∞—Å—Ç–æ–º–Ω–æ–≥–æ –º–∞—Ä–∫–µ—Ä–∞
        const createMarkerIcon = (isPickup = false) => {
            const color = isPickup ? '#4CAF50' : '#2196F3';  // –ó–µ–ª–µ–Ω–∏–π –¥–ª—è pickup, —Å–∏–Ω—ñ–π –¥–ª—è destination
            const label = isPickup ? 'A' : 'B';
            return L.divIcon({
                className: 'marker-icon',
                html: `
                    <div class="pulse" style="background: ${color}; border-color: ${color};">
                        <div style="
                            position: absolute;
                            top: 50%;
                            left: 50%;
                            transform: translate(-50%, -50%);
                            color: white;
                            font-weight: bold;
                            font-size: 14px;
                        ">${label}</div>
                    </div>
                `,
                iconSize: [35, 35],
                iconAnchor: [17, 17]
            });
        };
        
        // –§—É–Ω–∫—Ü—ñ—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ç–∞ –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è –º–∞—Ä—à—Ä—É—Ç—É
        async function loadAndShowRoute(fromLat, fromLon, toLat, toLon) {
            try {
                // –ü–æ–∫–∞–∑–∞—Ç–∏ –∫–∞—Å—Ç–æ–º–Ω–∏–π —ñ–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è Urban
                const loading = document.getElementById('loading');
                const loadingText = document.getElementById('loading-text');
                loadingText.textContent = 'Urban';
                loading.style.display = 'block';
                
                // ‚è∞ –ó–∞–ø—É—Å—Ç–∏—Ç–∏ —Ç–∞–π–º–µ—Ä –¥–ª—è –º—ñ–Ω—ñ–º–∞–ª—å–Ω–æ—ó –∑–∞—Ç—Ä–∏–º–∫–∏ 2 —Å–µ–∫—É–Ω–¥–∏
                const minLoadingTime = 2000; // 2 —Å–µ–∫—É–Ω–¥–∏
                const startTime = Date.now();
                
                // –í–∏–¥–∞–ª–∏—Ç–∏ –ø–æ–ø–µ—Ä–µ–¥–Ω—ñ–π –º–∞—Ä—à—Ä—É—Ç
                if (routePolyline) {
                    map.removeLayer(routePolyline);
                }
                
                // üöó OSRM Routing Engine:
                // - –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î –∞–ª–≥–æ—Ä–∏—Ç–º Contraction Hierarchies (CH)
                // - –ó–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º –æ–±–∏—Ä–∞—î –ù–ê–ô–®–í–ò–î–®–ò–ô –º–∞—Ä—à—Ä—É—Ç (fastest)
                // - –í—Ä–∞—Ö–æ–≤—É—î —à–≤–∏–¥–∫—ñ—Å—Ç—å –¥–æ—Ä—ñ–≥, –ø—Ä–æ–±–∫–∏, —Ç–∏–ø–∏ –¥–æ—Ä—ñ–≥
                // - –û–ø—Ç–∏–º–∞–ª—å–Ω–∏–π –¥–ª—è —Ç–∞–∫—Å—ñ: —à–≤–∏–¥–∫—ñ—Å—Ç—å > –≤—ñ–¥—Å—Ç–∞–Ω—å
                // 
                // –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞: –¥–æ–¥–∞—Ç–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä alternatives=true –¥–ª—è –ø–æ–∫–∞–∑—É –∫—ñ–ª—å–∫–æ—Ö –º–∞—Ä—à—Ä—É—Ç—ñ–≤
                const url = `https://router.project-osrm.org/route/v1/driving/${fromLon},${fromLat};${toLon},${toLat}?overview=full&geometries=geojson`;
                const response = await fetch(url, { timeout: 10000 });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.code === 'Ok' && data.routes && data.routes.length > 0) {
                    const route = data.routes[0];
                    const coords = route.geometry.coordinates.map(c => [c[1], c[0]]); // [lng, lat] ‚Üí [lat, lng]
                    
                    // üé® –í—ñ–¥–æ–±—Ä–∞–∑–∏—Ç–∏ –º–∞—Ä—à—Ä—É—Ç –∑ –∞–Ω—ñ–º–∞—Ü—ñ—î—é –º–∞–ª—é–≤–∞–Ω–Ω—è - –ó–û–õ–û–¢–ò–ô
                    routePolyline = L.polyline(coords, {
                        color: '#FFD700',
                        weight: 6,
                        opacity: 0.9,
                        className: 'route-line',
                        // –î–æ–¥–∞—Ç–∏ dashArray –¥–ª—è –∞–Ω—ñ–º–∞—Ü—ñ—ó –º–∞–ª—é–≤–∞–Ω–Ω—è
                        dashArray: '2000',
                        dashOffset: '2000'
                    }).addTo(map);
                    
                    // üåä –ê–Ω—ñ–º–∞—Ü—ñ—è "–º–∞–ª—é–≤–∞–Ω–Ω—è" –º–∞—Ä—à—Ä—É—Ç—É
                    setTimeout(() => {
                        if (routePolyline) {
                            const line = routePolyline.getElement();
                            if (line) {
                                line.style.animation = 'drawRoute 1.5s ease-out forwards';
                                // –ü—ñ—Å–ª—è –∞–Ω—ñ–º–∞—Ü—ñ—ó –º–∞–ª—é–≤–∞–Ω–Ω—è - –¥–æ–¥–∞—Ç–∏ —Ä—É—Ö–æ–º—ñ –ø—É–Ω–∫—Ç–∏—Ä–∏
                                setTimeout(() => {
                                    routePolyline.setStyle({ dashArray: '10, 5' });
                                }, 1500);
                            }
                        }
                    }, 100);
                    
                    // –¶–µ–Ω—Ç—Ä—É–≤–∞—Ç–∏ –∫–∞—Ä—Ç—É –Ω–∞ –º–∞—Ä—à—Ä—É—Ç
                    map.fitBounds(routePolyline.getBounds(), { padding: [50, 50] });
                    
                    // –í—ñ–¥–æ–±—Ä–∞–∑–∏—Ç–∏ –≤—ñ–¥—Å—Ç–∞–Ω—å —Ç–∞ —á–∞—Å
                    const distance = (route.distance / 1000).toFixed(1);
                    const duration = Math.round(route.duration / 60);
                    
                    // –†–æ–∑—Ä–∞—Ö—É–≤–∞—Ç–∏ —Ü—ñ–Ω—É —á–µ—Ä–µ–∑ backend
                    loadingText.textContent = 'Urban';
                    
                    try {
                        const userId = tg.initDataUnsafe?.user?.id;
                        if (userId) {
                            const priceResponse = await fetch('/api/webapp/calculate-price', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({
                                    user_id: userId,
                                    distance_km: parseFloat(distance),
                                    duration_minutes: duration
                                })
                            });
                            
                            if (priceResponse.ok) {
                                const priceData = await priceResponse.json();
                                if (priceData.success) {
                                    debugLog(`üí∞ –¶—ñ–Ω–∞ —Ä–æ–∑—Ä–∞—Ö–æ–≤–∞–Ω–∞: ${priceData.price} –≥—Ä–Ω`, 'success');
                                    updateRouteInfo(distance, duration, priceData.price, priceData.explanation);
                                } else {
                                    debugLog(`‚ö†Ô∏è –ü–æ–º–∏–ª–∫–∞ —Ä–æ–∑—Ä–∞—Ö—É–Ω–∫—É —Ü—ñ–Ω–∏: ${priceData.error}`, 'warning');
                                    updateRouteInfo(distance, duration);
                                }
                            } else {
                                debugLog('‚ö†Ô∏è –ù–µ –≤–¥–∞–ª–æ—Å—è —Ä–æ–∑—Ä–∞—Ö—É–≤–∞—Ç–∏ —Ü—ñ–Ω—É (HTTP error)', 'warning');
                                updateRouteInfo(distance, duration);
                            }
                        } else {
                            debugLog('‚ö†Ô∏è User ID –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ, –ø—Ä–æ–ø—É—Å–∫–∞—é —Ä–æ–∑—Ä–∞—Ö—É–Ω–æ–∫ —Ü—ñ–Ω–∏', 'warning');
                            updateRouteInfo(distance, duration);
                        }
                    } catch (priceError) {
                        debugLog(`‚ö†Ô∏è –ü–æ–º–∏–ª–∫–∞ —Ä–æ–∑—Ä–∞—Ö—É–Ω–∫—É —Ü—ñ–Ω–∏: ${priceError.message}`, 'warning');
                        updateRouteInfo(distance, duration);
                    }
                    
                    console.log(`‚úÖ –ú–∞—Ä—à—Ä—É—Ç –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ: ${distance} –∫–º, ${duration} —Ö–≤`);
                    
                    // ‚è∞ –ü–µ—Ä–µ–∫–æ–Ω–∞—Ç–∏—Å—è —â–æ –º–∏–Ω—É–ª–æ –º—ñ–Ω—ñ–º—É–º 2 —Å–µ–∫—É–Ω–¥–∏ –¥–ª—è –ø–æ–∫–∞–∑—É "Urban"
                    const elapsedTime = Date.now() - startTime;
                    const remainingTime = Math.max(0, minLoadingTime - elapsedTime);
                    
                    if (remainingTime > 0) {
                        debugLog(`‚è≥ –ß–µ–∫–∞—é —â–µ ${remainingTime}ms —â–æ–± "Urban" –≤—Å—Ç–∏–≥ –∑'—è–≤–∏—Ç–∏—Å—è`, 'info');
                        await new Promise(resolve => setTimeout(resolve, remainingTime));
                    }
                    
                    loading.style.display = 'none';
                } else {
                    throw new Error('–ú–∞—Ä—à—Ä—É—Ç –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ');
                }
            } catch (error) {
                console.error('‚ùå –ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –º–∞—Ä—à—Ä—É—Ç—É:', error);
                const loading = document.getElementById('loading');
                loading.style.display = 'none';
                
                // –ü–æ–∫–∞–∑–∞—Ç–∏ –ø–æ–º–∏–ª–∫—É –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—É
                alert('‚ö†Ô∏è –ù–µ –≤–¥–∞–ª–æ—Å—è –ø–æ–±—É–¥—É–≤–∞—Ç–∏ –º–∞—Ä—à—Ä—É—Ç.\n–°–ø—Ä–æ–±—É–π—Ç–µ –æ–±—Ä–∞—Ç–∏ —ñ–Ω—à—ñ —Ç–æ—á–∫–∏.');
                
                if (tg.HapticFeedback) {
                    tg.HapticFeedback.notificationOccurred('error');
                }
            }
        }
        
        // –§—É–Ω–∫—Ü—ñ—è –æ–Ω–æ–≤–ª–µ–Ω–Ω—è placeholder –≤ –ø–æ—à—É–∫—É
        function updateSearchPlaceholder(state) {
            const searchInput = document.querySelector('.leaflet-control-geocoder-form input');
            if (!searchInput) return;
            
            if (state === 'pickup') {
                searchInput.placeholder = 'üìç –ó–≤—ñ–¥–∫–∏ —ó–¥–µ–º–æ? (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥: –ö–∏—ó–≤, –•—Ä–µ—â–∞—Ç–∏–∫ 1)';
            } else if (state === 'destination') {
                searchInput.placeholder = 'üéØ –ö—É–¥–∏ —ó–¥–µ–º–æ? (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥: –õ—å–≤—ñ–≤, –ø–ª. –†–∏–Ω–æ–∫)';
            } else if (state === 'confirm') {
                searchInput.placeholder = '‚úÖ –ü—ñ–¥—Ç–≤–µ—Ä–¥—ñ—Ç—å –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è';
                searchInput.disabled = true;  // –í–∏–º–∫–Ω—É—Ç–∏ –ø–æ—à—É–∫ –Ω–∞ –µ—Ç–∞–ø—ñ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è
            } else {
                searchInput.disabled = false;
            }
        }
        
        // –§—É–Ω–∫—Ü—ñ—è –æ–Ω–æ–≤–ª–µ–Ω–Ω—è —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—ó –ø—Ä–æ –º–∞—Ä—à—Ä—É—Ç
        function updateRouteInfo(distance, duration, price = null, explanation = null) {
            const routeInfo = document.getElementById('route-info');
            if (routeInfo) {
                let html = `
                    <strong>üìè –ú–∞—Ä—à—Ä—É—Ç:</strong><br>
                    –í—ñ–¥—Å—Ç–∞–Ω—å: ${distance} –∫–º<br>
                    –ß–∞—Å: ~${duration} —Ö–≤
                `;
                
                if (price !== null) {
                    html += `<br><strong>üí∞ –¶—ñ–Ω–∞ (Economy): ${price} –≥—Ä–Ω</strong>`;
                    if (explanation) {
                        // –î–æ–¥–∞—î–º–æ –ø—ñ–¥–∫–∞–∑–∫—É –∑ –ø–æ—è—Å–Ω–µ–Ω–Ω—è–º
                        html += `<br><small style="color: #666; font-size: 11px;">${explanation.replace(/\n/g, '<br>')}</small>`;
                    }
                }
                
                routeInfo.innerHTML = html;
                routeInfo.style.display = 'block';
            }
        }
        
        // –§—É–Ω–∫—Ü—ñ—è –æ—á–∏—â–µ–Ω–Ω—è –≤—Å—å–æ–≥–æ
        function resetMap() {
            // –í–∏–¥–∞–ª–∏—Ç–∏ –º–∞—Ä–∫–µ—Ä–∏
            if (pickupMarker) {
                map.removeLayer(pickupMarker);
                pickupMarker = null;
            }
            if (destinationMarker) {
                map.removeLayer(destinationMarker);
                destinationMarker = null;
            }
            if (routePolyline) {
                map.removeLayer(routePolyline);
                routePolyline = null;
            }
            
            // –°–∫–∏–Ω—É—Ç–∏ —Å—Ç–∞–Ω
            currentState = 'pickup';
            pickupCoords = null;
            destinationCoords = null;
            
            // –û–Ω–æ–≤–∏—Ç–∏ UI
            tg.MainButton.setText('‚úÖ –ü—ñ–¥—Ç–≤–µ—Ä–¥–∏—Ç–∏ –º—ñ—Å—Ü–µ –ø–æ—Å–∞–¥–∫–∏');
            tg.MainButton.hide();
            updateSearchPlaceholder('pickup');
            
            const routeInfo = document.getElementById('route-info');
            if (routeInfo) {
                routeInfo.style.display = 'none';
            }
            
            // –û—á–∏—Å—Ç–∏—Ç–∏ –ø–æ–ª–µ –ø–æ—à—É–∫—É
            const searchInput = document.querySelector('.leaflet-control-geocoder-form input');
            if (searchInput) {
                searchInput.value = '';
                searchInput.disabled = false;
            }
            
            // –¶–µ–Ω—Ç—Ä—É–≤–∞—Ç–∏ –Ω–∞ –£–∫—Ä–∞—ó–Ω—É
            map.setView([48.3794, 31.1656], 6);
            
            console.log('üîÑ –ö–∞—Ä—Ç—É —Å–∫–∏–Ω—É—Ç–æ');
        }
        
        // üîç –ü–û–®–£–ö –ê–î–†–ï–° (Geocoder) –∑ –ø–æ–∫—Ä–∞—â–µ–Ω–∏–º–∏ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è–º–∏
        const geocoder = L.Control.Geocoder.nominatim({
            serviceUrl: 'https://nominatim.openstreetmap.org',
            geocodingQueryParams: {
                countrycodes: 'ua',  // –¢—ñ–ª—å–∫–∏ –£–∫—Ä–∞—ó–Ω–∞
                addressdetails: 1,
                limit: 8
                // –ü—Ä–∏–±—Ä–∞–≤ 'accept-language' —Ç–∞ 'dedupe' - –≤–æ–Ω–∏ –ª–∞–º–∞—é—Ç—å –ø–æ—à—É–∫!
            }
        });
        
        // üêõ DEBUG + fallback: –ª–æ–≥—É–≤–∞–Ω–Ω—è, –æ–±–º–µ–∂–µ–Ω–Ω—è –∑–∞–ø–∏—Ç—ñ–≤ —Ç–∞ —Å–µ—Ä–≤–µ—Ä–Ω–∏–π –ø—Ä–æ–∫—Å—ñ
        const originalGeocode = geocoder.geocode.bind(geocoder);
        const NOMINATIM_MIN_INTERVAL_MS = 1100; // –æ—Ñ—ñ—Ü—ñ–π–Ω–µ –æ–±–º–µ–∂–µ–Ω–Ω—è: –Ω–µ –±—ñ–ª—å—à–µ 1 –∑–∞–ø–∏—Ç—É/—Å–µ–∫—É–Ω–¥—É
        const PROXY_ENDPOINT_PATH = '/api/webapp/geocode';
        let lastNominatimRequestAt = 0;

        const transformNominatimResults = (items) => {
            if (!Array.isArray(items) || items.length === 0) {
                return [];
            }

            return items
                .map((item) => {
                    if (!item || typeof item !== 'object') {
                        return null;
                    }

                    const bbox = Array.isArray(item.boundingbox)
                        ? item.boundingbox.map((value) => Number(value))
                        : null;

                    let bounds = null;
                    if (bbox && bbox.length === 4 && bbox.every((value) => Number.isFinite(value))) {
                        bounds = L.latLngBounds(
                            [bbox[0], bbox[2]],
                            [bbox[1], bbox[3]]
                        );
                    }

                    const lat = Number(item.lat);
                    const lon = Number(item.lon);
                    if (!Number.isFinite(lat) || !Number.isFinite(lon)) {
                        return null;
                    }

                    return {
                        icon: item.icon,
                        name: item.display_name,
                        html: geocoder.options.htmlTemplate ? geocoder.options.htmlTemplate(item) : undefined,
                        bbox: bounds || L.latLngBounds([lat, lon], [lat, lon]),
                        center: L.latLng(lat, lon),
                        properties: item
                    };
                })
                .filter(Boolean);
        };

        const buildProxyUrl = (query, paramsObject) => {
            const url = new URL(PROXY_ENDPOINT_PATH, window.location.origin);
            url.searchParams.set('q', query);
            Object.entries(paramsObject || {}).forEach(([key, value]) => {
                if (value !== undefined && value !== null && `${value}`.trim() !== '') {
                    url.searchParams.append(key, value);
                }
            });
            return url;
        };

        const fetchViaBackendProxy = async (query, paramsObject, stage) => {
            try {
                const url = buildProxyUrl(query, paramsObject);
                debugLog(`üõ∞Ô∏è –í–∏–∫–ª–∏–∫–∞—é –±–µ–∫–µ–Ω–¥-–ø—Ä–æ–∫—Å—ñ –¥–ª—è –ø–æ—à—É–∫—É (${stage}).`, 'info');
                debugLog(`  üîó Proxy URL: ${url.toString()}`, 'info');

                const response = await fetch(url.toString(), {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json'
                    },
                    credentials: 'same-origin'
                });

                if (!response.ok) {
                    debugLog(`‚ùå –ü—Ä–æ–∫—Å—ñ –ø–æ–≤–µ—Ä–Ω—É–≤ —Å—Ç–∞—Ç—É—Å ${response.status}`, 'error');
                    return [];
                }

                const data = await response.json();
                if (Array.isArray(data)) {
                    return transformNominatimResults(data);
                }

                if (Array.isArray(data?.results)) {
                    return transformNominatimResults(data.results);
                }

                debugLog('‚ö†Ô∏è –ü—Ä–æ–∫—Å—ñ –ø–æ–≤–µ—Ä–Ω—É–≤ –Ω–µ–æ—á—ñ–∫—É–≤–∞–Ω–∏–π —Ñ–æ—Ä–º–∞—Ç –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ.', 'warning');
                return [];
            } catch (error) {
                debugLog(`‚ùå –ü–æ–º–∏–ª–∫–∞ –∑–∞–ø–∏—Ç—É –¥–æ –±–µ–∫–µ–Ω–¥-–ø—Ä–æ–∫—Å—ñ: ${error.message}`, 'error');
                return [];
            }
        };

        geocoder.geocode = function(query, callback, context) {
            const normalizedQuery = (query || '').trim().replace(/\s+/g, ' ');
            const paramsSnapshot = this.options.geocodingQueryParams ? { ...this.options.geocodingQueryParams } : {};
            const serviceUrl = (this.options.serviceUrl || '').replace(/\/$/, '');

            if (!normalizedQuery) {
                debugLog('‚ö†Ô∏è –ü–æ—Ä–æ–∂–Ω—ñ–π –∑–∞–ø–∏—Ç –ø—ñ—Å–ª—è –Ω–æ—Ä–º–∞–ª—ñ–∑–∞—Ü—ñ—ó. –ü—Ä–æ–ø—É—Å–∫–∞—é –≤–∏–∫–ª–∏–∫ Nominatim.', 'warning');
                if (typeof callback === 'function') {
                    callback.call(context || this, []);
                }
                return undefined;
            }

            const logRequest = (params, stageLabel) => {
                debugLog(`${stageLabel} –í–∏–∫–ª–∏–∫–∞—é Nominatim API...`, 'info');
                debugLog(`  üìù –ó–∞–ø–∏—Ç: "${normalizedQuery}"`, 'info');
                debugLog(`  üìã –ü–∞—Ä–∞–º–µ—Ç—Ä–∏: ${JSON.stringify(params || {})}`, 'info');
                try {
                    const url = new URL(`${serviceUrl}/search`);
                    url.searchParams.append('q', normalizedQuery);
                    url.searchParams.append('format', 'json');
                    Object.entries(params || {}).forEach(([key, value]) => {
                        if (value !== undefined && value !== null && value !== '') {
                            url.searchParams.append(key, value);
                        }
                    });
                    debugLog(`  üîó URL: ${url.toString()}`, 'info');
                } catch (e) {
                    debugLog(`  ‚ö†Ô∏è –ù–µ –≤–¥–∞–ª–æ—Å—è –ø–æ–±—É–¥—É–≤–∞—Ç–∏ URL: ${e.message}`, 'warning');
                }
            };

            const runWithParams = (paramsObject, stage) => {
                const stageLabel = stage === 'fallback' ? 'üîÅ' : 'üåê';
                const waitMs = Math.max(0, NOMINATIM_MIN_INTERVAL_MS - (Date.now() - lastNominatimRequestAt));

                if (waitMs > 0) {
                    debugLog(`‚è≥ –û—á—ñ–∫—É—é ${waitMs} –º—Å –ø–µ—Ä–µ–¥ –Ω–∞—Å—Ç—É–ø–Ω–∏–º –∑–∞–ø–∏—Ç–æ–º (–ø–æ–ª—ñ—Ç–∏–∫–∞ Nominatim).`, 'info');
                }

                setTimeout(async () => {
                    lastNominatimRequestAt = Date.now();
                    const previousParams = this.options.geocodingQueryParams;
                    this.options.geocodingQueryParams = paramsObject;
                    logRequest(paramsObject, stageLabel);

                    originalGeocode(normalizedQuery, async (rawResults) => {
                        let results = rawResults;

                        // –í—ñ–¥–Ω–æ–≤–∏—Ç–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∏ –Ω–µ–∑–∞–ª–µ–∂–Ω–æ –≤—ñ–¥ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—É
                        this.options.geocodingQueryParams = previousParams;

                        if (!Array.isArray(results)) {
                            if (results && typeof results === 'object' && results.error) {
                                debugLog(`‚ùå –ü–æ–º–∏–ª–∫–∞ Nominatim: ${results.error}`, 'error');
                            } else if (typeof results === 'string' && results.trim() !== '') {
                                debugLog(`‚ö†Ô∏è Nominatim –ø–æ–≤–µ—Ä–Ω—É–≤ –Ω–µ JSON (–º–æ–∂–ª–∏–≤–æ 429 / HTML): ${results.slice(0, 120)}...`, 'warning');
                            } else {
                                debugLog('‚ö†Ô∏è Nominatim –ø–æ–≤–µ—Ä–Ω—É–≤ –ø–æ—Ä–æ–∂–Ω—é/–Ω–µ–æ—á—ñ–∫—É–≤–∞–Ω—É –≤—ñ–¥–ø–æ–≤—ñ–¥—å.', 'warning');
                            }
                            results = [];
                        }

                        if (stage === 'primary' && results.length === 0 && paramsSnapshot.countrycodes) {
                            debugLog('‚ö†Ô∏è –û—Å–Ω–æ–≤–Ω–∏–π –ø–æ—à—É–∫ (–∑ countrycodes) –Ω—ñ—á–æ–≥–æ –Ω–µ –∑–Ω–∞–π—à–æ–≤. –ü—Ä–æ–±—É—é –±–µ–∑ –æ–±–º–µ–∂–µ–Ω–Ω—è –∫—Ä–∞—ó–Ω–∏...', 'warning');
                            const fallbackParams = { ...paramsSnapshot };
                            delete fallbackParams.countrycodes;
                            runWithParams(fallbackParams, 'fallback');
                            return;
                        }

                        let shouldTryProxy = results.length === 0;

                        if (stage === 'fallback' && results.length > 0) {
                            debugLog(`‚úÖ Fallback –±–µ–∑ countrycodes –∑–Ω–∞–π—à–æ–≤ ${results.length} —Ä–µ–∑—É–ª—å—Ç–∞—Ç(–∏).`, 'success');
                            shouldTryProxy = false;
                        }

                        if (shouldTryProxy && stage === 'fallback') {
                            const proxyResults = await fetchViaBackendProxy(normalizedQuery, paramsObject, stage);
                            if (proxyResults.length > 0) {
                                debugLog(`‚úÖ –ü—Ä–æ–∫—Å—ñ (fallback) –∑–Ω–∞–π—à–æ–≤ ${proxyResults.length} —Ä–µ–∑—É–ª—å—Ç–∞—Ç(–∏).`, 'success');
                                results = proxyResults;
                                shouldTryProxy = false;
                            } else {
                                debugLog('‚ö†Ô∏è –ù–∞–≤—ñ—Ç—å fallback –±–µ–∑ countrycodes –Ω–µ –¥–∞–≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ñ–≤.', 'warning');
                            }
                        } else if (shouldTryProxy && stage === 'primary' && !paramsSnapshot.countrycodes) {
                            const proxyResults = await fetchViaBackendProxy(normalizedQuery, paramsObject, stage);
                            if (proxyResults.length > 0) {
                                debugLog(`‚úÖ –ü—Ä–æ–∫—Å—ñ –∑–Ω–∞–π—à–æ–≤ ${proxyResults.length} —Ä–µ–∑—É–ª—å—Ç–∞—Ç(–∏).`, 'success');
                                results = proxyResults;
                                shouldTryProxy = false;
                            } else {
                                debugLog('‚ö†Ô∏è –ü–æ—à—É–∫ –Ω–µ –¥–∞–≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ñ–≤ –Ω–∞–≤—ñ—Ç—å —á–µ—Ä–µ–∑ –ø—Ä–æ–∫—Å—ñ.', 'warning');
                            }
                        }

                        if (typeof callback === 'function') {
                            callback.call(context || this, results);
                        }
                    }, context);
                }, waitMs);
            };

            runWithParams(paramsSnapshot, 'primary');
            return undefined;
        };
        
        const geocoderControl = L.Control.geocoder({
            geocoder: geocoder,
            defaultMarkGeocode: false,
            position: 'topright',
            placeholder: 'üìç –ó–≤—ñ–¥–∫–∏ —ó–¥–µ–º–æ? (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥: –ö–∏—ó–≤, –•—Ä–µ—â–∞—Ç–∏–∫ 1)',
            errorMessage: '‚ùå –ù—ñ—á–æ–≥–æ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ. –°–ø—Ä–æ–±—É–π—Ç–µ —ñ–Ω—à–∏–π –∑–∞–ø–∏—Ç',
            collapsed: false,
            expand: 'click',
            suggestMinLength: 3,
            suggestTimeout: 300,
            queryMinLength: 3,
            showResultIcons: true  // –ü–æ–∫–∞–∑—É–≤–∞—Ç–∏ —ñ–∫–æ–Ω–∫–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ñ–≤
        })
        .on('startgeocode', function(e) {
            debugLog(`üîç –ü–û–®–£–ö: "${e.input}"`, 'search');
            debugLog(`üìç –°—Ç–∞–Ω: ${currentState}`, 'info');
        })
        .on('finishgeocode', function(e) {
            const count = e.results ? e.results.length : 0;
            debugLog(`üì¶ –û—Ç—Ä–∏–º–∞–Ω–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ñ–≤: ${count}`, count > 0 ? 'success' : 'warning');
            
            if (count > 0) {
                e.results.forEach((result, index) => {
                    if (index < 5) { // –ü–æ–∫–∞–∑–∞—Ç–∏ –ø–µ—Ä—à—ñ 5
                        debugLog(`  ${index + 1}. ${result.name}`, 'info');
                    }
                });
                if (count > 5) {
                    debugLog(`  ... —Ç–∞ —â–µ ${count - 5}`, 'info');
                }
            } else {
                debugLog('‚ö†Ô∏è Nominatim –Ω–µ –∑–Ω–∞–π—à–æ–≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ñ–≤!', 'warning');
                debugLog('üí° –ü–æ—Ä–∞–¥–∞: –°–ø—Ä–æ–±—É–π—Ç–µ –±–µ–∑ countrycodes=ua', 'info');
                debugLog('üí° –ê–±–æ –ø–µ—Ä–µ–≤—ñ—Ä—Ç–µ URL –≤–∏—â–µ –≤ –±—Ä–∞—É–∑–µ—Ä—ñ', 'info');
            }
        })
        .on('markgeocode', function(e) {
            const latlng = e.geocode.center;
            
            debugLog(`‚úÖ –í–ò–ë–†–ê–ù–û: ${e.geocode.name}`, 'success');
            debugLog(`üìç –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏: ${latlng.lat.toFixed(6)}, ${latlng.lng.toFixed(6)}`, 'info');
            
            // ‚úÖ –ó–ì–û–†–ù–£–¢–ò –ö–õ–ê–í–Ü–ê–¢–£–†–£ –ø—ñ—Å–ª—è –≤–∏–±–æ—Ä—É –∞–¥—Ä–µ—Å–∏
            const searchInput = document.querySelector('.leaflet-control-geocoder-form input');
            if (searchInput) {
                searchInput.blur();  // –ó–≥–æ—Ä–Ω—É—Ç–∏ –∫–ª–∞–≤—ñ–∞—Ç—É—Ä—É
            }
            
            if (currentState === 'pickup') {
                // –í–∏–¥–∞–ª–∏—Ç–∏ —Å—Ç–∞—Ä–∏–π –º–∞—Ä–∫–µ—Ä pickup
                if (pickupMarker) {
                    map.removeLayer(pickupMarker);
                }
                
                // –î–æ–¥–∞—Ç–∏ –º–∞—Ä–∫–µ—Ä pickup (–∑–µ–ª–µ–Ω–∏–π)
                pickupMarker = L.marker(latlng, {
                    icon: createMarkerIcon(true)
                }).addTo(map);
                
                // –ó–±–µ—Ä–µ–≥—Ç–∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏
                pickupCoords = { lat: latlng.lat, lng: latlng.lng };
                
                debugLog(`üü¢ Pickup –∑–±–µ—Ä–µ–∂–µ–Ω–æ`, 'success');
                
                // –ü–æ–∫–∞–∑–∞—Ç–∏ –∫–Ω–æ–ø–∫—É
                tg.MainButton.show();
                
                // ‚úÖ –û–ß–ò–°–¢–ò–¢–ò –ø–æ–ª–µ –ø–æ—à—É–∫—É –ø—ñ—Å–ª—è –≤–∏–±–æ—Ä—É pickup
                if (searchInput) {
                    searchInput.value = '';
                    searchInput.placeholder = 'üéØ –ö—É–¥–∏ —ó–¥–µ–º–æ? (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥: –õ—å–≤—ñ–≤, –ø–ª. –†–∏–Ω–æ–∫)';
                }
                
            } else if (currentState === 'destination') {
                // –í–∏–¥–∞–ª–∏—Ç–∏ —Å—Ç–∞—Ä–∏–π –º–∞—Ä–∫–µ—Ä destination
                if (destinationMarker) {
                    map.removeLayer(destinationMarker);
                }
                
                // –î–æ–¥–∞—Ç–∏ –º–∞—Ä–∫–µ—Ä destination (—Å–∏–Ω—ñ–π)
                destinationMarker = L.marker(latlng, {
                    icon: createMarkerIcon(false)
                }).addTo(map);
                
                // –ó–±–µ—Ä–µ–≥—Ç–∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏
                destinationCoords = { lat: latlng.lat, lng: latlng.lng };
                
                debugLog(`üîµ Destination –∑–±–µ—Ä–µ–∂–µ–Ω–æ`, 'success');
                
                // –ú–ê–õ–Æ–í–ê–¢–ò –º–∞—Ä—à—Ä—É—Ç –≤—ñ–¥—Ä–∞–∑—É –ø—ñ—Å–ª—è –≤–∏–±–æ—Ä—É destination!
                if (pickupCoords && destinationCoords) {
                    debugLog('üó∫Ô∏è –ë—É–¥—É—é –º–∞—Ä—à—Ä—É—Ç...', 'info');
                    loadAndShowRoute(
                        pickupCoords.lat, pickupCoords.lng,
                        destinationCoords.lat, destinationCoords.lng
                    );
                }
                
                // –ü–æ–∫–∞–∑–∞—Ç–∏ –∫–Ω–æ–ø–∫—É
                tg.MainButton.show();
                
                // ‚úÖ –û–ß–ò–°–¢–ò–¢–ò –ø–æ–ª–µ –ø–æ—à—É–∫—É –ø—ñ—Å–ª—è –≤–∏–±–æ—Ä—É destination
                const searchInput = document.querySelector('.leaflet-control-geocoder-form input');
                if (searchInput) {
                    searchInput.value = '';
                }
            }
            
            // –¶–µ–Ω—Ç—Ä—É–≤–∞—Ç–∏ –∫–∞—Ä—Ç—É
            map.setView(latlng, 16);
            
            // –í—ñ–±—Ä–∞—Ü—ñ—è
            if (tg.HapticFeedback) {
                tg.HapticFeedback.impactOccurred('medium');
            }
        }).addTo(map);
        
        // üéØ DRAGGABLE SEARCH BOX
        setTimeout(() => {
            const geocoderElement = document.querySelector('.leaflet-control-geocoder');
            const searchInput = document.querySelector('.leaflet-control-geocoder-form input');
            
            if (geocoderElement) {
                let isDragging = false;
                let startX, startY, initialLeft, initialTop;
                
                // –ü–æ—á–∞—Ç–æ–∫ –ø–µ—Ä–µ—Ç—è–≥—É–≤–∞–Ω–Ω—è
                geocoderElement.addEventListener('mousedown', startDrag);
                geocoderElement.addEventListener('touchstart', startDrag);
                
                function startDrag(e) {
                    // –ù–µ –ø–æ—á–∏–Ω–∞—Ç–∏ drag —è–∫—â–æ –∫–ª—ñ–∫ –ø–æ input
                    if (e.target.tagName === 'INPUT' || e.target.closest('.leaflet-control-geocoder-alternatives')) {
                        return;
                    }
                    
                    isDragging = true;
                    geocoderElement.classList.add('dragging');
                    
                    const touch = e.touches ? e.touches[0] : e;
                    startX = touch.clientX;
                    startY = touch.clientY;
                    
                    const rect = geocoderElement.getBoundingClientRect();
                    initialLeft = rect.left;
                    initialTop = rect.top;
                    
                    e.preventDefault();
                }
                
                // –ü–µ—Ä–µ—Ç—è–≥—É–≤–∞–Ω–Ω—è
                document.addEventListener('mousemove', drag);
                document.addEventListener('touchmove', drag);
                
                function drag(e) {
                    if (!isDragging) return;
                    
                    const touch = e.touches ? e.touches[0] : e;
                    const deltaX = touch.clientX - startX;
                    const deltaY = touch.clientY - startY;
                    
                    const newLeft = initialLeft + deltaX;
                    const newTop = initialTop + deltaY;
                    
                    // –û–±–º–µ–∂–µ–Ω–Ω—è –≤ –º–µ–∂–∞—Ö –µ–∫—Ä–∞–Ω—É
                    const maxLeft = window.innerWidth - geocoderElement.offsetWidth;
                    const maxTop = window.innerHeight - geocoderElement.offsetHeight;
                    
                    geocoderElement.style.left = Math.max(0, Math.min(newLeft, maxLeft)) + 'px';
                    geocoderElement.style.top = Math.max(0, Math.min(newTop, maxTop)) + 'px';
                    geocoderElement.style.right = 'auto';
                    
                    e.preventDefault();
                }
                
                // –ö—ñ–Ω–µ—Ü—å –ø–µ—Ä–µ—Ç—è–≥—É–≤–∞–Ω–Ω—è
                document.addEventListener('mouseup', stopDrag);
                document.addEventListener('touchend', stopDrag);
                
                function stopDrag() {
                    if (isDragging) {
                        isDragging = false;
                        geocoderElement.classList.remove('dragging');
                    }
                }
            }
            
            // –î–æ–¥–∞—Ç–∏ –æ–±—Ä–æ–±–Ω–∏–∫ Enter –¥–ª—è –ø–æ—à—É–∫—É —Ç–∞ –∑–≥–æ—Ä—Ç–∞–Ω–Ω—è –∫–ª–∞–≤—ñ–∞—Ç—É—Ä–∏
            if (searchInput) {
                searchInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        // –ó–≥–æ—Ä–Ω—É—Ç–∏ –∫–ª–∞–≤—ñ–∞—Ç—É—Ä—É –ø—ñ—Å–ª—è Enter
                        setTimeout(() => {
                            searchInput.blur();
                        }, 100);
                    }
                });
            }
        }, 500);
        
        // –û–±—Ä–æ–±–Ω–∏–∫ –∫–ª—ñ–∫—É –ø–æ –∫–∞—Ä—Ç—ñ
        map.on('click', (e) => {
            const { lat, lng } = e.latlng;
            
            if (currentState === 'pickup') {
                // –í–∏–¥–∞–ª–∏—Ç–∏ —Å—Ç–∞—Ä–∏–π –º–∞—Ä–∫–µ—Ä pickup —è–∫—â–æ —î
                if (pickupMarker) {
                    map.removeLayer(pickupMarker);
                }
                
                // –î–æ–¥–∞—Ç–∏ –º–∞—Ä–∫–µ—Ä pickup (–∑–µ–ª–µ–Ω–∏–π)
                pickupMarker = L.marker([lat, lng], {
                    icon: createMarkerIcon(true)
                }).addTo(map);
                
                // –ó–±–µ—Ä–µ–≥—Ç–∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏ pickup
                pickupCoords = { lat, lng };
                
                // –ü–æ–∫–∞–∑–∞—Ç–∏ –∫–Ω–æ–ø–∫—É
                tg.MainButton.show();
                
                // ‚úÖ –û–ß–ò–°–¢–ò–¢–ò –ø–æ–ª–µ –ø–æ—à—É–∫—É –ø—ñ—Å–ª—è –≤–∏–±–æ—Ä—É pickup –∫–ª—ñ–∫–æ–º
                const searchInput = document.querySelector('.leaflet-control-geocoder-form input');
                if (searchInput) {
                    searchInput.value = '';
                    searchInput.placeholder = 'üéØ –ö—É–¥–∏ —ó–¥–µ–º–æ? (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥: –õ—å–≤—ñ–≤, –ø–ª. –†–∏–Ω–æ–∫)';
                }
                
            } else if (currentState === 'destination') {
                // –í–∏–¥–∞–ª–∏—Ç–∏ —Å—Ç–∞—Ä–∏–π –º–∞—Ä–∫–µ—Ä destination —è–∫—â–æ —î
                if (destinationMarker) {
                    map.removeLayer(destinationMarker);
                }
                
                // –î–æ–¥–∞—Ç–∏ –º–∞—Ä–∫–µ—Ä destination (—Å–∏–Ω—ñ–π)
                destinationMarker = L.marker([lat, lng], {
                    icon: createMarkerIcon(false)
                }).addTo(map);
                
                // –ó–±–µ—Ä–µ–≥—Ç–∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏ destination
                destinationCoords = { lat, lng };
                
                debugLog(`üîµ Destination (–∫–ª—ñ–∫) –∑–±–µ—Ä–µ–∂–µ–Ω–æ`, 'success');
                
                // –ú–ê–õ–Æ–í–ê–¢–ò –º–∞—Ä—à—Ä—É—Ç –≤—ñ–¥—Ä–∞–∑—É –ø—ñ—Å–ª—è –≤–∏–±–æ—Ä—É destination!
                if (pickupCoords && destinationCoords) {
                    debugLog('üó∫Ô∏è –ë—É–¥—É—é –º–∞—Ä—à—Ä—É—Ç –ø—ñ—Å–ª—è –∫–ª—ñ–∫—É...', 'info');
                    loadAndShowRoute(
                        pickupCoords.lat, pickupCoords.lng,
                        destinationCoords.lat, destinationCoords.lng
                    );
                }
                
                // –ü–æ–∫–∞–∑–∞—Ç–∏ –∫–Ω–æ–ø–∫—É
                tg.MainButton.show();
                
                // ‚úÖ –û–ß–ò–°–¢–ò–¢–ò –ø–æ–ª–µ –ø–æ—à—É–∫—É –ø—ñ—Å–ª—è –≤–∏–±–æ—Ä—É destination –∫–ª—ñ–∫–æ–º
                const searchInput = document.querySelector('.leaflet-control-geocoder-form input');
                if (searchInput) {
                    searchInput.value = '';
                }
            }
            
            // –í—ñ–±—Ä–∞—Ü—ñ—è
            if (tg.HapticFeedback) {
                tg.HapticFeedback.impactOccurred('light');
            }
        });
        
        // –û–±—Ä–æ–±–Ω–∏–∫ –∫–Ω–æ–ø–∫–∏ (3 —Å—Ç–∞–Ω–∏)
        tg.MainButton.offClick();
        tg.MainButton.onClick(async () => {
            if (currentState === 'pickup') {
                // –°–¢–ê–ù 1: –ü—ñ–¥—Ç–≤–µ—Ä–¥–∂—É—î–º–æ pickup ‚Üí –ø–µ—Ä–µ—Ö–æ–¥–∏–º–æ –¥–æ destination
                if (!pickupCoords) return;
                
                debugLog('‚û°Ô∏è –ü–µ—Ä–µ—Ö—ñ–¥: pickup ‚Üí destination', 'info');
                
                currentState = 'destination';
                tg.MainButton.setText('‚úÖ –ü—ñ–¥—Ç–≤–µ—Ä–¥–∏—Ç–∏ –º—ñ—Å—Ü–µ –ø—Ä–∏–∑–Ω–∞—á–µ–Ω–Ω—è');
                tg.MainButton.hide();  // –°—Ö–æ–≤–∞—Ç–∏ –ø–æ–∫–∏ –Ω–µ –æ–±–µ—Ä–µ destination
                
                // –û–Ω–æ–≤–∏—Ç–∏ placeholder –ø–æ—à—É–∫—É
                updateSearchPlaceholder('destination');
                
                if (tg.HapticFeedback) {
                    tg.HapticFeedback.impactOccurred('medium');
                }
                
            } else if (currentState === 'destination') {
                // –°–¢–ê–ù 2: –ü—ñ–¥—Ç–≤–µ—Ä–¥–∂—É—î–º–æ destination (–º–∞—Ä—à—Ä—É—Ç –≤–∂–µ –Ω–∞–º–∞–ª—å–æ–≤–∞–Ω–æ!)
                if (!destinationCoords) return;
                
                debugLog('‚û°Ô∏è –ü–µ—Ä–µ—Ö—ñ–¥: destination ‚Üí confirm', 'info');
                debugLog(`üìç Pickup: ${pickupCoords.lat.toFixed(6)}, ${pickupCoords.lng.toFixed(6)}`, 'info');
                debugLog(`üìç Destination: ${destinationCoords.lat.toFixed(6)}, ${destinationCoords.lng.toFixed(6)}`, 'info');
                
                // –ú–∞—Ä—à—Ä—É—Ç –≤–∂–µ –Ω–∞–º–∞–ª—å–æ–≤–∞–Ω–æ –ø—Ä–∏ –≤–∏–±–æ—Ä—ñ —Ç–æ—á–∫–∏, –ø—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ—Ö–æ–¥–∏–º–æ –¥–æ confirm
                currentState = 'confirm';
                tg.MainButton.setText('‚úÖ –ü—ñ–¥—Ç–≤–µ—Ä–¥–∏—Ç–∏ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è');
                
                // –û–Ω–æ–≤–∏—Ç–∏ placeholder –ø–æ—à—É–∫—É
                updateSearchPlaceholder('confirm');
                
                if (tg.HapticFeedback) {
                    tg.HapticFeedback.impactOccurred('medium');
                }
                
            } else if (currentState === 'confirm') {
                // –°–¢–ê–ù 3: –í—ñ–¥–ø—Ä–∞–≤–ª—è—î–º–æ –æ–±–∏–¥–≤—ñ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏ –≤ API
                try {
                    const userId = tg.initDataUnsafe?.user?.id;
                    
                    if (!userId) {
                        debugLog('‚ùå –ü–æ–º–∏–ª–∫–∞: –Ω–µ –≤–¥–∞–ª–æ—Å—è –æ—Ç—Ä–∏–º–∞—Ç–∏ ID –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞', 'error');
                        return;
                    }
                    
                    debugLog('üì§ –í—ñ–¥–ø—Ä–∞–≤–ª—è—é –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä...', 'info');
                    debugLog(`  User ID: ${userId}`, 'info');
                    
                    // –í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ –û–ë–ò–î–í–Ü –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏ –æ–¥—Ä–∞–∑—É
                    const apiData = {
                        user_id: userId,
                        pickup_lat: pickupCoords.lat,
                        pickup_lon: pickupCoords.lng,
                        dest_lat: destinationCoords.lat,
                        dest_lon: destinationCoords.lng
                    };
                    
                    debugLog(`  API Data: ${JSON.stringify(apiData)}`, 'info');
                    
                    console.log('üì§ –í—ñ–¥–ø—Ä–∞–≤–ª—è—é –æ–±–∏–¥–≤—ñ —Ç–æ—á–∫–∏:', apiData);
                    
                    const response = await fetch('/api/webapp/order', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(apiData)
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        console.log('‚úÖ –î–∞–Ω—ñ –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ —É—Å–ø—ñ—à–Ω–æ');
                        
                        // –í—ñ–±—Ä–∞—Ü—ñ—è —É—Å–ø—ñ—Ö—É
                        if (tg.HapticFeedback) {
                            tg.HapticFeedback.notificationOccurred('success');
                        }
                        
                        // –ó–∞–∫—Ä–∏—Ç–∏ WebApp
                        setTimeout(() => {
                            tg.close();
                        }, 500);
                    } else {
                        console.error('‚ùå –ü–æ–º–∏–ª–∫–∞ API:', result.error);
                    }
                    
                } catch (error) {
                    console.error('‚ùå –ü–æ–º–∏–ª–∫–∞ –≤—ñ–¥–ø—Ä–∞–≤–∫–∏:', error);
                }
            }
        });
        
        // –ö–Ω–æ–ø–∫–∞ "–ú–æ—è –≥–µ–æ–ª–æ–∫–∞—Ü—ñ—è"
        document.getElementById('locate-btn').addEventListener('click', () => {
            const loading = document.getElementById('loading');
            loading.style.display = 'block';
            
            if (navigator.geolocation) {
                // –¢–∞–π–º–∞—É—Ç –¥–ª—è –≥–∞—Ä–∞–Ω—Ç–æ–≤–∞–Ω–æ–≥–æ –ø—Ä–∏—Ö–æ–≤—É–≤–∞–Ω–Ω—è loading
                const timeoutId = setTimeout(() => {
                    loading.style.display = 'none';
                    console.error('‚è±Ô∏è –ì–µ–æ–ª–æ–∫–∞—Ü—ñ—è: timeout');
                    if (tg.HapticFeedback) {
                        tg.HapticFeedback.notificationOccurred('error');
                    }
                }, 15000); // 15 —Å–µ–∫—É–Ω–¥ –º–∞–∫—Å–∏–º—É–º
                
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        clearTimeout(timeoutId);
                        const { latitude, longitude } = position.coords;
                        
                        loading.style.display = 'none';
                        
                        debugLog(`‚úÖ –ì–µ–æ–ª–æ–∫–∞—Ü—ñ—è –æ—Ç—Ä–∏–º–∞–Ω–∞: ${latitude.toFixed(6)}, ${longitude.toFixed(6)}`, 'success');
                        
                        // –ü–µ—Ä–µ–º—ñ—Å—Ç–∏—Ç–∏ –∫–∞—Ä—Ç—É –¥–æ –ø–æ—Ç–æ—á–Ω–æ—ó –ª–æ–∫–∞—Ü—ñ—ó
                        map.setView([latitude, longitude], 15);
                        
                        // –î–æ–¥–∞—Ç–∏ –º–∞—Ä–∫–µ—Ä –∑–∞–ª–µ–∂–Ω–æ –≤—ñ–¥ —Å—Ç–∞–Ω—É
                        if (currentState === 'pickup') {
                            if (pickupMarker) {
                                map.removeLayer(pickupMarker);
                            }
                            pickupMarker = L.marker([latitude, longitude], {
                                icon: createMarkerIcon(true)
                            }).addTo(map);
                            pickupCoords = { lat: latitude, lng: longitude };
                            
                            debugLog(`üü¢ Pickup (–≥–µ–æ–ª–æ–∫–∞—Ü—ñ—è) –∑–±–µ—Ä–µ–∂–µ–Ω–æ`, 'success');
                            
                            // ‚úÖ –û–ß–ò–°–¢–ò–¢–ò –ø–æ–ª–µ –ø–æ—à—É–∫—É –ø—ñ—Å–ª—è –≤–∏–±–æ—Ä—É pickup –≥–µ–æ–ª–æ–∫–∞—Ü—ñ—î—é
                            const searchInput = document.querySelector('.leaflet-control-geocoder-form input');
                            if (searchInput) {
                                searchInput.value = '';
                                searchInput.placeholder = 'üéØ –ö—É–¥–∏ —ó–¥–µ–º–æ? (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥: –õ—å–≤—ñ–≤, –ø–ª. –†–∏–Ω–æ–∫)';
                            }
                            
                        } else if (currentState === 'destination') {
                            if (destinationMarker) {
                                map.removeLayer(destinationMarker);
                            }
                            destinationMarker = L.marker([latitude, longitude], {
                                icon: createMarkerIcon(false)
                            }).addTo(map);
                            destinationCoords = { lat: latitude, lng: longitude };
                            
                            debugLog(`üîµ Destination (–≥–µ–æ–ª–æ–∫–∞—Ü—ñ—è) –∑–±–µ—Ä–µ–∂–µ–Ω–æ`, 'success');
                            
                            // –ú–ê–õ–Æ–í–ê–¢–ò –º–∞—Ä—à—Ä—É—Ç –≤—ñ–¥—Ä–∞–∑—É –ø—ñ—Å–ª—è –≤–∏–±–æ—Ä—É destination!
                            if (pickupCoords && destinationCoords) {
                                debugLog('üó∫Ô∏è –ë—É–¥—É—é –º–∞—Ä—à—Ä—É—Ç –ø—ñ—Å–ª—è –≥–µ–æ–ª–æ–∫–∞—Ü—ñ—ó...', 'info');
                                loadAndShowRoute(
                                    pickupCoords.lat, pickupCoords.lng,
                                    destinationCoords.lat, destinationCoords.lng
                                );
                            }
                            
                            // ‚úÖ –û–ß–ò–°–¢–ò–¢–ò –ø–æ–ª–µ –ø–æ—à—É–∫—É –ø—ñ—Å–ª—è –≤–∏–±–æ—Ä—É destination –≥–µ–æ–ª–æ–∫–∞—Ü—ñ—î—é
                            const searchInput = document.querySelector('.leaflet-control-geocoder-form input');
                            if (searchInput) {
                                searchInput.value = '';
                            }
                        }
                        
                        // –ü–æ–∫–∞–∑–∞—Ç–∏ –∫–Ω–æ–ø–∫—É
                        tg.MainButton.show();
                        
                        if (tg.HapticFeedback) {
                            tg.HapticFeedback.notificationOccurred('success');
                        }
                    },
                    (error) => {
                        clearTimeout(timeoutId);
                        loading.style.display = 'none';
                        
                        debugLog(`‚ùå –ü–æ–º–∏–ª–∫–∞ –≥–µ–æ–ª–æ–∫–∞—Ü—ñ—ó: ${error.message} (–∫–æ–¥: ${error.code})`, 'error');
                        
                        // –ü–æ–∫–∞–∑–∞—Ç–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –ø—Ä–æ –ø–æ–º–∏–ª–∫—É
                        alert('‚ùå –ù–µ –≤–¥–∞–ª–æ—Å—è –æ—Ç—Ä–∏–º–∞—Ç–∏ –≥–µ–æ–ª–æ–∫–∞—Ü—ñ—é.\n–î–æ–∑–≤–æ–ª—å—Ç–µ –¥–æ—Å—Ç—É–ø –¥–æ –≥–µ–æ–ª–æ–∫–∞—Ü—ñ—ó –≤ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è—Ö –±—Ä–∞—É–∑–µ—Ä–∞.');
                        
                        if (tg.HapticFeedback) {
                            tg.HapticFeedback.notificationOccurred('error');
                        }
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 12000,  // 12 —Å–µ–∫—É–Ω–¥
                        maximumAge: 0
                    }
                );
            } else {
                loading.style.display = 'none';
                console.error('‚ùå –ì–µ–æ–ª–æ–∫–∞—Ü—ñ—è –Ω–µ –ø—ñ–¥—Ç—Ä–∏–º—É—î—Ç—å—Å—è');
                alert('‚ùå –í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø—ñ–¥—Ç—Ä–∏–º—É—î –≥–µ–æ–ª–æ–∫–∞—Ü—ñ—é.');
            }
        });
        
        // –ö–Ω–æ–ø–∫–∞ "–ü–æ—á–∞—Ç–∏ —Å–ø–æ—á–∞—Ç–∫—É"
        document.getElementById('reset-btn').addEventListener('click', () => {
            // –ü—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è
            if (confirm('üîÑ –ü–æ—á–∞—Ç–∏ —Å–ø–æ—á–∞—Ç–∫—É?\n\n–í—Å—ñ –æ–±—Ä–∞–Ω—ñ —Ç–æ—á–∫–∏ –±—É–¥—É—Ç—å —Å–∫–∏–Ω—É—Ç—ñ.')) {
                debugLog('üîÑ RESET: –°–∫–∏–¥–∞–Ω–Ω—è –∫–∞—Ä—Ç–∏...', 'warning');
                resetMap();
                debugLog('‚úÖ –ö–∞—Ä—Ç—É —Å–∫–∏–Ω—É—Ç–æ –¥–æ –ø–æ—á–∞—Ç–∫–æ–≤–æ–≥–æ —Å—Ç–∞–Ω—É', 'success');
                
                if (tg.HapticFeedback) {
                    tg.HapticFeedback.impactOccurred('medium');
                }
            }
        });
        
        // –û–±—Ä–æ–±–∫–∞ –∑–∞–∫—Ä–∏—Ç—Ç—è WebApp
        tg.onEvent('backButtonClicked', () => {
            tg.close();
        });
        
        // –ü–æ–∫–∞–∑–∞—Ç–∏ –∫–Ω–æ–ø–∫—É "–ù–∞–∑–∞–¥" –≤ Telegram
        tg.BackButton.show();
    </script>
</body>
</html>
