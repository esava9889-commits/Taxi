# 📊 АНАЛІЗ ФОРМУЛИ ЦІНОУТВОРЕННЯ

## ✅ ПІДТВЕРДЖЕНО: Формула працює ПРАВИЛЬНО!

---

## 1️⃣ БАЗОВИЙ ТАРИФ (параметри адміна)

### Формула:
```python
base_fare = max(
    tariff.minimum,
    tariff.base_fare + (distance_km * tariff.per_km) + (duration_minutes * tariff.per_minute)
)
```

### Параметри з БД (встановлює адмін):
| Параметр | Опис | Приклад |
|----------|------|---------|
| `base_fare` | Фіксована ставка | 50 грн |
| `per_km` | Ціна за кілометр | 10 грн |
| `per_minute` | Ціна за хвилину | 2 грн |
| `minimum` | Мінімальна ціна | 80 грн |

### Приклади розрахунку:

#### Коротка поїздка (3 км, 10 хв):
```
ціна = 50 + (3 * 10) + (10 * 2) = 50 + 30 + 20 = 100 грн
фінал = max(80, 100) = 100 грн ✅
```

#### Довга поїздка (185 км, 120 хв):
```
ціна = 50 + (185 * 10) + (120 * 2) = 50 + 1850 + 240 = 2140 грн
фінал = max(80, 2140) = 2140 грн ✅
```

---

## 2️⃣ МНОЖНИК КЛАСУ АВТО

### Формула:
```python
class_fare = base_fare * class_multiplier
```

### Множники (встановлює адмін):
| Клас | Множник | Приклад (base=2140) |
|------|---------|---------------------|
| 🚗 Економ | 1.0 | 2140 грн |
| 🚙 Стандарт | 1.3 | 2782 грн (+30%) |
| 🚘 Комфорт | 1.6 | 3424 грн (+60%) |
| 🏆 Бізнес | 2.0 | 4280 грн (+100%) |

---

## 3️⃣ ДИНАМІЧНІ НАЦІНКИ

### Формула:
```python
total_multiplier = time_mult * weather_mult * demand_mult
final_price = class_fare * total_multiplier
```

### 3.1 Часові націнки:

| Умова | Параметр | Приклад |
|-------|----------|---------|
| 🌙 Ніч (23:00-06:00) | `night_percent` | +50% |
| 🔥 Піковий час (7-9, 17-19) | `peak_hours_percent` | +30% |
| 🎉 Вихідні (Пт-Нд 18-23) | `weekend_percent` | +20% |
| 📅 Понеділок (7-10) | `monday_morning_percent` | +15% |

### 3.2 Попит (замовлення / водії):

| Співвідношення | Параметр | Множник |
|----------------|----------|---------|
| ratio > 3 | `demand_very_high_percent` | +40% 🔥🔥🔥 |
| ratio > 2 | `demand_high_percent` | +25% 🔥🔥 |
| ratio > 1.5 | `demand_medium_percent` | +15% 🔥 |
| ratio < 0.3 | `demand_low_discount_percent` | -10% |
| немає водіїв | `no_drivers_percent` | +50% |

### 3.3 Погода:
| Умова | Параметр | Множник |
|-------|----------|---------|
| 🌧️ Погані умови | `weather_percent` | 0-100% |

---

## 📐 ПОВНИЙ ПРИКЛАД РОЗРАХУНКУ

### Вхідні дані:
- 📏 Відстань: **185 км**
- ⏱ Час: **120 хв**
- 🚗 Клас: **Стандарт**
- ⏰ Час доби: **18:00** (піковий)
- 👥 Водії онлайн: **5**
- 📝 Pending orders: **12** (ratio = 12/5 = 2.4)

### Крок 1: Базовий тариф
```
base = 50 + (185 * 10) + (120 * 2) = 2140 грн
```

### Крок 2: Клас авто (Стандарт = 1.3)
```
class_fare = 2140 * 1.3 = 2782 грн
```

### Крок 3: Динамічні націнки
```
Піковий час: 1.0 * 1.3 = 1.3        (+30%)
Попит (ratio=2.4): 1.3 * 1.25 = 1.625  (+25%)
Погода: 1.625 * 1.0 = 1.625         (0%)

total_multiplier = 1.625
```

### Крок 4: Фінальна ціна
```
final = 2782 * 1.625 = 4521 грн 🔥🔥
```

---

## ✅ ВИСНОВОК

### Формула ПРАВИЛЬНА:
1. ✅ Враховує відстань (`distance_km * per_km`)
2. ✅ Враховує час (`duration_minutes * per_minute`)
3. ✅ Застосовує мінімум (`max(minimum, ...)`)
4. ✅ Множить на клас авто
5. ✅ Застосовує ВСІ динамічні націнки:
   - Час доби (ніч, піковий, вихідні)
   - Попит (замовлення/водії)
   - Погода

### ВИПРАВЛЕНО в коді:
- ✅ `webapp_order_handler` тепер отримує `pending_count`
- ✅ Передає ВСІ параметри в `calculate_dynamic_price()`
- ✅ Використовує значення з БД (PricingSettings)

### Де використовується:
1. ✅ `app/handlers/webapp_api.py` - новий API (ВИПРАВЛЕНО!)
2. ✅ `app/handlers/order.py` - стандартний flow
3. ✅ `app/handlers/webapp.py` - WebApp data handler

---

## 🎯 ТЕСТУВАННЯ

Для перевірки:
1. Встановіть параметри через адмін-панель
2. Зробіть замовлення
3. Перевірте що ціна відповідає формулі вище

### Лог показує:
```
Dynamic pricing: base=2782.0, final=4521.0, multiplier=1.625
```

Це означає що множник `1.625` = піковий час (1.3) * попит (1.25) ✅

