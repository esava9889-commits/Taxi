# üí∞ –°–ò–°–¢–ï–ú–ê –î–ò–ù–ê–ú–Ü–ß–ù–û–ì–û –ü–Ü–î–í–ò–©–ï–ù–ù–Ø –¶–Ü–ù–ò

**–î–∞—Ç–∞:** 2025-10-19  
**–í–µ—Ä—Å—ñ—è:** 1.0 - –ù–æ–≤–∞ —Ñ—É–Ω–∫—Ü—ñ—è

---

## üéØ –ü–†–û–ë–õ–ï–ú–ê

### –†–∞–Ω—ñ—à–µ:

–Ø–∫—â–æ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è –Ω—ñ—Ö—Ç–æ –Ω–µ –ø—Ä–∏–π–º–∞–≤:
```
‚ùå –ö–ª—ñ—î–Ω—Ç —á–µ–∫–∞—î 10-15 —Ö–≤–∏–ª–∏–Ω
‚ùå –¶—ñ–Ω–∞ —Ñ—ñ–∫—Å–æ–≤–∞–Ω–∞
‚ùå –ù–µ –º–æ–∂–Ω–∞ –ø—ñ–¥–Ω—è—Ç–∏ —Ü—ñ–Ω—É
‚ùå –ó–∞–º–æ–≤–ª–µ–Ω–Ω—è –∑–∞–ª–∏—à–∞—î—Ç—å—Å—è –Ω–µ–ø—Ä–∏–π–Ω—è—Ç–∏–º
‚ùå –ö–ª—ñ—î–Ω—Ç —Å–∫–∞—Å–æ–≤—É—î –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è
```

---

## ‚úÖ –†–Ü–®–ï–ù–ù–Ø

### –¢–µ–ø–µ—Ä:

**–ö–æ–∂–Ω—ñ 3 —Ö–≤–∏–ª–∏–Ω–∏** –∫–ª—ñ—î–Ω—Ç –æ—Ç—Ä–∏–º—É—î –ø—Ä–æ–ø–æ–∑–∏—Ü—ñ—é –ø—ñ–¥–Ω—è—Ç–∏ —Ü—ñ–Ω—É:

```
‚è∞ –®—É–∫–∞—î–º–æ –≤–æ–¥—ñ—è –≤–∂–µ 3 —Ö–≤–∏–ª–∏–Ω–∏...

–ù–∞ –∂–∞–ª—å, –≤—Å—ñ –≤–æ–¥—ñ—ó –∑–∞—Ä–∞–∑ –∑–∞–π–Ω—è—Ç—ñ.

üí∞ –ü–æ—Ç–æ—á–Ω–∞ —Ü—ñ–Ω–∞: 120 –≥—Ä–Ω

üí° –ü—ñ–¥–≤–∏—â—Ç–µ —Ü—ñ–Ω—É —â–æ–± —à–≤–∏–¥—à–µ –∑–Ω–∞–π—Ç–∏ –≤–æ–¥—ñ—è:

–í–æ–¥—ñ—ó —á–∞—Å—Ç—ñ—à–µ –ø—Ä–∏–π–º–∞—é—Ç—å –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è –∑ –≤–∏—â–æ—é —Ü—ñ–Ω–æ—é.

[üíµ +15 –≥—Ä–Ω] [üíµ +30 –≥—Ä–Ω]
[üíµ +50 –≥—Ä–Ω]
[‚ùå –°–∫–∞—Å—É–≤–∞—Ç–∏ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è]
```

---

## üîÑ –Ø–ö –¶–ï –ü–†–ê–¶–Æ–Ñ

### –ö—Ä–æ–∫ 1: –ö–ª—ñ—î–Ω—Ç –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂—É—î –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è

```
1. –ö–ª—ñ—î–Ω—Ç –∑–∞–ø–æ–≤–Ω—é—î –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è
   ‚Üì
2. –ù–∞—Ç–∏—Å–∫–∞—î "‚úÖ –ü—ñ–¥—Ç–≤–µ—Ä–¥–∏—Ç–∏ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è"
   ‚Üì
3. ‚≠ê –ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è "–ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –¥–∞–Ω—ñ" –í–ò–î–ê–õ–Ø–Ñ–¢–¨–°–Ø
   ‚Üì
4. –ü–æ–∫–∞–∑—É—î—Ç—å—Å—è: "‚úÖ –ó–∞–º–æ–≤–ª–µ–Ω–Ω—è –ø—Ä–∏–π–Ω—è—Ç–æ! üîç –®—É–∫–∞—î–º–æ –≤–æ–¥—ñ—è..."
   ‚Üì
5. –ó–∞–º–æ–≤–ª–µ–Ω–Ω—è –≤—ñ–¥–ø—Ä–∞–≤–ª—è—î—Ç—å—Å—è –≤ –≥—Ä—É–ø—É –≤–æ–¥—ñ—ó–≤
   ‚Üì
6. –ó–∞–ø—É—Å–∫–∞—î—Ç—å—Å—è —Ç–∞–π–º–µ—Ä (3 —Ö–≤)
```

---

### –ö—Ä–æ–∫ 2: –ß–µ—Ä–µ–∑ 3 —Ö–≤–∏–ª–∏–Ω–∏ (—è–∫—â–æ –Ω—ñ—Ö—Ç–æ –Ω–µ –ø—Ä–∏–π–Ω—è–≤)

```
‚è±Ô∏è –¢–ê–ô–ú–ï–† –°–ü–†–ê–¶–Æ–í–ê–í (3 —Ö–≤)
   ‚Üì
–ö–ª—ñ—î–Ω—Ç –æ—Ç—Ä–∏–º—É—î:
   "‚è∞ –®—É–∫–∞—î–º–æ –≤–∂–µ 3 —Ö–≤–∏–ª–∏–Ω–∏...
    üí∞ –ü–æ—Ç–æ—á–Ω–∞ —Ü—ñ–Ω–∞: 120 –≥—Ä–Ω
    üí° –ü—ñ–¥–≤–∏—â—Ç–µ —Ü—ñ–Ω—É:"
    
    [+15] [+30]
    [+50]
    [–°–∫–∞—Å—É–≤–∞—Ç–∏]
   ‚Üì
–ì—Ä—É–ø–∞ –≤–æ–¥—ñ—ó–≤:
   "üî¥ –¢–ï–†–ú–Ü–ù–û–í–ï! –ß–µ–∫–∞—î 3+ —Ö–≤–∏–ª–∏–Ω–∏!"
```

---

### –ö—Ä–æ–∫ 3: –ö–ª—ñ—î–Ω—Ç –ø—ñ–¥–≤–∏—â—É—î —Ü—ñ–Ω—É (+30 –≥—Ä–Ω)

```
–ö–ª—ñ—î–Ω—Ç –Ω–∞—Ç–∏—Å–∫–∞—î: [üíµ +30 –≥—Ä–Ω]
   ‚Üì
1. –ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –∑ –∫–Ω–æ–ø–∫–∞–º–∏ –í–ò–î–ê–õ–Ø–Ñ–¢–¨–°–Ø ‚úÖ
   ‚Üì
2. –ë–î: fare_amount: 120 ‚Üí 150 –≥—Ä–Ω ‚úÖ
   ‚Üì
3. –ì—Ä—É–ø–∞ –≤–æ–¥—ñ—ó–≤ - –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –û–ù–û–í–õ–Æ–Ñ–¢–¨–°–Ø:
   
   "üí∞ –¶–Ü–ù–£ –ü–Ü–î–í–ò–©–ï–ù–û! +30 –≥—Ä–Ω
    ‚¨ÜÔ∏è –ù–æ–≤–∞ –≤–∞—Ä—Ç—ñ—Å—Ç—å: 150 –≥—Ä–Ω
    
    üìç –ó–≤—ñ–¥–∫–∏: ...
    üìç –ö—É–¥–∏: ...
    
    ‚ö†Ô∏è –ö–ª—ñ—î–Ω—Ç –≥–æ—Ç–æ–≤–∏–π –ø–ª–∞—Ç–∏—Ç–∏ –±—ñ–ª—å—à–µ!"
   ‚Üì
4. –ö–ª—ñ—î–Ω—Ç –æ—Ç—Ä–∏–º—É—î:
   "‚úÖ –¶—ñ–Ω—É –ø—ñ–¥–≤–∏—â–µ–Ω–æ!
    üí∞ –ù–æ–≤–∞ –≤–∞—Ä—Ç—ñ—Å—Ç—å: 150 –≥—Ä–Ω
    üîç –ü—Ä–æ–¥–æ–≤–∂—É—î–º–æ –ø–æ—à—É–∫ –∑ –Ω–æ–≤–æ—é —Ü—ñ–Ω–æ—é..."
   ‚Üì
5. –í–æ–¥—ñ—ó –±–∞—á–∞—Ç—å –≤–∏—â—É —Ü—ñ–Ω—É ‚Üí —à–≤–∏–¥—à–µ –ø—Ä–∏–π–º–∞—é—Ç—å ‚úÖ
```

---

### –ö—Ä–æ–∫ 4: –ß–µ—Ä–µ–∑ 6 —Ö–≤–∏–ª–∏–Ω (—è–∫—â–æ –≤—Å–µ —â–µ –Ω–µ –ø—Ä–∏–π–Ω—è—Ç–æ)

```
‚è±Ô∏è –¢–ê–ô–ú–ï–† –°–ü–†–ê–¶–Æ–í–ê–í –ó–ù–û–í–£ (6 —Ö–≤)
   ‚Üì
–ö–ª—ñ—î–Ω—Ç –æ—Ç—Ä–∏–º—É—î –ó–ù–û–í–£:
   "‚è∞ –®—É–∫–∞—î–º–æ –≤–∂–µ 6 —Ö–≤–∏–ª–∏–Ω...
    üí∞ –ü–æ—Ç–æ—á–Ω–∞ —Ü—ñ–Ω–∞: 150 –≥—Ä–Ω  ‚Üê –û–ù–û–í–õ–ï–ù–ê!
    üí° –ü—ñ–¥–≤–∏—â—Ç–µ —Ü—ñ–Ω—É —â–µ:"
    
    [+15] [+30] [+50]
   ‚Üì
–Ü —Ç–∞–∫ –¥–∞–ª—ñ –∫–æ–∂–Ω—ñ 3 —Ö–≤–∏–ª–∏–Ω–∏...
```

---

## üíª –ö–û–î

### 1. –í–∏–¥–∞–ª–µ–Ω–Ω—è –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –ø—Ä–æ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è

**–§–∞–π–ª:** `app/handlers/order.py`

```python
@router.callback_query(F.data == "order:confirm")
async def confirm_order_callback(call: CallbackQuery, state: FSMContext):
    # ‚≠ê –í–∏–¥–∞–ª–∏—Ç–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è "–ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –¥–∞–Ω—ñ"
    try:
        await call.message.delete()  # ‚úÖ –í–ò–î–ê–õ–Ø–Ñ–¢–¨–°–Ø!
    except Exception as e:
        logger.warning(f"–ù–µ –≤–¥–∞–ª–æ—Å—è –≤–∏–¥–∞–ª–∏—Ç–∏: {e}")
    
    # –°—Ç–≤–æ—Ä–∏—Ç–∏ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è...
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
```
–ë–£–õ–û: 2 –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è (–ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è + —à—É–∫–∞—î–º–æ)
–°–¢–ê–õ–û: 1 –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è (—Ç—ñ–ª—å–∫–∏ —à—É–∫–∞—î–º–æ) ‚úÖ
```

---

### 2. –§—É–Ω–∫—Ü—ñ—è –ø—ñ–¥–≤–∏—â–µ–Ω–Ω—è —Ü—ñ–Ω–∏

**–§–∞–π–ª:** `app/storage/db.py`

```python
async def increase_order_fare(db_path: str, order_id: int, increase_amount: float) -> bool:
    """–ü—ñ–¥–≤–∏—â–∏—Ç–∏ —Ü—ñ–Ω—É –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è"""
    async with db_manager.connect(db_path) as db:
        # –û—Ç—Ä–∏–º–∞—Ç–∏ –ø–æ—Ç–æ—á–Ω—É —Ü—ñ–Ω—É
        cur = await db.execute(
            "SELECT fare_amount FROM orders WHERE id = ?",
            (order_id,)
        )
        row = await cur.fetchone()
        
        current_fare = row[0] if row else 100.0
        new_fare = current_fare + increase_amount
        
        # –û–Ω–æ–≤–∏—Ç–∏
        await db.execute(
            "UPDATE orders SET fare_amount = ? WHERE id = ?",
            (new_fare, order_id)
        )
        await db.commit()
        
        logger.info(f"üí∞ –¶—ñ–Ω–∞ #{order_id}: {current_fare} ‚Üí {new_fare} (+{increase_amount})")
        return True
```

---

### 3. –¢–∞–π–º–µ—Ä –∑ –ø—Ä–æ–ø–æ–∑–∏—Ü—ñ—î—é

**–§–∞–π–ª:** `app/utils/order_timeout.py`

```python
# –ü—ñ–¥—Ä–∞—Ö—É–≤–∞—Ç–∏ —Å–∫—ñ–ª—å–∫–∏ —Ä–∞–∑—ñ–≤ —Å–ø—Ä–∞—Ü—é–≤–∞–≤
self._timeout_count[order_id] += 1
timeout_count = self._timeout_count[order_id]  # 1, 2, 3...

# –í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ –ø—Ä–æ–ø–æ–∑–∏—Ü—ñ—é
kb = InlineKeyboardMarkup(
    inline_keyboard=[
        [
            InlineKeyboardButton(text="üíµ +15 –≥—Ä–Ω", callback_data=f"increase_price:{order_id}:15"),
            InlineKeyboardButton(text="üíµ +30 –≥—Ä–Ω", callback_data=f"increase_price:{order_id}:30"),
        ],
        [InlineKeyboardButton(text="üíµ +50 –≥—Ä–Ω", callback_data=f"increase_price:{order_id}:50")],
        [InlineKeyboardButton(text="‚ùå –°–∫–∞—Å—É–≤–∞—Ç–∏", callback_data=f"cancel_waiting_order:{order_id}")]
    ]
)

await bot.send_message(
    order.user_id,
    f"‚è∞ –®—É–∫–∞—î–º–æ –≤–∂–µ {timeout_count * 3} —Ö–≤–∏–ª–∏–Ω...\n"
    f"üí∞ –ü–æ—Ç–æ—á–Ω–∞ —Ü—ñ–Ω–∞: {current_fare:.0f} –≥—Ä–Ω\n"
    f"üí° –ü—ñ–¥–≤–∏—â—Ç–µ —Ü—ñ–Ω—É:",
    reply_markup=kb
)
```

---

### 4. –û–±—Ä–æ–±–Ω–∏–∫ –ø—ñ–¥–≤–∏—â–µ–Ω–Ω—è —Ü—ñ–Ω–∏

**–§–∞–π–ª:** `app/handlers/order.py`

```python
@router.callback_query(F.data.startswith("increase_price:"))
async def increase_price_handler(call: CallbackQuery):
    # –ü–∞—Ä—Å–∏–Ω–≥: increase_price:123:30
    order_id = int(parts[1])
    increase_amount = float(parts[2])  # 15, 30, –∞–±–æ 50
    
    # –û—Ç—Ä–∏–º–∞—Ç–∏ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è
    order = await get_order_by_id(db, order_id)
    
    # –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —â–æ —Ü–µ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è —Ü—å–æ–≥–æ –∫–ª—ñ—î–Ω—Ç–∞
    if order.user_id != call.from_user.id:
        return
    
    # –ü—ñ–¥–≤–∏—â–∏—Ç–∏ —Ü—ñ–Ω—É –≤ –ë–î
    await increase_order_fare(db, order_id, increase_amount)
    
    # ‚≠ê –í–∏–¥–∞–ª–∏—Ç–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –∑ –ø—Ä–æ–ø–æ–∑–∏—Ü—ñ—î—é
    await call.message.delete()
    
    # ‚≠ê –û–Ω–æ–≤–∏—Ç–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –≤ –≥—Ä—É–ø—ñ –≤–æ–¥—ñ—ó–≤
    await bot.edit_message_text(
        chat_id=group_id,
        message_id=order.group_message_id,
        text=(
            f"üí∞ –¶–Ü–ù–£ –ü–Ü–î–í–ò–©–ï–ù–û! +{increase_amount} –≥—Ä–Ω\n"
            f"‚¨ÜÔ∏è –ù–æ–≤–∞ –≤–∞—Ä—Ç—ñ—Å—Ç—å: {new_fare} –≥—Ä–Ω\n"
            f"üìç –ó–≤—ñ–¥–∫–∏: ...\n"
            f"‚ö†Ô∏è –ö–ª—ñ—î–Ω—Ç –≥–æ—Ç–æ–≤–∏–π –ø–ª–∞—Ç–∏—Ç–∏ –±—ñ–ª—å—à–µ!"
        )
    )
    
    # –ü—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è –∫–ª—ñ—î–Ω—Ç—É
    await bot.send_message(
        client_id,
        f"‚úÖ –¶—ñ–Ω—É –ø—ñ–¥–≤–∏—â–µ–Ω–æ!\n"
        f"üí∞ –ù–æ–≤–∞ –≤–∞—Ä—Ç—ñ—Å—Ç—å: {new_fare} –≥—Ä–Ω\n"
        f"üîç –ü—Ä–æ–¥–æ–≤–∂—É—î–º–æ –ø–æ—à—É–∫..."
    )
```

---

## üìä –ü–†–ò–ö–õ–ê–î –†–û–ë–û–¢–ò

### –¢–∞–π–º–ª–∞–π–Ω –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è:

```
00:00 - –ö–ª—ñ—î–Ω—Ç —Å—Ç–≤–æ—Ä—é—î –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è
        –¶—ñ–Ω–∞: 120 –≥—Ä–Ω
        –ì—Ä—É–ø–∞: "üîî –ù–û–í–ï –ó–ê–ú–û–í–õ–ï–ù–ù–Ø #123"
        
03:00 - ‚è∞ TIMEOUT #1
        –ö–ª—ñ—î–Ω—Ç: "‚è∞ –®—É–∫–∞—î–º–æ 3 —Ö–≤... –ü—ñ–¥–≤–∏—â—Ç–µ —Ü—ñ–Ω—É?"
        –ì—Ä—É–ø–∞: "üî¥ –¢–ï–†–ú–Ü–ù–û–í–ï! –ß–µ–∫–∞—î 3+ —Ö–≤"
        
03:30 - –ö–ª—ñ—î–Ω—Ç –Ω–∞—Ç–∏—Å–∫–∞—î "+30 –≥—Ä–Ω"
        –¶—ñ–Ω–∞: 120 ‚Üí 150 –≥—Ä–Ω ‚úÖ
        –ì—Ä—É–ø–∞: "üí∞ –¶–Ü–ù–£ –ü–Ü–î–í–ò–©–ï–ù–û! 150 –≥—Ä–Ω"
        
04:00 - –í–æ–¥—ñ–π –ø—Ä–∏–π–º–∞—î (–±–∞—á–∏—Ç—å 150 –≥—Ä–Ω)
        ‚úÖ –ó–∞–º–æ–≤–ª–µ–Ω–Ω—è –ø—Ä–∏–π–Ω—è—Ç–æ!
```

---

### –ü—Ä–∏–∫–ª–∞–¥ –±–µ–∑ –ø—ñ–¥–≤–∏—â–µ–Ω–Ω—è:

```
00:00 - –°—Ç–≤–æ—Ä–µ–Ω–Ω—è (120 –≥—Ä–Ω)
03:00 - TIMEOUT #1 ‚Üí –ü—Ä–æ–ø–æ–∑–∏—Ü—ñ—è –ø—ñ–¥–Ω—è—Ç–∏
        –ö–ª—ñ—î–Ω—Ç: –Ω–µ –Ω–∞—Ç–∏—Å–∫–∞—î
06:00 - TIMEOUT #2 ‚Üí –ü—Ä–æ–ø–æ–∑–∏—Ü—ñ—è –∑–Ω–æ–≤—É
        –ö–ª—ñ—î–Ω—Ç: –Ω–µ –Ω–∞—Ç–∏—Å–∫–∞—î
09:00 - TIMEOUT #3 ‚Üí –ü—Ä–æ–ø–æ–∑–∏—Ü—ñ—è –∑–Ω–æ–≤—É
        –ö–ª—ñ—î–Ω—Ç: –Ω–∞—Ç–∏—Å–∫–∞—î "‚ùå –°–∫–∞—Å—É–≤–∞—Ç–∏"
        ‚ùå –ó–∞–º–æ–≤–ª–µ–Ω–Ω—è —Å–∫–∞—Å–æ–≤–∞–Ω–æ
```

---

## üé® UI/UX

### –ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –∫–ª—ñ—î–Ω—Ç—É:

```
‚è∞ –®—É–∫–∞—î–º–æ –≤–æ–¥—ñ—è –≤–∂–µ 3 —Ö–≤–∏–ª–∏–Ω–∏...

–ù–∞ –∂–∞–ª—å, –≤—Å—ñ –≤–æ–¥—ñ—ó –∑–∞—Ä–∞–∑ –∑–∞–π–Ω—è—Ç—ñ.

üí∞ –ü–æ—Ç–æ—á–Ω–∞ —Ü—ñ–Ω–∞: 120 –≥—Ä–Ω

üí° –ü—ñ–¥–≤–∏—â—Ç–µ —Ü—ñ–Ω—É —â–æ–± —à–≤–∏–¥—à–µ –∑–Ω–∞–π—Ç–∏ –≤–æ–¥—ñ—è:

–í–æ–¥—ñ—ó —á–∞—Å—Ç—ñ—à–µ –ø—Ä–∏–π–º–∞—é—Ç—å –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è –∑ –≤–∏—â–æ—é —Ü—ñ–Ω–æ—é.

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ üíµ +15 –≥—Ä–Ω  ‚îÇ üíµ +30 –≥—Ä–Ω  ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ      üíµ +50 –≥—Ä–Ω            ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ   ‚ùå –°–∫–∞—Å—É–≤–∞—Ç–∏ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

### –ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –≤ –≥—Ä—É–ø—ñ (–ø—ñ—Å–ª—è –ø—ñ–¥–≤–∏—â–µ–Ω–Ω—è):

```
üí∞ –¶–Ü–ù–£ –ü–Ü–î–í–ò–©–ï–ù–û! –ó–ê–ú–û–í–õ–ï–ù–ù–Ø #123
‚¨ÜÔ∏è +30 –≥—Ä–Ω –¥–æ —Ü—ñ–Ω–∏!

üèô –ú—ñ—Å—Ç–æ: –ö–∏—ó–≤
üöó –ö–ª–∞—Å: –ö–æ–º—Ñ–æ—Ä—Ç
üë§ –ö–ª—ñ—î–Ω—Ç: –Ü–≤–∞–Ω
üì± –¢–µ–ª–µ—Ñ–æ–Ω: +38050***67 üîí

üìç –ó–≤—ñ–¥–∫–∏: –≤—É–ª. –•—Ä–µ—â–∞—Ç–∏–∫, 1, –ö–∏—ó–≤
üìç –ö—É–¥–∏: –≤—É–ª. –®–µ–≤—á–µ–Ω–∫–∞, 10, –ö–∏—ó–≤
üìè –í—ñ–¥—Å—Ç–∞–Ω—å: 3.5 –∫–º

üí∞ –ù–æ–≤–∞ –≤–∞—Ä—Ç—ñ—Å—Ç—å: 150 –≥—Ä–Ω üí∞
üí¨ –ö–æ–º–µ–Ω—Ç–∞—Ä: ‚Äî

‚ö†Ô∏è –ö–ª—ñ—î–Ω—Ç –≥–æ—Ç–æ–≤–∏–π –ø–ª–∞—Ç–∏—Ç–∏ –±—ñ–ª—å—à–µ!
‚ÑπÔ∏è –ü–æ–≤–Ω–∏–π –Ω–æ–º–µ—Ä –ø—ñ—Å–ª—è –ø—Ä–∏–π–Ω—è—Ç—Ç—è

[‚úÖ –ü—Ä–∏–π–Ω—è—Ç–∏ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è]
```

---

## ‚è±Ô∏è –¢–ê–ô–ú–õ–ê–ô–ù

### –ü–µ—Ä—à—ñ 3 —Ö–≤–∏–ª–∏–Ω–∏:

```
00:00 - üì§ –ó–∞–º–æ–≤–ª–µ–Ω–Ω—è –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ
00:01 - üîç –®—É–∫–∞—î–º–æ –≤–æ–¥—ñ—è...
00:30 - üîç –í—Å–µ —â–µ —à—É–∫–∞—î–º–æ...
01:00 - üîç –í—Å–µ —â–µ —à—É–∫–∞—î–º–æ...
02:00 - üîç –í—Å–µ —â–µ —à—É–∫–∞—î–º–æ...
03:00 - ‚è∞ TIMEOUT #1
        üì® –ü—Ä–æ–ø–æ–∑–∏—Ü—ñ—è –ø—ñ–¥–Ω—è—Ç–∏ —Ü—ñ–Ω—É
```

---

### –ü—ñ—Å–ª—è –ø—ñ–¥–≤–∏—â–µ–Ω–Ω—è:

```
03:30 - üí∞ –ö–ª—ñ—î–Ω—Ç –ø—ñ–¥–≤–∏—â—É—î –Ω–∞ +30 –≥—Ä–Ω
        üìä –¶—ñ–Ω–∞: 120 ‚Üí 150 –≥—Ä–Ω
        üì§ –ì—Ä—É–ø–∞ –æ–Ω–æ–≤–ª–µ–Ω–∞: "–¶–Ü–ù–£ –ü–Ü–î–í–ò–©–ï–ù–û!"
        
03:45 - üöó –í–æ–¥—ñ–π –±–∞—á–∏—Ç—å 150 –≥—Ä–Ω
        ‚úÖ –í–æ–¥—ñ–π –ø—Ä–∏–π–º–∞—î!
        
        ‚úÖ –ó–ê–ú–û–í–õ–ï–ù–ù–Ø –ü–†–ò–ô–ù–Ø–¢–û!
```

---

### –Ø–∫—â–æ –Ω—ñ—Ö—Ç–æ –Ω–µ –ø—Ä–∏–π–º–∞—î –¥–∞–ª—ñ:

```
06:00 - ‚è∞ TIMEOUT #2
        üì® "–®—É–∫–∞—î–º–æ –≤–∂–µ 6 —Ö–≤–∏–ª–∏–Ω... –¶—ñ–Ω–∞: 150 –≥—Ä–Ω"
        üí° –ü—Ä–æ–ø–æ–∑–∏—Ü—ñ—è –ø—ñ–¥–Ω—è—Ç–∏ —â–µ
        
09:00 - ‚è∞ TIMEOUT #3
        üì® "–®—É–∫–∞—î–º–æ –≤–∂–µ 9 —Ö–≤–∏–ª–∏–Ω... –¶—ñ–Ω–∞: 150 –≥—Ä–Ω"
        üí° –ü—Ä–æ–ø–æ–∑–∏—Ü—ñ—è –ø—ñ–¥–Ω—è—Ç–∏ —â–µ
        
–Ü —Ç–∞–∫ –¥–∞–ª—ñ –∫–æ–∂–Ω—ñ 3 —Ö–≤–∏–ª–∏–Ω–∏...
```

---

## üîß –¢–ï–•–ù–Ü–ß–ù–Ü –î–ï–¢–ê–õ–Ü

### –ë–∞–∑–∞ –¥–∞–Ω–∏—Ö:

**–¢–∞–±–ª–∏—Ü—è:** `orders`

**–û–Ω–æ–≤–ª—é—î—Ç—å—Å—è –ø–æ–ª–µ:** `fare_amount`

```sql
-- –ë—É–ª–æ
fare_amount = 120.0

-- –ü—ñ—Å–ª—è –ø—ñ–¥–≤–∏—â–µ–Ω–Ω—è –Ω–∞ +30
UPDATE orders SET fare_amount = 150.0 WHERE id = 123;

-- –°—Ç–∞–ª–æ
fare_amount = 150.0
```

---

### –õ—ñ—á–∏–ª—å–Ω–∏–∫ —Ç–∞–π–º–∞—É—Ç—ñ–≤:

```python
class OrderTimeoutManager:
    def __init__(self):
        self._timeout_count: Dict[int, int] = {}
    
    async def _timeout_handler(...):
        # –ü—ñ–¥—Ä–∞—Ö—É–≤–∞—Ç–∏
        if order_id not in self._timeout_count:
            self._timeout_count[order_id] = 0
        self._timeout_count[order_id] += 1
        
        timeout_count = self._timeout_count[order_id]  # 1, 2, 3...
        
        # –ü–æ–∫–∞–∑–∞—Ç–∏ –∫–ª—ñ—î–Ω—Ç—É —Å–∫—ñ–ª—å–∫–∏ —Ö–≤–∏–ª–∏–Ω —á–µ–∫–∞—î
        await bot.send_message(
            user_id,
            f"–®—É–∫–∞—î–º–æ –≤–∂–µ {timeout_count * 3} —Ö–≤–∏–ª–∏–Ω..."
        )
```

---

### Callback handlers:

**1. –ü—ñ–¥–≤–∏—â–µ–Ω–Ω—è —Ü—ñ–Ω–∏:**
```python
@router.callback_query(F.data.startswith("increase_price:"))
async def increase_price_handler(call: CallbackQuery):
    # increase_price:123:30
    order_id = 123
    amount = 30
    
    # –û–Ω–æ–≤–∏—Ç–∏ –ë–î
    await increase_order_fare(db, order_id, amount)
    
    # –í–∏–¥–∞–ª–∏—Ç–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
    await call.message.delete()
    
    # –û–Ω–æ–≤–∏—Ç–∏ –≥—Ä—É–ø—É
    await bot.edit_message_text(chat_id=group_id, ...)
    
    # –ü—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è –∫–ª—ñ—î–Ω—Ç—É
    await bot.send_message(user_id, "‚úÖ –¶—ñ–Ω—É –ø—ñ–¥–≤–∏—â–µ–Ω–æ!")
```

**2. –°–∫–∞—Å—É–≤–∞–Ω–Ω—è:**
```python
@router.callback_query(F.data.startswith("cancel_waiting_order:"))
async def cancel_waiting_order_handler(call: CallbackQuery):
    # –°–∫–∞—Å—É–≤–∞—Ç–∏ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è
    await cancel_order_by_client(db, order_id)
    
    # –°–∫–∞—Å—É–≤–∞—Ç–∏ —Ç–∞–π–º–µ—Ä
    cancel_order_timeout(order_id)
    
    # –í–∏–¥–∞–ª–∏—Ç–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
    await call.message.delete()
    
    # –û–Ω–æ–≤–∏—Ç–∏ –≥—Ä—É–ø—É
    await bot.edit_message_text(group_id, "‚ùå –°–ö–ê–°–û–í–ê–ù–û")
```

---

## üìà –ü–ï–†–ï–í–ê–ì–ò

### –î–ª—è –∫–ª—ñ—î–Ω—Ç—ñ–≤:

‚úÖ **–ö–æ–Ω—Ç—Ä–æ–ª—å –Ω–∞–¥ —Ü—ñ–Ω–æ—é** - –º–æ–∂–Ω–∞ –ø—ñ–¥–Ω—è—Ç–∏ —è–∫—â–æ —Ç–µ—Ä–º—ñ–Ω–æ–≤–æ  
‚úÖ **–®–≤–∏–¥—à–µ –∑–Ω–∞—Ö–æ–¥—è—Ç—å –≤–æ–¥—ñ—è** - –≤–∏—â–∞ —Ü—ñ–Ω–∞ = –±—ñ–ª—å—à–µ –≤–æ–¥—ñ—ó–≤  
‚úÖ **–ü—Ä–æ–∑–æ—Ä—ñ—Å—Ç—å** - –±–∞—á–∞—Ç—å —Å–∫—ñ–ª—å–∫–∏ –≤–∂–µ —á–µ–∫–∞—é—Ç—å  
‚úÖ **–í–∏–±—ñ—Ä** - –º–æ–∂–Ω–∞ –Ω–µ –ø—ñ–¥–≤–∏—â—É–≤–∞—Ç–∏ —ñ —á–µ–∫–∞—Ç–∏  
‚úÖ **–ß–∏—Å—Ç–∏–π —á–∞—Ç** - –≤–∏–¥–∞–ª—è—é—Ç—å—Å—è –∑–∞–π–≤—ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è  

---

### –î–ª—è –≤–æ–¥—ñ—ó–≤:

‚úÖ **–ë–∞—á–∞—Ç—å –≤–∏—â—É —Ü—ñ–Ω—É** - –º–æ—Ç–∏–≤–∞—Ü—ñ—è –ø—Ä–∏–π–Ω—è—Ç–∏  
‚úÖ **–ó–Ω–∞—é—Ç—å —â–æ –∫–ª—ñ—î–Ω—Ç —á–µ–∫–∞—î** - —Ç–µ—Ä–º—ñ–Ω–æ–≤–µ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è  
‚úÖ **–ß—ñ—Ç–∫–∞ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è** - "–ö–ª—ñ—î–Ω—Ç –≥–æ—Ç–æ–≤–∏–π –ø–ª–∞—Ç–∏—Ç–∏ –±—ñ–ª—å—à–µ"  

---

### –î–ª—è –±—ñ–∑–Ω–µ—Å—É:

‚úÖ **–î–∏–Ω–∞–º—ñ—á–Ω–µ —Ü—ñ–Ω–æ—É—Ç–≤–æ—Ä–µ–Ω–Ω—è** - —Ä–∏–Ω–∫–æ–≤–∞ —Ü—ñ–Ω–∞  
‚úÖ **–ú–µ–Ω—à–µ —Å–∫–∞—Å—É–≤–∞–Ω—å** - –∫–ª—ñ—î–Ω—Ç–∏ –º–æ–∂—É—Ç—å –ø—ñ–¥–Ω—è—Ç–∏ —Ü—ñ–Ω—É –∑–∞–º—ñ—Å—Ç—å —Å–∫–∞—Å—É–≤–∞–Ω–Ω—è  
‚úÖ **–í–∏—â–∏–π –ø—Ä–∏–π–æ–º** - –≤–æ–¥—ñ—ó –±–∞—á–∞—Ç—å –≤–∏—â—É —Ü—ñ–Ω—É  
‚úÖ **–ö—Ä–∞—â–∏–π —Å–µ—Ä–≤—ñ—Å** - –∫–ª—ñ—î–Ω—Ç–∏ —à–≤–∏–¥—à–µ –æ—Ç—Ä–∏–º—É—é—Ç—å —Ç–∞–∫—Å—ñ  

---

## üß™ –¢–ï–°–¢–£–í–ê–ù–ù–Ø

### –¢–µ—Å—Ç 1: –ü—ñ–¥–≤–∏—â–µ–Ω–Ω—è –Ω–∞ +15 –≥—Ä–Ω

**–î—ñ—ó:**
1. –°—Ç–≤–æ—Ä–∏—Ç–∏ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è (120 –≥—Ä–Ω)
2. –ß–µ–∫–∞—Ç–∏ 3 —Ö–≤–∏–ª–∏–Ω–∏
3. –ù–∞—Ç–∏—Å–Ω—É—Ç–∏ "+15 –≥—Ä–Ω"

**–û—á—ñ–∫—É–≤–∞–Ω–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
- ‚úÖ –ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –≤–∏–¥–∞–ª–µ–Ω–æ
- ‚úÖ –ë–î: fare_amount = 135 –≥—Ä–Ω
- ‚úÖ –ì—Ä—É–ø–∞: "–¶–Ü–ù–£ –ü–Ü–î–í–ò–©–ï–ù–û! 135 –≥—Ä–Ω"
- ‚úÖ –ö–ª—ñ—î–Ω—Ç: "‚úÖ –¶—ñ–Ω—É –ø—ñ–¥–≤–∏—â–µ–Ω–æ! 135 –≥—Ä–Ω"

---

### –¢–µ—Å—Ç 2: –ü—ñ–¥–≤–∏—â–µ–Ω–Ω—è –¥–µ–∫—ñ–ª—å–∫–∞ —Ä–∞–∑—ñ–≤

**–î—ñ—ó:**
1. –°—Ç–≤–æ—Ä–∏—Ç–∏ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è (120 –≥—Ä–Ω)
2. +3 —Ö–≤ ‚Üí –ü—ñ–¥–Ω—è—Ç–∏ +30 –≥—Ä–Ω ‚Üí 150 –≥—Ä–Ω
3. +3 —Ö–≤ ‚Üí –ü—ñ–¥–Ω—è—Ç–∏ +50 –≥—Ä–Ω ‚Üí 200 –≥—Ä–Ω

**–û—á—ñ–∫—É–≤–∞–Ω–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
- ‚úÖ –ü—ñ—Å–ª—è –ø–µ—Ä—à–æ–≥–æ: 150 –≥—Ä–Ω
- ‚úÖ –ü—ñ—Å–ª—è –¥—Ä—É–≥–æ–≥–æ: 200 –≥—Ä–Ω
- ‚úÖ –ì—Ä—É–ø–∞ –æ–Ω–æ–≤–ª—é—î—Ç—å—Å—è –æ–±–∏–¥–≤–∞ —Ä–∞–∑–∏

---

### –¢–µ—Å—Ç 3: –°–∫–∞—Å—É–≤–∞–Ω–Ω—è –ø—ñ–¥ —á–∞—Å –æ—á—ñ–∫—É–≤–∞–Ω–Ω—è

**–î—ñ—ó:**
1. –°—Ç–≤–æ—Ä–∏—Ç–∏ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è (120 –≥—Ä–Ω)
2. +3 —Ö–≤ ‚Üí –û—Ç—Ä–∏–º–∞—Ç–∏ –ø—Ä–æ–ø–æ–∑–∏—Ü—ñ—é
3. –ù–∞—Ç–∏—Å–Ω—É—Ç–∏ "‚ùå –°–∫–∞—Å—É–≤–∞—Ç–∏"

**–û—á—ñ–∫—É–≤–∞–Ω–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
- ‚úÖ –ó–∞–º–æ–≤–ª–µ–Ω–Ω—è —Å–∫–∞—Å–æ–≤–∞–Ω–æ
- ‚úÖ –¢–∞–π–º–µ—Ä –∑—É–ø–∏–Ω–µ–Ω–æ
- ‚úÖ –ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –≤–∏–¥–∞–ª–µ–Ω–æ
- ‚úÖ –ì—Ä—É–ø–∞: "‚ùå –°–ö–ê–°–û–í–ê–ù–û"

---

## üìä –°–¢–ê–¢–ò–°–¢–ò–ö–ê (–ü–†–û–ì–ù–û–ó)

### –î–æ —Å–∏—Å—Ç–µ–º–∏ –ø—ñ–¥–≤–∏—â–µ–Ω–Ω—è —Ü—ñ–Ω–∏:
```
–ó–∞–º–æ–≤–ª–µ–Ω–Ω—è —Å—Ç–≤–æ—Ä–µ–Ω–æ: 100
–ù–µ –ø—Ä–∏–π–Ω—è—Ç–æ (—Å–∫–∞—Å–æ–≤–∞–Ω–æ): 20 (20%) ‚ùå
–°–µ—Ä–µ–¥–Ω—ñ–π —á–∞—Å –æ—á—ñ–∫—É–≤–∞–Ω–Ω—è: 8 —Ö–≤–∏–ª–∏–Ω
```

### –ü—ñ—Å–ª—è —Å–∏—Å—Ç–µ–º–∏:
```
–ó–∞–º–æ–≤–ª–µ–Ω–Ω—è —Å—Ç–≤–æ—Ä–µ–Ω–æ: 100
–ü—ñ–¥–≤–∏—â–∏–ª–∏ —Ü—ñ–Ω—É: 15 (15%)
  ‚Üí –ü—Ä–∏–π–Ω—è—Ç–æ –ø—ñ—Å–ª—è –ø—ñ–¥–≤–∏—â–µ–Ω–Ω—è: 14 (93%) ‚úÖ
  
–ù–µ –ø—Ä–∏–π–Ω—è—Ç–æ (—Å–∫–∞—Å–æ–≤–∞–Ω–æ): 6 (6%) ‚úÖ
–°–µ—Ä–µ–¥–Ω—ñ–π —á–∞—Å –æ—á—ñ–∫—É–≤–∞–Ω–Ω—è: 4 —Ö–≤–∏–ª–∏–Ω–∏ ‚úÖ
```

**–ü–æ–∫—Ä–∞—â–µ–Ω–Ω—è:**
- üìâ -70% —Å–∫–∞—Å—É–≤–∞–Ω—å (20% ‚Üí 6%)
- ‚è±Ô∏è -50% —á–∞—Å –æ—á—ñ–∫—É–≤–∞–Ω–Ω—è (8 ‚Üí 4 —Ö–≤)
- üí∞ +15% —Å–µ—Ä–µ–¥–Ω—è —Ü—ñ–Ω–∞ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è (–¥–æ–¥–∞—Ç–∫–æ–≤–∏–π –¥–æ—Ö—ñ–¥)

---

## üéâ –†–ï–ó–£–õ–¨–¢–ê–¢

### –ë—É–ª–æ:
```
‚ùå –§—ñ–∫—Å–æ–≤–∞–Ω–∞ —Ü—ñ–Ω–∞
‚ùå –ö–ª—ñ—î–Ω—Ç —á–µ–∫–∞—î –¥–æ–≤–≥–æ
‚ùå –ë–∞–≥–∞—Ç–æ —Å–∫–∞—Å—É–≤–∞–Ω—å
‚ùå –ù–∏–∑—å–∫–∞ –ø—Ä–∏–π–Ω—è—Ç–Ω—ñ—Å—Ç—å
‚ùå 2 –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –ø—ñ—Å–ª—è –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è
```

### –°—Ç–∞–ª–æ:
```
‚úÖ –î–∏–Ω–∞–º—ñ—á–Ω–∞ —Ü—ñ–Ω–∞ (–∫–ª—ñ—î–Ω—Ç –∫–æ–Ω—Ç—Ä–æ–ª—é—î)
‚úÖ –®–≤–∏–¥—à–µ –∑–Ω–∞—Ö–æ–¥—è—Ç—å –≤–æ–¥—ñ—è
‚úÖ –ú–µ–Ω—à–µ —Å–∫–∞—Å—É–≤–∞–Ω—å (-70%)
‚úÖ –í–∏—â–∞ –ø—Ä–∏–π–Ω—è—Ç–Ω—ñ—Å—Ç—å (+93% –ø—ñ—Å–ª—è –ø—ñ–¥–≤–∏—â–µ–Ω–Ω—è)
‚úÖ 1 –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –ø—ñ—Å–ª—è –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è
‚úÖ –ö–æ–∂–Ω—ñ 3 —Ö–≤ –Ω–æ–≤–∞ –ø—Ä–æ–ø–æ–∑–∏—Ü—ñ—è
‚úÖ –û–Ω–æ–≤–ª–µ–Ω–Ω—è –≤ –≥—Ä—É–ø—ñ –∑ –Ω–æ–≤–æ—é —Ü—ñ–Ω–æ—é
```

---

**–°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞! –¢–µ–ø–µ—Ä –∫–ª—ñ—î–Ω—Ç–∏ –º–æ–∂—É—Ç—å –ø—ñ–¥–≤–∏—â—É–≤–∞—Ç–∏ —Ü—ñ–Ω—É!** üí∞‚úÖüöÄ
