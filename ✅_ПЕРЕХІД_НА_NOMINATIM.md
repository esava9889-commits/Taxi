# ‚úÖ –ü–ï–†–ï–•–Ü–î –ù–ê NOMINATIM (OpenStreetMap)

**–î–∞—Ç–∞:** 2025-10-23  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ì–û–¢–û–í–û

---

## üéØ –©–û –ó–ú–Ü–ù–ò–õ–û–°–¨:

### ‚ùå –ë–£–õ–û: Google Maps API (–ø–ª–∞—Ç–Ω–∏–π)
- –ü–æ—Ç—Ä—ñ–±–µ–Ω –±—ñ–ª–ª—ñ–Ω–≥ –∞–∫–∞—É–Ω—Ç
- –ü–æ—Ç—Ä—ñ–±–Ω–∞ –∫—Ä–µ–¥–∏—Ç–Ω–∞ –∫–∞—Ä—Ç–∞
- $200 –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è ‚Üí –ø–æ—Ç—ñ–º –ø–ª–∞—Ç–∏—Ç–∏
- API –∫–ª—é—á –æ–±–æ–≤'—è–∑–∫–æ–≤–∏–π

### ‚úÖ –°–¢–ê–õ–û: Nominatim + OSRM (–±–µ–∑–∫–æ—à—Ç–æ–≤–Ω–æ!)
- **Nominatim** (OpenStreetMap) - –≥–µ–æ–∫–æ–¥—É–≤–∞–Ω–Ω—è
- **OSRM** (Open Source Routing Machine) - –º–∞—Ä—à—Ä—É—Ç–∏
- –ü–æ–≤–Ω—ñ—Å—Ç—é –±–µ–∑–∫–æ—à—Ç–æ–≤–Ω–æ
- –ë–µ–∑ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó —Ç–∞ API –∫–ª—é—á—ñ–≤
- –ë–µ–∑ –æ–±–º–µ–∂–µ–Ω—å –Ω–∞ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è (–∑ —Ä–æ–∑—É–º–Ω–∏–º–∏ –∑–∞—Ç—Ä–∏–º–∫–∞–º–∏)

---

## üìÅ –ó–ú–Ü–ù–ï–ù–Ü –§–ê–ô–õ–ò:

### 1. `app/utils/maps.py` - –ü–û–í–ù–Ü–°–¢–Æ –ü–ï–†–ï–ü–ò–°–ê–ù–û

**–ó–∞–º—ñ–Ω–µ–Ω—ñ —Ñ—É–Ω–∫—Ü—ñ—ó:**

#### `geocode_address()` - –ê–¥—Ä–µ—Å–∞ ‚Üí –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏
```python
# –ë–£–õ–û: Google Geocoding API
# –°–¢–ê–õ–û: Nominatim API
https://nominatim.openstreetmap.org/search
```

#### `reverse_geocode()` - –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏ ‚Üí –ê–¥—Ä–µ—Å–∞  
```python
# –ë–£–õ–û: Google Reverse Geocoding API
# –°–¢–ê–õ–û: Nominatim Reverse API
https://nominatim.openstreetmap.org/reverse
```

#### `get_distance_and_duration()` - –†–æ–∑—Ä–∞—Ö—É–Ω–æ–∫ –º–∞—Ä—à—Ä—É—Ç—É
```python
# –ë–£–õ–û: Google Distance Matrix API
# –°–¢–ê–õ–û: OSRM Routing API
http://router.project-osrm.org/route/v1/driving
```

#### `generate_static_map_url()` - –°—Ç–∞—Ç–∏—á–Ω–∞ –∫–∞—Ä—Ç–∞
```python
# –ë–£–õ–û: Google Static Maps API
# –°–¢–ê–õ–û: OpenStreetMap StaticMap
https://staticmap.openstreetmap.de/staticmap.php
```

---

### 2. `app/handlers/order.py` - –û–ù–û–í–õ–ï–ù–û

**–ó–º—ñ–Ω–∏:**
- ‚úÖ –í–∏–¥–∞–ª–µ–Ω–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ `config.google_maps_api_key`
- ‚úÖ –í—Å—ñ –≤–∏–∫–ª–∏–∫–∏ API —Ç–µ–ø–µ—Ä –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—Ç—å Nominatim/OSRM
- ‚úÖ –ü–µ—Ä–µ–¥–∞—î—Ç—å—Å—è –ø–æ—Ä–æ–∂–Ω—ñ–π —Ä—è–¥–æ–∫ –∑–∞–º—ñ—Å—Ç—å api_key (—Å—É–º—ñ—Å–Ω—ñ—Å—Ç—å)
- ‚úÖ –û–Ω–æ–≤–ª–µ–Ω—ñ –ª–æ–≥–∏ (Google Maps ‚Üí Nominatim/OSRM)

---

## üåü –ü–ï–†–ï–í–ê–ì–ò NOMINATIM:

### 1. –ë–µ–∑–∫–æ—à—Ç–æ–≤–Ω–æ
- ‚úÖ –ë–µ–∑ –∫—Ä–µ–¥–∏—Ç–Ω–æ—ó –∫–∞—Ä—Ç–∏
- ‚úÖ –ë–µ–∑ –±—ñ–ª–ª—ñ–Ω–≥ –∞–∫–∞—É–Ω—Ç—É
- ‚úÖ –ë–µ–∑ –æ–±–º–µ–∂–µ–Ω—å –Ω–∞ –∑–∞–ø–∏—Ç–∏ (–ø—Ä–∏ –¥–æ—Ç—Ä–∏–º–∞–Ω–Ω—ñ –ø—Ä–∞–≤–∏–ª)

### 2. –Ø–∫—ñ—Å—Ç—å –¥–∞–Ω–∏—Ö
- ‚úÖ OpenStreetMap - –Ω–∞–π–±—ñ–ª—å—à–∞ –≤—ñ–¥–∫—Ä–∏—Ç–∞ –∫–∞—Ä—Ç–∞ —Å–≤—ñ—Ç—É
- ‚úÖ –ê–∫—Ç—É–∞–ª—å–Ω—ñ –¥–∞–Ω—ñ (–æ–Ω–æ–≤–ª—é—é—Ç—å—Å—è —Å–ø—ñ–ª—å–Ω–æ—Ç–æ—é)
- ‚úÖ –ß—É–¥–æ–≤–∞ –ø—ñ–¥—Ç—Ä–∏–º–∫–∞ –£–∫—Ä–∞—ó–Ω–∏ —Ç–∞ –Ñ–≤—Ä–æ–ø–∏

### 3. –®–≤–∏–¥–∫—ñ—Å—Ç—å
- ‚úÖ OSRM –ø—Ä–∞—Ü—é—î —à–≤–∏–¥–∫–æ
- ‚úÖ Nominatim –ø–æ–≤–µ—Ä—Ç–∞—î —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∏ –∑–∞ 1-2 —Å–µ–∫—É–Ω–¥–∏
- ‚úÖ –ó–∞—Ç—Ä–∏–º–∫–∞ –º—ñ–∂ –∑–∞–ø–∏—Ç–∞–º–∏ 1 —Å–µ–∫ (–ø—Ä–∞–≤–∏–ª–∞ Nominatim)

### 4. –ù–∞–¥—ñ–π–Ω—ñ—Å—Ç—å
- ‚úÖ –ü—É–±–ª—ñ—á–Ω—ñ —Å–µ—Ä–≤–µ—Ä–∏ OpenStreetMap
- ‚úÖ –í–∏—Å–æ–∫–∏–π uptime
- ‚úÖ Backup –≤–∞—Ä—ñ–∞–Ω—Ç–∏ (–º–æ–∂–Ω–∞ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞—Ç–∏ –≤–ª–∞—Å–Ω–∏–π Nominatim —Å–µ—Ä–≤–µ—Ä)

---

## ‚öôÔ∏è –¢–ï–•–ù–Ü–ß–ù–Ü –î–ï–¢–ê–õ–Ü:

### Nominatim - Geocoding (–∞–¥—Ä–µ—Å–∞ ‚Üí –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏)

**API Endpoint:**
```
https://nominatim.openstreetmap.org/search
```

**–ü–∞—Ä–∞–º–µ—Ç—Ä–∏:**
- `q` - –∞–¥—Ä–µ—Å–∞ –¥–ª—è –ø–æ—à—É–∫—É
- `format=json` - —Ñ–æ—Ä–º–∞—Ç –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ
- `limit=1` - –∫—ñ–ª—å–∫—ñ—Å—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ñ–≤
- `addressdetails=1` - –¥–µ—Ç–∞–ª—ñ –∞–¥—Ä–µ—Å–∏

**–ü—Ä–∏–∫–ª–∞–¥:**
```
https://nominatim.openstreetmap.org/search?q=–≤—É–ª.+–•—Ä–µ—â–∞—Ç–∏–∫+1+–ö–∏—ó–≤&format=json
```

**–í—ñ–¥–ø–æ–≤—ñ–¥—å:**
```json
[{
  "lat": "50.4501",
  "lon": "30.5234",
  "display_name": "–≤—É–ª. –•—Ä–µ—â–∞—Ç–∏–∫, 1, –ö–∏—ó–≤, –£–∫—Ä–∞—ó–Ω–∞"
}]
```

---

### Nominatim - Reverse Geocoding (–∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏ ‚Üí –∞–¥—Ä–µ—Å–∞)

**API Endpoint:**
```
https://nominatim.openstreetmap.org/reverse
```

**–ü–∞—Ä–∞–º–µ—Ç—Ä–∏:**
- `lat` - —à–∏—Ä–æ—Ç–∞
- `lon` - –¥–æ–≤–≥–æ—Ç–∞
- `format=json` - —Ñ–æ—Ä–º–∞—Ç –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ
- `addressdetails=1` - —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–≤–∞–Ω–∞ –∞–¥—Ä–µ—Å–∞
- `accept-language=uk` - —É–∫—Ä–∞—ó–Ω—Å—å–∫–∞ –º–æ–≤–∞

**–ü—Ä–∏–∫–ª–∞–¥:**
```
https://nominatim.openstreetmap.org/reverse?lat=50.4501&lon=30.5234&format=json
```

**–í—ñ–¥–ø–æ–≤—ñ–¥—å:**
```json
{
  "display_name": "–≤—É–ª. –•—Ä–µ—â–∞—Ç–∏–∫, 1, –ö–∏—ó–≤, –£–∫—Ä–∞—ó–Ω–∞",
  "address": {
    "road": "–≤—É–ª. –•—Ä–µ—â–∞—Ç–∏–∫",
    "house_number": "1",
    "city": "–ö–∏—ó–≤",
    "country": "–£–∫—Ä–∞—ó–Ω–∞"
  }
}
```

---

### OSRM - –ú–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü—ñ—è (–≤—ñ–¥—Å—Ç–∞–Ω—å —Ç–∞ —á–∞—Å)

**API Endpoint:**
```
http://router.project-osrm.org/route/v1/driving
```

**–§–æ—Ä–º–∞—Ç:**
```
/{lon1},{lat1};{lon2},{lat2}?overview=false
```

**–ü—Ä–∏–∫–ª–∞–¥:**
```
http://router.project-osrm.org/route/v1/driving/30.5234,50.4501;30.6234,50.5501
```

**–í—ñ–¥–ø–æ–≤—ñ–¥—å:**
```json
{
  "code": "Ok",
  "routes": [{
    "distance": 5234.5,  // –º–µ—Ç—Ä–∏
    "duration": 720.2    // —Å–µ–∫—É–Ω–¥–∏
  }]
}
```

---

## ‚ö†Ô∏è –ü–†–ê–í–ò–õ–ê –í–ò–ö–û–†–ò–°–¢–ê–ù–ù–Ø NOMINATIM:

### 1. User-Agent (–û–ë–û–í'–Ø–ó–ö–û–í–û!)
```python
headers = {
    'User-Agent': 'TaxiBot/1.0 (Ukrainian Taxi Service)'
}
```

### 2. –ó–∞—Ç—Ä–∏–º–∫–∞ –º—ñ–∂ –∑–∞–ø–∏—Ç–∞–º–∏
- –ú—ñ–Ω—ñ–º—É–º **1 —Å–µ–∫—É–Ω–¥–∞** –º—ñ–∂ –∑–∞–ø–∏—Ç–∞–º–∏
- –†–µ–∞–ª—ñ–∑–æ–≤–∞–Ω–æ —á–µ—Ä–µ–∑ `_wait_for_nominatim()`

### 3. –õ—ñ–º—ñ—Ç –∑–∞–ø–∏—Ç—ñ–≤
- –ú–∞–∫—Å–∏–º—É–º 1 –∑–∞–ø–∏—Ç/—Å–µ–∫—É–Ω–¥—É
- –î–ª—è –±—ñ–ª—å—à–æ–≥–æ –Ω–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è - –≤–∏–∫–æ—Ä–∏—Å—Ç–∞—Ç–∏ –≤–ª–∞—Å–Ω–∏–π Nominatim —Å–µ—Ä–≤–µ—Ä

---

## üß™ –¢–ï–°–¢–£–í–ê–ù–ù–Ø:

### –¢–µ—Å—Ç 1: –ì–µ–æ–∫–æ–¥—É–≤–∞–Ω–Ω—è –∞–¥—Ä–µ—Å–∏
```python
from app.utils.maps import geocode_address

coords = await geocode_address("", "–≤—É–ª. –•—Ä–µ—â–∞—Ç–∏–∫, 1, –ö–∏—ó–≤")
print(coords)  # (50.4501, 30.5234)
```

### –¢–µ—Å—Ç 2: Reverse –≥–µ–æ–∫–æ–¥—É–≤–∞–Ω–Ω—è
```python
from app.utils.maps import reverse_geocode

address = await reverse_geocode("", 50.4501, 30.5234)
print(address)  # "–≤—É–ª. –•—Ä–µ—â–∞—Ç–∏–∫, 1, –ö–∏—ó–≤, –£–∫—Ä–∞—ó–Ω–∞"
```

### –¢–µ—Å—Ç 3: –†–æ–∑—Ä–∞—Ö—É–Ω–æ–∫ –º–∞—Ä—à—Ä—É—Ç—É
```python
from app.utils.maps import get_distance_and_duration

result = await get_distance_and_duration("", 50.4501, 30.5234, 50.5501, 30.6234)
print(result)  # (5234, 720) - –º–µ—Ç—Ä–∏, —Å–µ–∫—É–Ω–¥–∏
```

---

## üìä –ü–û–†–Ü–í–ù–Ø–ù–ù–Ø:

| –§—É–Ω–∫—Ü—ñ—è | Google Maps | Nominatim/OSRM | –ü–µ—Ä–µ–≤–∞–≥–∏ |
|---------|-------------|----------------|----------|
| **–í–∞—Ä—Ç—ñ—Å—Ç—å** | $200/–º—ñ—Å –±–µ–∑–∫–æ—à—Ç–æ–≤–Ω–æ, –ø–æ—Ç—ñ–º –ø–ª–∞—Ç–∏—Ç–∏ | **–ë–µ–∑–∫–æ—à—Ç–æ–≤–Ω–æ** | üí∞ –ï–∫–æ–Ω–æ–º—ñ—è |
| **–†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è** | –ü–æ—Ç—Ä—ñ–±–Ω–∞ + –∫–∞—Ä—Ç–∞ | **–ù–µ –ø–æ—Ç—Ä—ñ–±–Ω–∞** | ‚ö° –®–≤–∏–¥–∫–∏–π —Å—Ç–∞—Ä—Ç |
| **API –∫–ª—é—á** | –û–±–æ–≤'—è–∑–∫–æ–≤–∏–π | **–ù–µ –ø–æ—Ç—Ä—ñ–±–µ–Ω** | üîì –ü—Ä–æ—Å—Ç–æ—Ç–∞ |
| **–õ—ñ–º—ñ—Ç –∑–∞–ø–∏—Ç—ñ–≤** | ~40,000/–º—ñ—Å –±–µ–∑–∫–æ—à—Ç–æ–≤–Ω–æ | **–ù–µ–æ–±–º–µ–∂–µ–Ω–æ** (1/—Å–µ–∫) | üöÄ –ú–∞—Å—à—Ç–∞–± |
| **–Ø–∫—ñ—Å—Ç—å –¥–∞–Ω–∏—Ö** | –í—ñ–¥–º—ñ–Ω–Ω–∞ | **–î—É–∂–µ —Ö–æ—Ä–æ—à–∞** | ‚úÖ –î–æ—Å—Ç–∞—Ç–Ω—å–æ |
| **–®–≤–∏–¥–∫—ñ—Å—Ç—å** | –î—É–∂–µ —à–≤–∏–¥–∫–æ | **–®–≤–∏–¥–∫–æ** | ‚ö° OK |
| **–ü—ñ–¥—Ç—Ä–∏–º–∫–∞ –£–∫—Ä–∞—ó–Ω–∏** | –í—ñ–¥–º—ñ–Ω–Ω–∞ | **–í—ñ–¥–º—ñ–Ω–Ω–∞** | üá∫üá¶ –¢–∞–∫ |

---

## üîÑ –ú–Ü–ì–†–ê–¶–Ü–Ø:

### –©–æ –ù–ï –ø–æ—Ç—Ä—ñ–±–Ω–æ —Ä–æ–±–∏—Ç–∏:
- ‚ùå –í–∏–¥–∞–ª—è—Ç–∏ GOOGLE_MAPS_API_KEY –∑ .env
- ‚ùå –í–∏–¥–∞–ª—è—Ç–∏ Google Cloud –ø—Ä–æ–µ–∫—Ç
- ‚ùå –ó–º—ñ–Ω—é–≤–∞—Ç–∏ –ë–î

### –©–æ —Ä–æ–±–∏—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ:
- ‚úÖ –ë–æ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î Nominatim
- ‚úÖ –í—Å—ñ –∞–¥—Ä–µ—Å–∏ –≥–µ–æ–∫–æ–¥—É—é—Ç—å—Å—è –±–µ–∑–∫–æ—à—Ç–æ–≤–Ω–æ
- ‚úÖ –ú–∞—Ä—à—Ä—É—Ç–∏ —Ä–æ–∑—Ä–∞—Ö–æ–≤—É—é—Ç—å—Å—è —á–µ—Ä–µ–∑ OSRM

---

## üí° –î–û–î–ê–¢–ö–û–í–Ü –ú–û–ñ–õ–ò–í–û–°–¢–Ü:

### –í–ª–∞—Å–Ω–∏–π Nominatim —Å–µ—Ä–≤–µ—Ä (–æ–ø—Ü—ñ–æ–Ω–∞–ª—å–Ω–æ)

–Ø–∫—â–æ –ø–æ—Ç—Ä—ñ–±–Ω–æ –±—ñ–ª—å—à–µ –∑–∞–ø–∏—Ç—ñ–≤:

1. **Docker:**
```bash
docker run -d -p 8080:8080 mediagis/nominatim:4.2
```

2. **–ó–º—ñ–Ω–∏—Ç–∏ URL –≤ –∫–æ–¥—ñ:**
```python
url = "http://localhost:8080/search"  # –∑–∞–º—ñ—Å—Ç—å openstreetmap.org
```

### –ö–µ—à—É–≤–∞–Ω–Ω—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ñ–≤

–ú–æ–∂–Ω–∞ –¥–æ–¥–∞—Ç–∏ –∫–µ—à –¥–ª—è –ø–æ–ø—É–ª—è—Ä–Ω–∏—Ö –∞–¥—Ä–µ—Å:
```python
# –í –º–∞–π–±—É—Ç–Ω—å–æ–º—É
_geocode_cache = {}
```

---

## üìù –°–¢–ê–¢–ò–°–¢–ò–ö–ê –ó–ú–Ü–ù:

```
app/utils/maps.py:         –ü–û–í–ù–Ü–°–¢–Æ –ü–ï–†–ï–ü–ò–°–ê–ù–û (270 —Ä—è–¥–∫—ñ–≤)
app/handlers/order.py:     6 –º—ñ—Å—Ü—å –æ–Ω–æ–≤–ª–µ–Ω–æ
–í–∏–¥–∞–ª–µ–Ω–æ –∑–∞–ª–µ–∂–Ω—ñ—Å—Ç—å:       GOOGLE_MAPS_API_KEY (–æ–ø—Ü—ñ–æ–Ω–∞–ª—å–Ω–∞)
–î–æ–¥–∞–Ω–æ:                    –ü—ñ–¥—Ç—Ä–∏–º–∫–∞ Nominatim + OSRM
```

---

## ‚úÖ –ì–û–¢–û–í–û!

–ë–æ—Ç —Ç–µ–ø–µ—Ä –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î **–±–µ–∑–∫–æ—à—Ç–æ–≤–Ω—ñ OpenStreetMap —Å–µ—Ä–≤—ñ—Å–∏**:
- üó∫Ô∏è Nominatim –¥–ª—è –≥–µ–æ–∫–æ–¥—É–≤–∞–Ω–Ω—è
- üöó OSRM –¥–ª—è –º–∞—Ä—à—Ä—É—Ç—ñ–≤
- üìç OpenStreetMap –¥–ª—è –∫–∞—Ä—Ç

**–ñ–æ–¥–Ω–∏—Ö –≤–∏—Ç—Ä–∞—Ç, –∂–æ–¥–Ω–∏—Ö –æ–±–º–µ–∂–µ–Ω—å!** üéâ

---

**–†–æ–∑—Ä–æ–±–ª–µ–Ω–æ:** AI Assistant  
**–î–∞—Ç–∞:** 2025-10-23  
**–í–µ—Ä—Å—ñ—è:** 2.0 - Nominatim Edition
