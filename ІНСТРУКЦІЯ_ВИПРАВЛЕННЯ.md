# 🔧 ІНСТРУКЦІЯ: Як виправити помилку "no such table: drivers"

**Проблема:** При натисканні "🚗 Панель водія" нічого не відбувається  
**Помилка:** `sqlite3.OperationalError: no such table: drivers`

---

## ✅ ШВИДКЕ РІШЕННЯ

### Спосіб 1: Використати скрипт (РЕКОМЕНДОВАНО)

```bash
# 1. Встановити залежності (якщо ще не встановлено)
pip install -r requirements.txt

# 2. Переконатись що .env налаштовано
cat .env
# Має бути:
# BOT_TOKEN=ваш_токен
# ADMIN_IDS=ваш_telegram_id

# 3. Запустити скрипт пересоздания БД
python recreate_db.py
```

**Очікуваний результат:**
```
🔧 Початок пересоздания бази даних...
📁 Шлях до БД: /workspace/data/taxi.sqlite3
🗑️  Видаляю старий файл БД...
✅ Старий файл видалено
📁 Створюю папку: /workspace/data
🔨 Створюю нову базу даних...
📁 Ініціалізація SQLite: /workspace/data/taxi.sqlite3
📁 Створюю папку для БД: /workspace/data
🔨 Відкриваю з'єднання з SQLite...
✅ З'єднання встановлено, створюю таблиці...
📊 Створено таблиць: 11
📋 Таблиці: saved_addresses, orders, tariffs, users, drivers, ...
✅ Всі таблиці SQLite створено!
✅ База даних успішно створена!
📊 Створено таблиць: 11
  ✓ saved_addresses
  ✓ orders
  ✓ tariffs
  ✓ users
  ✓ drivers          ← ✅ ТАБЛИЦЯ СТВОРЕНА!
  ✓ ratings
  ✓ client_ratings
  ✓ tips
  ✓ referrals
  ✓ rejected_offers
  ✓ payments

============================================================
✅ БАЗА ДАНИХ УСПІШНО СТВОРЕНА!
============================================================

Тепер можна запускати бота:
  python app/main.py
```

### Спосіб 2: Видалити БД вручну

```bash
# 1. Видалити старий файл БД
rm -rf data/taxi.sqlite3

# 2. Запустити бота (БД створюється автоматично)
python app/main.py
```

**Очікуваний результат при запуску:**
```
📁 Ініціалізація SQLite: /workspace/data/taxi.sqlite3
📁 Створюю папку для БД: /workspace/data
🔨 Відкриваю з'єднання з SQLite...
✅ З'єднання встановлено, створюю таблиці...
📊 Створено таблиць: 11
📋 Таблиці: saved_addresses, orders, tariffs, users, drivers, ratings, ...
✅ Всі таблиці SQLite створено!
✅ SQLite міграції завершено успішно!
✅ init_db() завершено успішно!
🚀 Bot started successfully!
```

---

## 🧪 ПЕРЕВІРКА

### 1. Запустити бота
```bash
python app/main.py
```

### 2. У Telegram:
1. Відправити `/start`
2. Натиснути "🚗 Панель водія"

### 3. Очікуваний результат:

**Якщо ви НЕ зареєстровані як водій:**
```
❌ Ви не зареєстровані як водій
```

**Якщо ви зареєстровані як водій:**
```
🚗 ПАНЕЛЬ ВОДІЯ

📊 Статистика:
💰 Заробіток сьогодні: 0.00 грн
📦 Виконано замовлень: 0
⭐ Рейтинг: Немає оцінок
💸 Чайові сьогодні: 0.00 грн

[Кнопки]
✅ На зміні | 📋 Замовлення | ...
```

---

## ❌ ЯКЩО НЕ ПРАЦЮЄ

### Проблема 1: Папка data/ не створюється

**Рішення:**
```bash
# Створити вручну
mkdir -p data
chmod 755 data
python recreate_db.py
```

### Проблема 2: Помилка "ModuleNotFoundError"

**Рішення:**
```bash
# Встановити всі залежності
pip install -r requirements.txt

# Або окремо:
pip install aiogram aiosqlite asyncpg python-dotenv aiohttp apscheduler
```

### Проблема 3: Помилка ".env file not found"

**Рішення:**
```bash
# Створити .env файл
cat > .env << EOF
BOT_TOKEN=ваш_токен_від_BotFather
ADMIN_IDS=ваш_telegram_id
EOF

# Перевірити
cat .env
```

### Проблема 4: Кнопка є, але не працює

**Перевірити:**
```bash
# 1. БД існує?
ls -la data/

# 2. Таблиці створено?
sqlite3 data/taxi.sqlite3 "SELECT name FROM sqlite_master WHERE type='table';"

# Має показати:
# saved_addresses
# orders
# tariffs
# users
# drivers          ← ВАЖЛИВО!
# ratings
# ...

# 3. Перезапустити бота
# Ctrl+C
python app/main.py
```

---

## 🎯 ЩО БУЛО ВИПРАВЛЕНО

### У коді:

**1. Файл `app/storage/db.py`:**
- ✅ Додано автоматичне створення папки `data/` перед init_db()
- ✅ Додано детальне логування кожного кроку
- ✅ Додано верифікацію створених таблиць

**2. Новий файл `recreate_db.py`:**
- ✅ Скрипт для швидкого пересоздания БД
- ✅ Автоматична перевірка таблиць
- ✅ Детальний звіт про створення

### У роботі:

**ДО:**
```
Натиснути кнопку → ❌ Нічого не відбувається
Лог: sqlite3.OperationalError: no such table: drivers
```

**ПІСЛЯ:**
```
Натиснути кнопку → ✅ Панель водія відкривається
Лог: 📊 Створено таблиць: 11 (включно з drivers)
```

---

## 📊 ЧЕК-ЛИСТ

Після виправлення перевірте:

- [ ] Файл `data/taxi.sqlite3` створено
- [ ] У логах є "📊 Створено таблиць: 11"
- [ ] У логах є "📋 Таблиці: ..., drivers, ..."
- [ ] Бот запустився без помилок
- [ ] Кнопка "🚗 Панель водія" працює
- [ ] Інші кнопки працюють

---

## 🚀 ГОТОВО!

Тепер ваш бот повністю працює локально з SQLite!

**Наступні кроки:**
1. ✅ Протестувати всі функції локально
2. ✅ Задеплоїти на Render (використовується PostgreSQL автоматично)
3. ✅ Перевірити роботу на Render

**На Render змін не потрібно!** PostgreSQL працює через `DATABASE_URL` і використовує окремий файл `init_postgres.py`.

---

## 📞 ПІДТРИМКА

Якщо щось не працює:

1. Перевірте логи при запуску бота
2. Переконайтесь що всі залежності встановлено
3. Використайте `recreate_db.py` для чистого старту
4. Перевірте що `.env` файл налаштовано правильно

**Всі зміни запушені на гілку `fix-taxi-bot`!** ✅
