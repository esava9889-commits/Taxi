# üîç –î–ï–¢–ê–õ–¨–ù–ò–ô –ê–£–î–ò–¢ –ö–û–î–£ TAXI BOT

**–î–∞—Ç–∞:** 2025-10-30  
**–ì—ñ–ª–∫–∞:** `fix-taxi-bot`  
**–°—Ç–∞—Ç—É—Å:** ‚ö†Ô∏è –ó–Ω–∞–π–¥–µ–Ω–æ –∫—Ä–∏—Ç–∏—á–Ω—ñ –ø—Ä–æ–±–ª–µ–º–∏

---

## üìä –†–ï–ó–Æ–ú–ï

**–í—Å—å–æ–≥–æ –∑–Ω–∞–π–¥–µ–Ω–æ –ø—Ä–æ–±–ª–µ–º:** 11  
**–ö—Ä–∏—Ç–∏—á–Ω–∏—Ö:** 4 üî¥  
**–í–∞–∂–ª–∏–≤–∏—Ö:** 5 üü°  
**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ–π:** 2 üîµ

---

## üî¥ –ö–†–ò–¢–ò–ß–ù–Ü –ü–†–û–ë–õ–ï–ú–ò (–ø–æ—Ç—Ä—ñ–±–Ω–æ –≤–∏–ø—Ä–∞–≤–∏—Ç–∏ –ù–ï–ì–ê–ô–ù–û)

### 1. **–ú–ê–°–ò–í–ù–ï –î–£–ë–õ–Æ–í–ê–ù–ù–Ø –ö–û–î–£ –≤ webapp_api.py**

**–õ–æ–∫–∞—Ü—ñ—è:** `app/handlers/webapp_api.py`

**–ü—Ä–æ–±–ª–µ–º–∞:**
- –§—É–Ω–∫—Ü—ñ—è `webapp_location_handler` (—Ä—è–¥–∫–∏ 217-354) –º—ñ—Å—Ç–∏—Ç—å –º–∞–π–∂–µ –Ü–î–ï–ù–¢–ò–ß–ù–ò–ô –∫–æ–¥ –¥–æ `webapp_order_handler` (—Ä—è–¥–∫–∏ 455-558)
- –î—É–±–ª—é—î—Ç—å—Å—è –ª–æ–≥—ñ–∫–∞ —Ä–æ–∑—Ä–∞—Ö—É–Ω–∫—É —Ü—ñ–Ω, —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –∫–ª–∞–≤—ñ–∞—Ç—É—Ä, –≤—ñ–¥–ø—Ä–∞–≤–∫–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å
- ~140 —Ä—è–¥–∫—ñ–≤ –∫–æ–¥—É –¥—É–±–ª—é—î—Ç—å—Å—è

**–ù–∞—Å–ª—ñ–¥–∫–∏:**
- –ë—É–¥—å-—è–∫–∞ –∑–º—ñ–Ω–∞ –ª–æ–≥—ñ–∫–∏ –ø–æ—Ç—Ä–µ–±—É—î –ø—Ä–∞–≤–∫–∏ –≤ 2 –º—ñ—Å—Ü—è—Ö
- –í–∏—Å–æ–∫–∞ –π–º–æ–≤—ñ—Ä–Ω—ñ—Å—Ç—å –ø–æ–º–∏–ª–æ–∫ —á–µ—Ä–µ–∑ —Ä–æ–∑–±—ñ–∂–Ω–æ—Å—Ç—ñ
- –°–∫–ª–∞–¥–Ω—ñ—Å—Ç—å –ø—ñ–¥—Ç—Ä–∏–º–∫–∏ –∫–æ–¥—É

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—è:**
–í–∏–¥—ñ–ª–∏—Ç–∏ —Å–ø—ñ–ª—å–Ω—É –ª–æ–≥—ñ–∫—É –≤ –æ–∫—Ä–µ–º—É —Ñ—É–Ω–∫—Ü—ñ—é:
```python
async def _calculate_and_show_prices(
    bot: Bot,
    state: FSMContext,
    config: AppConfig,
    user_id: int,
    pickup_address: str,
    dest_address: str,
    distance_km: float,
    duration_minutes: float
) -> None:
    # –°–ø—ñ–ª—å–Ω–∞ –ª–æ–≥—ñ–∫–∞ —Ä–æ–∑—Ä–∞—Ö—É–Ω–∫—É —Ü—ñ–Ω —ñ –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è
    ...
```

---

### 2. **–î–£–ë–õ–Æ–í–ê–ù–ù–Ø base_fare –†–û–ó–†–ê–•–£–ù–ö–£**

**–õ–æ–∫–∞—Ü—ñ—è:** 5 —Ä—ñ–∑–Ω–∏—Ö —Ñ–∞–π–ª—ñ–≤

**–§–∞–π–ª–∏ —Ç–∞ —Ä—è–¥–∫–∏:**
- `app/handlers/order.py` (155-157, 979-981)
- `app/handlers/webapp_api.py` (255-258, 467-470)
- `app/handlers/webapp.py` (224-226)

**–ü—Ä–æ–±–ª–µ–º–∞:**
–û–¥–Ω–∞–∫–æ–≤–∏–π –∫–æ–¥ —Ä–æ–∑—Ä–∞—Ö—É–Ω–∫—É –±–∞–∑–æ–≤–æ—ó —Ü—ñ–Ω–∏ –ø–æ–≤—Ç–æ—Ä—é—î—Ç—å—Å—è 5 —Ä–∞–∑—ñ–≤:
```python
base_fare = tariff.base_fare + (distance_km * tariff.per_km) + (duration_minutes * tariff.per_minute)
if base_fare < tariff.minimum:
    base_fare = tariff.minimum
```

**–ù–∞—Å–ª—ñ–¥–∫–∏:**
- –ó–º—ñ–Ω–∞ —Ñ–æ—Ä–º—É–ª–∏ –ø–æ—Ç—Ä–µ–±—É—î –ø—Ä–∞–≤–∫–∏ –≤ 5 –º—ñ—Å—Ü—è—Ö
- –†–∏–∑–∏–∫ –Ω–µ—É–∑–≥–æ–¥–∂–µ–Ω–æ—Å—Ç—ñ —Ä–æ–∑—Ä–∞—Ö—É–Ω–∫—ñ–≤

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—è:**
–°—Ç–≤–æ—Ä–∏—Ç–∏ helper —Ñ—É–Ω–∫—Ü—ñ—é:
```python
def calculate_base_fare(tariff: Tariff, distance_km: float, duration_minutes: float) -> float:
    """–†–æ–∑—Ä–∞—Ö—É–≤–∞—Ç–∏ –±–∞–∑–æ–≤—É —Ü—ñ–Ω—É –∑ —É—Ä–∞—Ö—É–≤–∞–Ω–Ω—è–º –º—ñ–Ω—ñ–º—É–º—É"""
    fare = tariff.base_fare + (distance_km * tariff.per_km) + (duration_minutes * tariff.per_minute)
    return max(fare, tariff.minimum)
```

---

### 3. **–ú–û–í–ß–ê–ó–ù–ò–ô FALLBACK –±–µ–∑ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—É**

**–õ–æ–∫–∞—Ü—ñ—è:** 
- `app/handlers/webapp_api.py` (243-246, 450-453)
- `app/handlers/order.py` (142-143)
- `app/handlers/webapp.py` (211-213)

**–ü—Ä–æ–±–ª–µ–º–∞:**
–ö–æ–ª–∏ OSRM –Ω–µ –º–æ–∂–µ —Ä–æ–∑—Ä–∞—Ö—É–≤–∞—Ç–∏ –≤—ñ–¥—Å—Ç–∞–Ω—å, –∫–æ–¥ –ú–û–í–ß–ö–ò –≤—Å—Ç–∞–Ω–æ–≤–ª—é—î:
```python
if not distance_km:
    distance_km = 5.0
    duration_minutes = 15
    await state.update_data(distance_km=distance_km, duration_minutes=duration_minutes)
```

**–ù–∞—Å–ª—ñ–¥–∫–∏:**
- –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á –±–∞—á–∏—Ç—å —Ü—ñ–Ω—É –∑–∞ 5 –∫–º, –∞–ª–µ —Ä–µ–∞–ª—å–Ω–∞ –≤—ñ–¥—Å—Ç–∞–Ω—å –º–æ–∂–µ –±—É—Ç–∏ 50 –∫–º!
- –í–æ–¥—ñ–π –º–æ–∂–µ –æ—Ç—Ä–∏–º–∞—Ç–∏ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è –∑ –Ω–µ–∞–¥–µ–∫–≤–∞—Ç–Ω–æ—é —Ü—ñ–Ω–æ—é
- –§—ñ–Ω–∞–Ω—Å–æ–≤—ñ –≤—Ç—Ä–∞—Ç–∏ –¥–ª—è —Å–µ—Ä–≤—ñ—Å—É –∞–±–æ –Ω–µ–∑–∞–¥–æ–≤–æ–ª–µ–Ω–Ω—è –∫–ª—ñ—î–Ω—Ç—ñ–≤

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—è:**
```python
if not distance_km:
    logger.error(f"‚ùå OSRM –Ω–µ –∑–º—ñ–≥ —Ä–æ–∑—Ä–∞—Ö—É–≤–∞—Ç–∏ –≤—ñ–¥—Å—Ç–∞–Ω—å –¥–ª—è {user_id}")
    await bot.send_message(
        user_id,
        "‚ö†Ô∏è –ù–µ –≤–¥–∞–ª–æ—Å—è —Ä–æ–∑—Ä–∞—Ö—É–≤–∞—Ç–∏ –≤—ñ–¥—Å—Ç–∞–Ω—å.\n"
        "–°–ø—Ä–æ–±—É–π—Ç–µ –æ–±—Ä–∞—Ç–∏ —ñ–Ω—à—ñ —Ç–æ—á–∫–∏ –∞–±–æ –∑–≤–µ—Ä–Ω—ñ—Ç—å—Å—è –¥–æ –ø—ñ–¥—Ç—Ä–∏–º–∫–∏.",
        parse_mode="HTML"
    )
    return web.json_response(
        {"success": False, "error": "Could not calculate distance"},
        status=400
    )
```

---

### 4. **–ö–û–ù–§–õ–Ü–ö–¢ –î–í–û–• API ENDPOINTS**

**–õ–æ–∫–∞—Ü—ñ—è:** `app/handlers/webapp_api.py` (586-587)

**–ü—Ä–æ–±–ª–µ–º–∞:**
```python
app.router.add_post('/api/webapp/location', webapp_location_handler)  # –°—Ç–∞—Ä–∏–π
app.router.add_post('/api/webapp/order', webapp_order_handler)  # –ù–æ–≤–∏–π
```

–û–±–∏–¥–≤–∞ endpoints —Ä–æ–±–ª—è—Ç—å –º–∞–π–∂–µ —Ç–µ —Å–∞–º–µ (–ø–æ–∫–∞–∑—É—é—Ç—å —Ü—ñ–Ω–∏ –∫–ª–∞—Å—ñ–≤ –∞–≤—Ç–æ), –∞–ª–µ:
- `webapp_location_handler` - –ø—Ä–∏–π–º–∞—î –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏ –ø–æ–µ—Ç–∞–ø–Ω–æ (pickup, –ø–æ—Ç—ñ–º destination)
- `webapp_order_handler` - –ø—Ä–∏–π–º–∞—î –æ–±–∏–¥–≤—ñ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏ –æ–¥—Ä–∞–∑—É

**–ù–∞—Å–ª—ñ–¥–∫–∏:**
- –ü–ª—É—Ç–∞–Ω–∏–Ω–∞: —è–∫–∏–π endpoint –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏?
- Webapp –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î `/api/webapp/order`, –∞–ª–µ —Å—Ç–∞—Ä–∏–π –∫–æ–¥ –∑–∞–ª–∏—à–∏–≤—Å—è
- –ü–æ–¥–≤—ñ–π–Ω–∞ –ø—ñ–¥—Ç—Ä–∏–º–∫–∞ –∫–æ–¥—É

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—è:**
- –í–∏–¥–∞–ª–∏—Ç–∏ `webapp_location_handler` —è–∫—â–æ –≤—ñ–Ω –Ω–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è
- –ê–ë–û —á—ñ—Ç–∫–æ —Ä–æ–∑–¥—ñ–ª–∏—Ç–∏ —Ñ—É–Ω–∫—Ü—ñ–æ–Ω–∞–ª—å–Ω—ñ—Å—Ç—å:
  - `/location` - —Ç—ñ–ª—å–∫–∏ –∑–±–µ—Ä—ñ–≥–∞—î –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏ (–ë–ï–ó —Ä–æ–∑—Ä–∞—Ö—É–Ω–∫—É —Ü—ñ–Ω)
  - `/order` - —Ä–æ–∑—Ä–∞—Ö–æ–≤—É—î —Ü—ñ–Ω–∏ —ñ –ø–æ–∫–∞–∑—É—î –∫–ª–∞—Å–∏

---

## üü° –í–ê–ñ–õ–ò–í–Ü –ü–†–û–ë–õ–ï–ú–ò (–≤–∞—Ä—Ç–æ –≤–∏–ø—Ä–∞–≤–∏—Ç–∏)

### 5. **–ù–µ—Ç–æ—á–Ω–µ –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è –º–Ω–æ–∂–Ω–∏–∫—ñ–≤ —É dynamic_pricing**

**–õ–æ–∫–∞—Ü—ñ—è:** `app/handlers/dynamic_pricing.py` (184)

**–ü—Ä–æ–±–ª–µ–º–∞:**
```python
reasons.append(f"‚Ä¢ {time_reason}: +{int((time_mult-1)*100)}%")
```

–ö–æ–ª–∏ `time_mult` —î —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–º –î–ï–ö–Ü–õ–¨–ö–û–• –º–Ω–æ–∂–Ω–∏–∫—ñ–≤ (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥ –ø—ñ–∫–æ–≤–∏–π —á–∞—Å 1.3 √ó –Ω—ñ—á–Ω–∏–π —Ç–∞—Ä–∏—Ñ 1.5 = 1.95), –≤—ñ–¥–æ–±—Ä–∞–∂–∞—î—Ç—å—Å—è "+95%", –∞–ª–µ –Ω–∞—Å–ø—Ä–∞–≤–¥—ñ —Ü–µ 30% + 50%.

**–ü—Ä–∏–∫–ª–∞–¥:**
- –ü—ñ–∫–æ–≤–∏–π —á–∞—Å: +30%
- –ù—ñ—á–Ω–∏–π —Ç–∞—Ä–∏—Ñ: +50%
- `time_mult = 1.3 √ó 1.5 = 1.95`
- –í—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è: "+95%" ‚ùå
- –û—á—ñ–∫—É—î—Ç—å—Å—è: "+30%, +50%" –∞–±–æ "+95% (–∫–æ–º–±—ñ–Ω–∞—Ü—ñ—è)" ‚úÖ

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—è:**
–ü–æ–≤–µ—Ä—Ç–∞—Ç–∏ –æ–∫—Ä–µ–º—ñ –ø—Ä–∏—á–∏–Ω–∏ –∑ `get_surge_multiplier()` –∑–∞–º—ñ—Å—Ç—å –∫–æ–º–±—ñ–Ω–æ–≤–∞–Ω–æ–≥–æ `time_reason`.

---

### 6. **–í—ñ–¥—Å—É—Ç–Ω—ñ—Å—Ç—å –≤–∞–ª—ñ–¥–∞—Ü—ñ—ó –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç**

**–õ–æ–∫–∞—Ü—ñ—è:** `app/handlers/webapp_api.py` (37-40, 388-392)

**–ü—Ä–æ–±–ª–µ–º–∞:**
–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏ –ø—Ä–∏–π–º–∞—é—Ç—å—Å—è –±–µ–∑ –≤–∞–ª—ñ–¥–∞—Ü—ñ—ó:
```python
latitude = data.get('latitude')
longitude = data.get('longitude')
```

**–ù–∞—Å–ª—ñ–¥–∫–∏:**
- –ú–æ–∂—É—Ç—å –ø—Ä–∏–π—Ç–∏ –Ω–µ–∫–æ—Ä–µ–∫—Ç–Ω—ñ –∑–Ω–∞—á–µ–Ω–Ω—è (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥ "abc", 999, null)
- –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏ –ø–æ–∑–∞ –¥—ñ–∞–ø–∞–∑–æ–Ω–æ–º (latitude > 90, longitude > 180)

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—è:**
```python
def validate_coordinates(lat: float, lon: float) -> bool:
    """–í–∞–ª—ñ–¥—É–≤–∞—Ç–∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏"""
    if not isinstance(lat, (int, float)) or not isinstance(lon, (int, float)):
        return False
    return -90 <= lat <= 90 and -180 <= lon <= 180

# –£ handler:
if not validate_coordinates(latitude, longitude):
    return web.json_response(
        {"success": False, "error": "Invalid coordinates"},
        status=400
    )
```

---

### 7. **121 "–≥–æ–ª–∏—Ö" except –±–ª–æ–∫—ñ–≤**

**–õ–æ–∫–∞—Ü—ñ—è:** –ü–æ –≤—Å—å–æ–º—É –ø—Ä–æ–µ–∫—Ç—É

**–ü—Ä–æ–±–ª–µ–º–∞:**
```python
except:  # ‚ùå –õ–æ–≤–∏—Ç—å –í–°–Ü –≤–∏–Ω—è—Ç–∫–∏, –Ω–∞–≤—ñ—Ç—å —Å–∏—Å—Ç–µ–º–Ω—ñ (KeyboardInterrupt, SystemExit)
    await call.message.answer(...)
```

**–ù–∞—Å–ª—ñ–¥–∫–∏:**
- –°–∫–ª–∞–¥–Ω–æ –¥–µ–±–∞–≥–∏—Ç–∏
- –ú–æ–∂–µ —Ö–æ–≤–∞—Ç–∏ –∫—Ä–∏—Ç–∏—á–Ω—ñ –ø–æ–º–∏–ª–∫–∏
- –ù–µ–º–æ–∂–ª–∏–≤–æ graceful shutdown

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—è:**
```python
except Exception as e:  # ‚úÖ –õ–æ–≤–∏—Ç—å —Ç—ñ–ª—å–∫–∏ application exceptions
    logger.error(f"Error: {e}", exc_info=True)
    await call.message.answer(...)
```

---

### 8. **–í—ñ–¥—Å—É—Ç–Ω—ñ—Å—Ç—å timeout –¥–ª—è HTTP –∑–∞–ø–∏—Ç—ñ–≤**

**–õ–æ–∫–∞—Ü—ñ—è:** `app/utils/maps.py`

**–ü—Ä–æ–±–ª–µ–º–∞:**
OSRM —Ç–∞ Nominatim –∑–∞–ø–∏—Ç–∏ –º–∞—é—Ç—å timeout=15, –∞–ª–µ —â–æ —è–∫—â–æ —Å–µ—Ä–≤—ñ—Å –ø–æ–≤—ñ–ª—å–Ω–∏–π?

**–¢–µ–∫—É—â–∏–π –∫–æ–¥:**
```python
async with session.get(url, headers=headers, timeout=15) as resp:
```

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—è:**
–î–æ–¥–∞—Ç–∏ retry –ª–æ–≥—ñ–∫—É –∞–±–æ exponential backoff:
```python
from aiohttp import ClientTimeout

timeout = ClientTimeout(total=15, connect=5)
async with session.get(url, headers=headers, timeout=timeout) as resp:
```

---

### 9. **–ü–æ—Ç–µ–Ω—Ü—ñ–π–Ω–∞ race condition –∑ _last_nominatim_request**

**–õ–æ–∫–∞—Ü—ñ—è:** `app/utils/maps.py` (11, 26)

**–ü—Ä–æ–±–ª–µ–º–∞:**
```python
_last_nominatim_request = 0  # –ì–ª–æ–±–∞–ª—å–Ω–∞ –∑–º—ñ–Ω–Ω–∞

async def _wait_for_nominatim():
    global _last_nominatim_request
    now = time.time()
    time_since_last = now - _last_nominatim_request
    # ...
    _last_nominatim_request = time.time()
```

**–ù–∞—Å–ª—ñ–¥–∫–∏:**
–ü—Ä–∏ –æ–¥–Ω–æ—á–∞—Å–Ω–∏—Ö –∑–∞–ø–∏—Ç–∞—Ö –≤—ñ–¥ —Ä—ñ–∑–Ω–∏—Ö –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤ –º–æ–∂–µ –ø–æ—Ä—É—à—É–≤–∞—Ç–∏—Å—è rate limit (1 req/sec –¥–ª—è Nominatim).

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—è:**
–í–∏–∫–æ—Ä–∏—Å—Ç–∞—Ç–∏ asyncio.Lock:
```python
_nominatim_lock = asyncio.Lock()

async def _wait_for_nominatim():
    async with _nominatim_lock:
        global _last_nominatim_request
        # ... —Ä–µ—à—Ç–∞ –ª–æ–≥—ñ–∫–∏
```

---

## üîµ –†–ï–ö–û–ú–ï–ù–î–ê–¶–Ü–á (–ø–æ–∫—Ä–∞—â–µ–Ω–Ω—è –∫–æ–¥—É)

### 10. **–í—ñ–¥—Å—É—Ç–Ω—ñ—Å—Ç—å —Ç–∏–ø—ñ–∑–∞—Ü—ñ—ó –≤ –±–∞–≥–∞—Ç—å–æ—Ö —Ñ—É–Ω–∫—Ü—ñ—è—Ö**

**–ü—Ä–æ–±–ª–µ–º–∞:**
–ë–∞–≥–∞—Ç–æ —Ñ—É–Ω–∫—Ü—ñ–π –Ω–µ –º–∞—é—Ç—å type hints, —â–æ —É—Å–∫–ª–∞–¥–Ω—é—î —Ä–æ–∑—É–º—ñ–Ω–Ω—è –∫–æ–¥—É.

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—è:**
–î–æ–¥–∞—Ç–∏ —Ç–∏–ø–∏ –¥–ª—è –≤—Å—ñ—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä—ñ–≤ —Ç–∞ return values:
```python
async def get_user_by_id(db_path: str, user_id: int) -> Optional[User]:
    ...
```

---

### 11. **–í—ñ–¥—Å—É—Ç–Ω—ñ—Å—Ç—å unit tests**

**–ü—Ä–æ–±–ª–µ–º–∞:**
–ù–µ–º–∞—î —Ç–µ—Å—Ç—ñ–≤ –¥–ª—è –∫—Ä–∏—Ç–∏—á–Ω–æ—ó –ª–æ–≥—ñ–∫–∏ (—Ü—ñ–Ω–æ—É—Ç–≤–æ—Ä–µ–Ω–Ω—è, —Ä–æ–∑—Ä–∞—Ö—É–Ω–æ–∫ –≤—ñ–¥—Å—Ç–∞–Ω—ñ, —Ç–æ—â–æ).

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—è:**
–î–æ–¥–∞—Ç–∏ pytest —Ç–µ—Å—Ç–∏:
```python
def test_calculate_dynamic_price():
    base_fare = 100.0
    result = calculate_dynamic_price(
        base_fare,
        online_drivers=5,
        pending_orders=0,
        # ...
    )
    assert result[0] == 100.0  # –ë–µ–∑ –Ω–∞—Ü—ñ–Ω–æ–∫
```

---

## üìã CHECKLIST –î–õ–Ø –í–ò–ü–†–ê–í–õ–ï–ù–ù–Ø

### –ü—Ä—ñ–æ—Ä–∏—Ç–µ—Ç 1 (–ö–†–ò–¢–ò–ß–ù–û):
- [ ] –í–∏–¥—ñ–ª–∏—Ç–∏ —Å–ø—ñ–ª—å–Ω—É –ª–æ–≥—ñ–∫—É —Ä–æ–∑—Ä–∞—Ö—É–Ω–∫—É —Ü—ñ–Ω —É webapp_api.py
- [ ] –°—Ç–≤–æ—Ä–∏—Ç–∏ helper —Ñ—É–Ω–∫—Ü—ñ—é –¥–ª—è calculate_base_fare
- [ ] –î–æ–¥–∞—Ç–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—É –ø—Ä–∏ OSRM fallback
- [ ] –í–∏–¥–∞–ª–∏—Ç–∏ –∞–±–æ —Ä–æ–∑–¥—ñ–ª–∏—Ç–∏ –∫–æ–Ω—Ñ–ª—ñ–∫—Ç—É—é—á—ñ API endpoints

### –ü—Ä—ñ–æ—Ä–∏—Ç–µ—Ç 2 (–í–ê–ñ–õ–ò–í–û):
- [ ] –í–∏–ø—Ä–∞–≤–∏—Ç–∏ –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è –º–Ω–æ–∂–Ω–∏–∫—ñ–≤ —É dynamic_pricing
- [ ] –î–æ–¥–∞—Ç–∏ –≤–∞–ª—ñ–¥–∞—Ü—ñ—é –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç
- [ ] –ó–∞–º—ñ–Ω–∏—Ç–∏ –≥–æ–ª—ñ `except:` –Ω–∞ `except Exception as e:`
- [ ] –î–æ–¥–∞—Ç–∏ retry –ª–æ–≥—ñ–∫—É –¥–ª—è HTTP –∑–∞–ø–∏—Ç—ñ–≤
- [ ] –í–∏–ø—Ä–∞–≤–∏—Ç–∏ race condition –≤ Nominatim rate limiter

### –ü—Ä—ñ–æ—Ä–∏—Ç–µ—Ç 3 (–ü–û–ö–†–ê–©–ï–ù–ù–Ø):
- [ ] –î–æ–¥–∞—Ç–∏ type hints –ø–æ –≤—Å—å–æ–º—É –ø—Ä–æ–µ–∫—Ç—É
- [ ] –ù–∞–ø–∏—Å–∞—Ç–∏ unit tests –¥–ª—è –∫—Ä–∏—Ç–∏—á–Ω–æ—ó –ª–æ–≥—ñ–∫–∏
- [ ] –î–æ–¥–∞—Ç–∏ integration tests –¥–ª—è API endpoints

---

## üìà –ú–ï–¢–†–ò–ö–ò –ö–û–î–£

**–î—É–±–ª—é–≤–∞–Ω–Ω—è –∫–æ–¥—É:**
- webapp_api.py: ~140 —Ä—è–¥–∫—ñ–≤ –¥—É–±–ª—é—î—Ç—å—Å—è (23% —Ñ–∞–π–ª—É)
- base_fare —Ä–æ–∑—Ä–∞—Ö—É–Ω–æ–∫: 5 –∫–æ–ø—ñ–π

**–°–∫–ª–∞–¥–Ω—ñ—Å—Ç—å:**
- webapp_api.py: 589 —Ä—è–¥–∫—ñ–≤ (–∑–∞–Ω–∞–¥—Ç–æ –≤–µ–ª–∏–∫–∏–π, —Ç—Ä–µ–±–∞ —Ä–æ–∑–¥—ñ–ª–∏—Ç–∏)
- order.py: 2569 —Ä—è–¥–∫—ñ–≤ (–¥—É–∂–µ –≤–µ–ª–∏–∫–∏–π!)

**–¢–µ—Ö–Ω—ñ—á–Ω–∏–π –±–æ—Ä–≥:**
- 121 –≥–æ–ª–∏—Ö except –±–ª–æ–∫—ñ–≤
- –í—ñ–¥—Å—É—Ç–Ω—ñ—Å—Ç—å —Ç–µ—Å—Ç—ñ–≤
- –ú—ñ–Ω—ñ–º–∞–ª—å–Ω–∞ —Ç–∏–ø—ñ–∑–∞—Ü—ñ—è

---

## ‚úÖ –©–û –ü–†–ê–¶–Æ–Ñ –î–û–ë–†–ï

1. ‚úÖ **SQL —ñ–Ω'—î–∫—Ü—ñ—ó –≤—ñ–¥—Å—É—Ç–Ω—ñ** - –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—Ç—å—Å—è –ø–∞—Ä–∞–º–µ—Ç—Ä–∏–∑–æ–≤–∞–Ω—ñ –∑–∞–ø–∏—Ç–∏
2. ‚úÖ **Rate limiting –¥–ª—è Nominatim** - —Ä–µ–∞–ª—ñ–∑–æ–≤–∞–Ω–æ
3. ‚úÖ **HTTPS –¥–ª—è –≥–µ–æ–∫–æ–¥—É–≤–∞–Ω–Ω—è** - –≤–∏–ø—Ä–∞–≤–ª–µ–Ω–æ
4. ‚úÖ **–õ–æ–≥—É–≤–∞–Ω–Ω—è** - –¥–µ—Ç–∞–ª—å–Ω–µ —ñ —ñ–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω–µ
5. ‚úÖ **–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç—É** - –ª–æ–≥—ñ—á–Ω–∞ –æ—Ä–≥–∞–Ω—ñ–∑–∞—Ü—ñ—è –º–æ–¥—É–ª—ñ–≤

---

**–ê—É–¥–∏—Ç –≤–∏–∫–æ–Ω–∞–≤:** AI Agent  
**–Ü–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∏:** grep, manual code review, static analysis
