# 🎯 ВЕЛИКА КНОПКА КЕРУВАННЯ (REPLY KEYBOARD)

**Дата:** 2025-10-19  
**Версія:** 2.0 - Повна переробка інтерфейсу

---

## 🔄 ЩО ЗМІНИЛОСЯ

### Було (Inline Keyboard):
```
Після прийняття замовлення:
- Inline кнопки в повідомленні
- Маленькі кнопки
- Ховаються після натискання
- Потрібно прокручувати чат
```

### Стало (Reply Keyboard):
```
Після прийняття замовлення:
- Reply Keyboard (завжди внизу екрану)
- ВЕЛИКА кнопка зверху (половина екрану)
- Менші кнопки знизу (2x2 сітка)
- Завжди видима
- Легко натискати
```

---

## 🎨 ДИЗАЙН КЛАВІАТУРИ

### Початкова клавіатура (після прийняття):

```
┌────────────────────────────────┐
│      🚗 В дорозі               │  ← ВЕЛИКА КНОПКА
│       (половина екрану)        │
├────────────────┬───────────────┤
│ ❌ Відмовитися │📞 Зв'язатися  │
│                │  з клієнтом   │
├────────────────┼───────────────┤
│ ℹ️ Допомога    │ 💬 Підтримка  │
└────────────────┴───────────────┘
```

### Після натискання "🚗 В дорозі":

```
┌────────────────────────────────┐
│      📍 На місці               │  ← ЗМІНИЛАСЯ!
│       (половина екрану)        │
├────────────────┬───────────────┤
│ ❌ Відмовитися │📞 Зв'язатися  │
├────────────────┼───────────────┤
│ ℹ️ Допомога    │ 💬 Підтримка  │
└────────────────┴───────────────┘
```

### Після натискання "📍 На місці":

```
┌────────────────────────────────┐
│   🚀 Виконую замовлення        │  ← ЗМІНИЛАСЯ!
│       (половина екрану)        │
├────────────────┬───────────────┤
│ ❌ Відмовитися │📞 Зв'язатися  │
├────────────────┼───────────────┤
│ ℹ️ Допомога    │ 💬 Підтримка  │
└────────────────┴───────────────┘
```

### Після натискання "🚀 Виконую замовлення":

```
┌────────────────────────────────┐
│      🏁 Завершити              │  ← ЗМІНИЛАСЯ!
│       (половина екрану)        │
├────────────────┬───────────────┤
│ ❌ Відмовитися │📞 Зв'язатися  │
├────────────────┼───────────────┤
│ ℹ️ Допомога    │ 💬 Підтримка  │
└────────────────┴───────────────┘
```

---

## 🔄 ПРОГРЕСІЯ ВЕЛИКОЇ КНОПКИ

### Крок 1: 🚗 В дорозі

**Коли натискається:**
- Водій починає рух до клієнта
- Статус замовлення: `accepted` → `in_progress`

**Що відбувається:**
```python
# Оновлення статусу
await start_order(db_path, order_id, driver_id)

# Повідомлення водію
"✅ В дорозі до клієнта!
 🚗 Рухайтесь до адреси подачі:
 📍 {pickup_address}
 👇 Натисніть кнопку коли приїдете"

# Кнопка змінюється
🚗 В дорозі → 📍 На місці
```

---

### Крок 2: 📍 На місці

**Коли натискається:**
- Водій приїхав на адресу подачі
- Чекає на клієнта

**Що відбувається:**
```python
# Повідомлення клієнту
await bot.send_message(
    client_id,
    "📍 Водій на місці!
     🚗 {driver_name}
     📱 {driver_phone}
     Водій чекає на вас!"
)

# Повідомлення водію
"✅ На місці подачі!
 👋 Зустрічайте клієнта:
 👤 {client_name}
 📱 {client_phone}
 📍 Їдете до: {destination}
 👇 Натисніть кнопку коли почнете поїздку"

# Кнопка змінюється
📍 На місці → 🚀 Виконую замовлення
```

---

### Крок 3: 🚀 Виконую замовлення

**Коли натискається:**
- Клієнт сів в авто
- Почалась поїздка до призначення

**Що відбувається:**
```python
# Повідомлення водію
"🚀 Виконуєте замовлення!
 🎯 Напрямок:
 📍 {destination}
 💰 Вартість: {fare} грн
 👇 Натисніть кнопку коли доїдете"

# Кнопка змінюється
🚀 Виконую замовлення → 🏁 Завершити
```

---

### Крок 4: 🏁 Завершити

**Коли натискається:**
- Водій доїхав до призначення
- Поїздка завершена

**Що відбувається:**
```python
# 1. Завершити замовлення
fare = order.fare_amount
commission = fare * commission_rate
await complete_order(db_path, order_id, driver_id, fare, distance, duration, commission)

# 2. Записати платіж
payment = Payment(
    order_id=order_id,
    driver_id=driver_id,
    amount=fare,
    commission=commission,
    commission_paid=False
)
await insert_payment(db_path, payment)

# 3. Відправити запит на оцінку клієнту
await bot.send_message(
    client_id,
    "🏁 Поїздка завершена!
     🚗 Водій: {driver_name}
     📏 Відстань: {distance} км
     💰 Вартість: {fare} грн
     
     ⭐ Будь ласка, оцініть водія:",
    reply_markup=rating_keyboard  # [⭐] [⭐⭐] [⭐⭐⭐] [⭐⭐⭐⭐] [⭐⭐⭐⭐⭐] [Пропустити]
)

# 4. Повідомлення водію
"✅ Замовлення #{order_id} завершено!
 💰 Заробіток: {fare} грн
 💳 Комісія: {commission} грн
 💵 Чистий дохід: {net} грн
 🎉 Дякуємо за роботу!"

# 5. ПОВЕРНУТИСЯ ДО ПАНЕЛІ ВОДІЯ
reply_markup=driver_panel_keyboard()  # ✅ ГОЛОВНА ПАНЕЛЬ
```

---

## 📱 МЕНШІ КНОПКИ

### ❌ Відмовитися

**Призначення:**
- Водій відмовляється від замовлення
- Замовлення повертається іншим водіям

**Логіка:**
```python
# 1. Скасувати замовлення
await cancel_order_by_driver(db_path, order_id, driver_id, "Водій відмовився")
# Замовлення: статус → 'pending', driver_id → NULL

# 2. Повідомити клієнта
await bot.send_message(
    client_id,
    "❌ Водій відмовився від замовлення
     🚗 {driver_name}
     
     Ваше замовлення повернуто в загальну чергу.
     Шукаємо іншого водія..."
)

# 3. Логування для статистики
logger.warning(f"⚠️ Водій {driver_name} відмовився від замовлення #{order_id}")

# 4. Повернутися до панелі
"❌ Ви відмовилися від замовлення
 Замовлення повернуто іншим водіям."
reply_markup=driver_panel_keyboard()
```

**Використання для статистики:**
- Скільки разів водій відмовлявся
- Причини відмов
- Аналіз проблемних маршрутів

---

### 📞 Зв'язатися з клієнтом

**Призначення:**
- Показати контакти клієнта
- Номер телефону (копіювання)

**Логіка:**
```python
# Отримати активне замовлення
order = await get_active_order_for_driver(db_path, driver_id)

# Показати контакти
await message.answer(
    "📞 Контакти клієнта:
     
     👤 Ім'я: {order.name}
     📱 Телефон: {order.phone}
     
     💡 Натисніть на номер щоб скопіювати"
)
```

**Випадки використання:**
- Уточнити адресу
- Повідомити про затримку
- Узгодити деталі

---

### ℹ️ Допомога

**Призначення:**
- Інструкції для водія
- Пояснення етапів поїздки

**Текст:**
```
ℹ️ Допомога - Керування поїздкою

Крок 1: 🚗 В дорозі
Натисніть коли почнете рух до клієнта

Крок 2: 📍 На місці
Натисніть коли приїдете на адресу подачі

Крок 3: 🚀 Виконую замовлення
Натисніть коли клієнт сів і ви почали поїздку

Крок 4: 🏁 Завершити
Натисніть коли доїхали до призначення

━━━━━━━━━━━━━━━

Додаткові кнопки:

❌ Відмовитися - скасувати замовлення
📞 Зв'язатися - номер телефону клієнта
💬 Підтримка - зв'язок з адміністрацією
```

---

### 💬 Підтримка

**Призначення:**
- Прямий зв'язок з адміністратором
- Швидке вирішення проблем

**Логіка:**
```python
# Отримати ID адміна з конфігу
admin_id = config.bot.admin_ids[0]
admin_link = f"tg://user?id={admin_id}"

# Inline кнопка з посиланням
kb = InlineKeyboardMarkup(
    inline_keyboard=[
        [InlineKeyboardButton(text="📨 Написати адміну", url=admin_link)]
    ]
)

await message.answer(
    "💬 Зв'язок з підтримкою
     
     Натисніть кнопку нижче щоб написати адміністратору:
     
     💡 Опишіть вашу проблему детально",
    reply_markup=kb
)
```

**Випадки використання:**
- Технічні проблеми
- Конфліктні ситуації
- Питання по оплаті

---

## 💻 КОД

### 1. Функція клавіатури

**Файл:** `app/handlers/driver_panel.py`

```python
def driver_panel_keyboard() -> ReplyKeyboardMarkup:
    """Клавіатура панелі водія"""
    return ReplyKeyboardMarkup(
        keyboard=[
            [KeyboardButton(text="🚀 Почати роботу")],
            [KeyboardButton(text="📊 Мій заробіток"), KeyboardButton(text="💳 Комісія")],
            [KeyboardButton(text="📜 Історія поїздок"), KeyboardButton(text="💼 Гаманець")],
            [KeyboardButton(text="📊 Розширена аналітика")],
            [KeyboardButton(text="👤 Кабінет клієнта"), KeyboardButton(text="ℹ️ Допомога")]
        ],
        resize_keyboard=True
    )
```

---

### 2. Початкова клавіатура (при прийнятті)

**Файл:** `app/handlers/driver_panel.py` → `accept()`

```python
# ⭐ REPLY KEYBOARD з великою кнопкою
from aiogram.types import ReplyKeyboardMarkup, KeyboardButton

kb_trip = ReplyKeyboardMarkup(
    keyboard=[
        # ВЕЛИКА КНОПКА (перший ряд - вся ширина)
        [KeyboardButton(text="🚗 В дорозі")],
        # МЕНШІ КНОПКИ (по 2 в ряд)
        [
            KeyboardButton(text="❌ Відмовитися"),
            KeyboardButton(text="📞 Зв'язатися з клієнтом")
        ],
        [
            KeyboardButton(text="ℹ️ Допомога"),
            KeyboardButton(text="💬 Підтримка")
        ]
    ],
    resize_keyboard=True,  # Автоматично підігнати розмір
    one_time_keyboard=False  # Не ховати клавіатуру
)

await bot.send_message(
    driver_id,
    trip_info_text,  # Інформація про замовлення
    reply_markup=kb_trip
)
```

---

### 3. Обробник "🚗 В дорозі"

```python
@router.message(F.text == "🚗 В дорозі")
async def trip_in_progress_button(message: Message) -> None:
    """Водій натиснув 'В дорозі' → змінити на 'На місці'"""
    driver = await get_driver_by_tg_user_id(db_path, message.from_user.id)
    order = await get_active_order_for_driver(db_path, driver.id)
    
    # Оновити статус
    await start_order(db_path, order.id, driver.id)
    
    # ⭐ ЗМІНИТИ КНОПКУ
    kb_trip = ReplyKeyboardMarkup(
        keyboard=[
            [KeyboardButton(text="📍 На місці")],  # ← ЗМІНЕНО!
            [
                KeyboardButton(text="❌ Відмовитися"),
                KeyboardButton(text="📞 Зв'язатися з клієнтом")
            ],
            [
                KeyboardButton(text="ℹ️ Допомога"),
                KeyboardButton(text="💬 Підтримка")
            ]
        ],
        resize_keyboard=True,
        one_time_keyboard=False
    )
    
    await message.answer(
        f"✅ В дорозі до клієнта!\n"
        f"🚗 Рухайтесь до адреси:\n"
        f"📍 {order.pickup_address}\n\n"
        f"👇 Натисніть кнопку коли приїдете",
        reply_markup=kb_trip
    )
```

---

### 4. Обробник "📍 На місці"

```python
@router.message(F.text == "📍 На місці")
async def trip_arrived_button(message: Message) -> None:
    """Водій натиснув 'На місці' → змінити на 'Виконую замовлення'"""
    driver = await get_driver_by_tg_user_id(db_path, message.from_user.id)
    order = await get_active_order_for_driver(db_path, driver.id)
    
    # Повідомити клієнта
    await bot.send_message(
        order.user_id,
        f"📍 Водій на місці!\n"
        f"🚗 {driver.full_name}\n"
        f"📱 {driver.phone}\n\n"
        f"Водій чекає на вас!"
    )
    
    # ⭐ ЗМІНИТИ КНОПКУ
    kb_trip = ReplyKeyboardMarkup(
        keyboard=[
            [KeyboardButton(text="🚀 Виконую замовлення")],  # ← ЗМІНЕНО!
            # ... інші кнопки
        ],
        resize_keyboard=True
    )
    
    await message.answer(
        f"✅ На місці подачі!\n"
        f"👋 Зустрічайте клієнта...",
        reply_markup=kb_trip
    )
```

---

### 5. Обробник "🚀 Виконую замовлення"

```python
@router.message(F.text == "🚀 Виконую замовлення")
async def trip_executing_button(message: Message) -> None:
    """Змінити на 'Завершити'"""
    # ... отримати driver, order
    
    # ⭐ ЗМІНИТИ КНОПКУ
    kb_trip = ReplyKeyboardMarkup(
        keyboard=[
            [KeyboardButton(text="🏁 Завершити")],  # ← ЗМІНЕНО!
            # ... інші кнопки
        ]
    )
    
    await message.answer(
        f"🚀 Виконуєте замовлення!\n"
        f"🎯 Напрямок: {order.destination}\n"
        f"💰 Вартість: {order.fare} грн",
        reply_markup=kb_trip
    )
```

---

### 6. Обробник "🏁 Завершити"

```python
@router.message(F.text == "🏁 Завершити")
async def trip_complete_button(message: Message) -> None:
    """Завершити замовлення"""
    driver = await get_driver_by_tg_user_id(db_path, message.from_user.id)
    order = await get_active_order_for_driver(db_path, driver.id)
    
    # Розрахунок
    fare = order.fare_amount
    commission = fare * commission_rate
    
    # Завершити
    await complete_order(db_path, order.id, driver.id, fare, distance, duration, commission)
    
    # Записати платіж
    await insert_payment(db_path, payment)
    
    # Запит на оцінку клієнту
    await bot.send_message(
        order.user_id,
        "🏁 Поїздка завершена!\n⭐ Оцініть водія:",
        reply_markup=rating_kb
    )
    
    # ⭐ ПОВЕРНУТИСЯ ДО ПАНЕЛІ
    await message.answer(
        f"✅ Замовлення завершено!\n"
        f"💰 Заробіток: {fare} грн\n"
        f"💵 Чистий: {net} грн",
        reply_markup=driver_panel_keyboard()  # ← ПАНЕЛЬ ВОДІЯ!
    )
```

---

### 7. Функції БД

**Файл:** `app/storage/db.py`

```python
async def get_active_order_for_driver(db_path: str, driver_id: int) -> Optional[Order]:
    """Отримати активне замовлення водія (accepted або in_progress)"""
    async with db_manager.connect(db_path) as db:
        cursor = await db.execute(
            """
            SELECT * FROM orders 
            WHERE driver_id = ? AND status IN ('accepted', 'in_progress')
            ORDER BY created_at DESC
            LIMIT 1
            """,
            (driver_id,)
        )
        row = await cursor.fetchone()
        
        if not row:
            return None
        
        return Order(...)  # Створити об'єкт Order


async def cancel_order_by_driver(
    db_path: str, 
    order_id: int, 
    driver_id: int, 
    reason: str = "Driver cancelled"
) -> bool:
    """
    Скасувати замовлення водієм.
    
    - Перевіряє що це замовлення цього водія
    - Повертає статус на 'pending'
    - Прибирає driver_id (NULL)
    - Логує причину
    """
    async with db_manager.connect(db_path) as db:
        # Перевірка
        cursor = await db.execute(
            "SELECT id FROM orders WHERE id = ? AND driver_id = ? AND status IN ('accepted', 'in_progress')",
            (order_id, driver_id)
        )
        row = await cursor.fetchone()
        
        if not row:
            return False
        
        # Скасувати
        await db.execute(
            "UPDATE orders SET status = 'pending', driver_id = NULL WHERE id = ?",
            (order_id,)
        )
        await db.commit()
        
        logger.warning(f"⚠️ Водій #{driver_id} скасував #{order_id}: {reason}")
        return True
```

---

## 📊 ПЕРЕВАГИ

### Для водіїв:

✅ **Велика кнопка** - легко натиснути під час водіння  
✅ **Завжди видима** - Reply Keyboard не ховається  
✅ **Зрозуміла прогресія** - 4 етапи з емодзі  
✅ **Швидкий доступ** - контакти, допомога, підтримка  
✅ **Можливість відмовитися** - без страху перед бан  

---

### Для клієнтів:

✅ **Повідомлення в реальному часі** - "Водій на місці!"  
✅ **Запит на оцінку** - покращення сервісу  
✅ **Прозорість** - знають що водій в дорозі  

---

### Для бізнесу:

✅ **Статистика відмов** - аналіз проблемних маршрутів  
✅ **Логування** - всі дії записуються  
✅ **Кращий UX** - менше помилок водіїв  
✅ **Швидший сервіс** - менше натискань  

---

## 🔄 ПОРІВНЯННЯ

### Inline Keyboard (старий спосіб):

```
❌ Маленькі кнопки
❌ В повідомленні (прокрутка)
❌ Можуть зникнути
❌ Важко натискати в русі
❌ Немає допомоги
❌ Немає підтримки
```

### Reply Keyboard (новий спосіб):

```
✅ ВЕЛИКА кнопка (половина екрану)
✅ Завжди внизу екрану
✅ Не зникає
✅ Легко натискати
✅ Є допомога (ℹ️)
✅ Є підтримка (💬)
✅ Можна відмовитися (❌)
✅ Швидкий зв'язок (📞)
```

---

## 🧪 ТЕСТУВАННЯ

### Тест 1: Повний цикл поїздки

**Дії:**
1. Водій приймає замовлення → отримує Reply Keyboard
2. Натискає "🚗 В дорозі"
3. Натискає "📍 На місці"
4. Натискає "🚀 Виконую замовлення"
5. Натискає "🏁 Завершити"

**Очікуваний результат:**
- ✅ Кнопка змінюється на кожному етапі
- ✅ Клієнт отримує повідомлення "На місці"
- ✅ Замовлення завершується
- ✅ Клієнт отримує запит на оцінку
- ✅ Водій повертається до панелі

---

### Тест 2: Відмова від замовлення

**Дії:**
1. Водій приймає замовлення
2. Натискає "❌ Відмовитися"

**Очікуваний результат:**
- ✅ Замовлення скасовано
- ✅ Статус: `pending`
- ✅ `driver_id`: `NULL`
- ✅ Клієнт отримує повідомлення
- ✅ Водій повертається до панелі
- ✅ Логування: "Водій відмовився"

---

### Тест 3: Зв'язок з клієнтом

**Дії:**
1. Водій приймає замовлення
2. Натискає "📞 Зв'язатися з клієнтом"

**Очікуваний результат:**
- ✅ Показується ім'я і телефон
- ✅ Телефон можна скопіювати

---

### Тест 4: Допомога

**Дії:**
1. Водій натискає "ℹ️ Допомога"

**Очікуваний результат:**
- ✅ Показуються інструкції
- ✅ Описані всі 4 етапи
- ✅ Описані додаткові кнопки

---

### Тест 5: Підтримка

**Дії:**
1. Водій натискає "💬 Підтримка"

**Очікуваний результат:**
- ✅ Показується inline кнопка з посиланням
- ✅ Посилання веде в чат з адміном

---

## 🎉 РЕЗУЛЬТАТ

### Було:
```
❌ Inline кнопки
❌ Маленькі
❌ Ховаються
❌ В повідомленні
❌ Важко натискати
```

### Стало:
```
✅ Reply Keyboard
✅ ВЕЛИКА кнопка зверху
✅ Завжди видима
✅ Внизу екрану
✅ Легко натискати
✅ 4 етапи прогресії
✅ Додаткові функції (відмова, зв'язок, допомога, підтримка)
✅ Статистика відмов
✅ Логування
✅ Повернення до панелі
```

---

**ВЕЛИКА КНОПКА ГОТОВА!** 🎯✅🚀
