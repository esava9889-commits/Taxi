# üêõ BUGFIX: SavedAddressStates + –ü–æ—Ç—ñ–∫ –∞–¥—Ä–µ—Å

**–î–∞—Ç–∞:** 2025-10-17  
**–¢–∏–ø:** Critical Bug + UX Bug  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –í–ò–ü–†–ê–í–õ–ï–ù–û

---

## üî¥ –ü–†–û–ë–õ–ï–ú–ê #1: NameError

### –ü–æ–º–∏–ª–∫–∞:
```
NameError: name 'SavedAddressStates' is not defined
```

### –ü—Ä–∏—á–∏–Ω–∞:
**–î—É–±–ª—é–≤–∞–Ω–Ω—è handlers** - `start.py` —ñ `saved_addresses.py` –æ–±–∏–¥–≤–∞ –º–∞–ª–∏ handlers –¥–ª—è –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è –∞–¥—Ä–µ—Å, –∞–ª–µ –∑ —Ä—ñ–∑–Ω–∏–º–∏ –Ω–∞–∑–≤–∞–º–∏ –∫–ª–∞—Å—ñ–≤:

```python
# start.py:
await state.set_state(SavedAddressStates.name)  # ‚ùå –ù–ï –í–ò–ó–ù–ê–ß–ï–ù–ò–ô

# saved_addresses.py:
class SaveAddressStates(StatesGroup):  # ‚úÖ –í–ò–ó–ù–ê–ß–ï–ù–ò–ô
    name = State()
    emoji = State()
    address = State()
```

---

## üî¥ –ü–†–û–ë–õ–ï–ú–ê #2: –ó–∞–≤–∏—Å–∞–Ω–Ω—è –ø—ñ—Å–ª—è –≤–∏–±–æ—Ä—É –∞–¥—Ä–µ—Å–∏

### –°–∏–º–ø—Ç–æ–º:
```
–ö–ª—ñ—î–Ω—Ç:
1. –í—ñ–¥–∫—Ä–∏–≤–∞—î "üìç –ú–æ—ó –∞–¥—Ä–µ—Å–∏"
2. –û–±–∏—Ä–∞—î –∞–¥—Ä–µ—Å—É "üéØ –á—Ö–∞—Ç–∏ —Å—é–¥–∏"
3. ...
4. –ù–Ü–ß–û–ì–û –ù–ï –í–Ü–î–ë–£–í–ê–Ñ–¢–¨–°–Ø! ‚ùå
```

### –ü—Ä–∏—á–∏–Ω–∞:
–í `saved_addresses.py`, handler `use_saved_address()` –ø—ñ—Å–ª—è –≤–∏–±–æ—Ä—É –ø—É–Ω–∫—Ç—É –ø—Ä–∏–∑–Ω–∞—á–µ–Ω–Ω—è –ø–µ—Ä–µ—Ö–æ–¥–∏–≤ –¥–æ `OrderStates.comment`, –∞–ª–µ **–ù–ï –ø–æ–∫–∞–∑—É–≤–∞–≤ –≤–∏–±—ñ—Ä –∫–ª–∞—Å—É –∞–≤—Ç–æ –∑ —Ü—ñ–Ω–∞–º–∏!**

```python
# saved_addresses.py (–ë–£–õ–û):
if data.get("pickup"):
    await state.set_state(OrderStates.comment)  # ‚ùå –û–¥—Ä–∞–∑—É –¥–æ –∫–æ–º–µ–Ω—Ç–∞—Ä—è
    await call.message.answer("–î–æ–¥–∞–π—Ç–µ –∫–æ–º–µ–Ω—Ç–∞—Ä...")
    # –ö–ª—ñ—î–Ω—Ç –ù–ï –±–∞—á–∏—Ç—å —Ü—ñ–Ω–∏!
```

---

## ‚úÖ –í–ò–ü–†–ê–í–õ–ï–ù–ù–Ø #1: –í–∏–¥–∞–ª–µ–Ω–æ –¥—É–±–ª—ñ–∫–∞—Ç–∏

### –©–æ –∑—Ä–æ–±–∏–ª–∏:
–í–∏–¥–∞–ª–µ–Ω–æ **208 —Ä—è–¥–∫—ñ–≤ –¥—É–±–ª—ñ–∫–∞—Ç—ñ–≤** –∑ `start.py` (—Ä—è–¥–∫–∏ 538-745):

**–í–∏–¥–∞–ª–µ–Ω—ñ handlers:**
- `start_add_address()` - –ø–æ—á–∞—Ç–æ–∫ –¥–æ–¥–∞–≤–∞–Ω–Ω—è
- `process_address_name()` - –Ω–∞–∑–≤–∞ –∞–¥—Ä–µ—Å–∏
- `process_address_emoji()` - –µ–º–æ–¥–∑—ñ
- `process_address_location()` - –≥–µ–æ–ª–æ–∫–∞—Ü—ñ—è
- `process_address_text()` - —Ç–µ–∫—Å—Ç–æ–≤–∞ –∞–¥—Ä–µ—Å–∞

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
```python
# start.py:
# –í–∏–¥–∞–ª–µ–Ω–æ –≤—Å—ñ –¥—É–±–ª—ñ–∫–∞—Ç–∏ ‚úÖ
# –ó–∞–ª–∏—à–∏–ª–∏—Å—å —Ç—ñ–ª—å–∫–∏ –æ—Å–Ω–æ–≤–Ω—ñ —Ñ—É–Ω–∫—Ü—ñ—ó

# saved_addresses.py:
class SaveAddressStates(StatesGroup):  # –¢–Ü–õ–¨–ö–ò –¢–£–¢ ‚úÖ
    name = State()
    emoji = State()
    address = State()
```

---

## ‚úÖ –í–ò–ü–†–ê–í–õ–ï–ù–ù–Ø #2: –ü–æ–∫–∞–∑ —Ü—ñ–Ω –ø—ñ—Å–ª—è –≤–∏–±–æ—Ä—É –∞–¥—Ä–µ—Å–∏

### –©–æ –∑—Ä–æ–±–∏–ª–∏:
–û–Ω–æ–≤–ª–µ–Ω–æ `saved_addresses.py`, handler `use_saved_address()`:

**–ë–£–õ–û:**
```python
if data.get("pickup"):
    await state.set_state(OrderStates.comment)
    await call.message.answer("–î–æ–¥–∞–π—Ç–µ –∫–æ–º–µ–Ω—Ç–∞—Ä...")
    # ‚ùå –ö–ª—ñ—î–Ω—Ç –ù–ï –±–∞—á–∏—Ç—å —Ü—ñ–Ω–∏
```

**–°–¢–ê–õ–û:**
```python
if data.get("pickup"):
    # –ü–æ–∫–∞–∑–∞—Ç–∏ –∫–ª–∞—Å–∏ –∞–≤—Ç–æ –∑ —Ü—ñ–Ω–∞–º–∏
    from app.handlers.order import show_car_class_selection_with_prices
    await show_car_class_selection_with_prices(call.message, state, config)
    # ‚úÖ –ö–ª—ñ—î–Ω—Ç –ë–ê–ß–ò–¢–¨ —Ü—ñ–Ω–∏!
```

### –î–æ–¥–∞—Ç–∫–æ–≤–∞ –∑–º—ñ–Ω–∞ –≤ `order.py`:
–§—É–Ω–∫—Ü—ñ—è `show_car_class_selection_with_prices()` —Ç–µ–ø–µ—Ä –ø—Ä–∏–π–º–∞—î `config` —è–∫ –ø–∞—Ä–∞–º–µ—Ç—Ä:

```python
# order.py (–ë–£–õ–û):
async def show_car_class_selection_with_prices(message, state):
    # –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞–ª–∞ config –∑ –∑–∞–º–∏–∫–∞–Ω–Ω—è

# order.py (–°–¢–ê–õ–û):
async def show_car_class_selection_with_prices(message, state, config_param=None):
    if config_param is None:
        config_param = config  # Fallback –¥–ª—è —Å—Ç–∞—Ä–∏—Ö –≤–∏–∫–ª–∏–∫—ñ–≤
    # –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î config_param
```

---

## üîÑ –ù–û–í–ò–ô –ü–û–¢–Ü–ö (–ü–Ü–°–õ–Ø –í–ò–ü–†–ê–í–õ–ï–ù–ù–Ø)

### –°—Ü–µ–Ω–∞—Ä—ñ–π: –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è –∑–±–µ—Ä–µ–∂–µ–Ω–æ—ó –∞–¥—Ä–µ—Å–∏

```
1. –ö–ª—ñ—î–Ω—Ç –Ω–∞—Ç–∏—Å–∫–∞—î "üìç –ú–æ—ó –∞–¥—Ä–µ—Å–∏"
    ‚Üì
2. –û–±–∏—Ä–∞—î –∞–¥—Ä–µ—Å—É
    ‚Üì
3. –ù–∞—Ç–∏—Å–∫–∞—î "üöñ –ü–æ–¥–∞—Ç–∏ —Å—é–¥–∏" (pickup)
    ‚Üì
   saved_addresses.py: use_saved_address()
   ‚úÖ pickup_lat, pickup_lon –∑–± –µ—Ä–µ–∂–µ–Ω–æ
   ‚úÖ –ü–µ—Ä–µ—Ö—ñ–¥ –¥–æ OrderStates.destination
    ‚Üì
4. –ö–ª—ñ—î–Ω—Ç –≤–≤–æ–¥–∏—Ç—å "–ö—É–¥–∏?"
    ‚Üì
   order.py: destination_location() –∞–±–æ destination_text()
   ‚úÖ dest_lat, dest_lon –∑–±–µ—Ä–µ–∂–µ–Ω–æ
   ‚úÖ –í–∏–∫–ª–∏–∫ show_car_class_selection_with_prices()
    ‚Üì
5. –°–ò–°–¢–ï–ú–ê –ü–û–ö–ê–ó–£–Ñ:
   üìè –í—ñ–¥—Å—Ç–∞–Ω—å: 5.2 –∫–º
   ‚è± –ß–∞—Å: 12 —Ö–≤
   üí∞ –¶—ñ–Ω–∏:
   üöó –ï–∫–æ–Ω–æ–º - 120 –≥—Ä–Ω
   üöô –°—Ç–∞–Ω–¥–∞—Ä—Ç - 156 –≥—Ä–Ω
   üöò –ö–æ–º—Ñ–æ—Ä—Ç - 192 –≥—Ä–Ω
   üèÜ –ë—ñ–∑–Ω–µ—Å - 240 –≥—Ä–Ω
    ‚Üì
6. –ö–ª—ñ—î–Ω—Ç –æ–±–∏—Ä–∞—î –∫–ª–∞—Å ‚Üí –ö–æ–º–µ–Ω—Ç–∞—Ä ‚Üí –û–ø–ª–∞—Ç–∞ ‚Üí –ü—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è
```

### –ê–ë–û: –í–∏–±—ñ—Ä –ø—É–Ω–∫—Ç—É –ø—Ä–∏–∑–Ω–∞—á–µ–Ω–Ω—è –∑—ñ –∑–±–µ—Ä–µ–∂–µ–Ω–∏—Ö –∞–¥—Ä–µ—Å

```
1. –ö–ª—ñ—î–Ω—Ç –≤–≤–æ–¥–∏—Ç—å "–ó–≤—ñ–¥–∫–∏?"
    ‚Üì
   ‚úÖ pickup –∑–±–µ—Ä–µ–∂–µ–Ω–æ
    ‚Üì
2. –ù–∞—Ç–∏—Å–∫–∞—î "üìç –ú–æ—ó –∞–¥—Ä–µ—Å–∏"
    ‚Üì
3. –û–±–∏—Ä–∞—î –∞–¥—Ä–µ—Å—É ‚Üí "üéØ –á—Ö–∞—Ç–∏ —Å—é–¥–∏" (dest)
    ‚Üì
   saved_addresses.py: use_saved_address()
   ‚úÖ dest_lat, dest_lon –∑–±–µ—Ä–µ–∂–µ–Ω–æ
   ‚úÖ –í–∏–∫–ª–∏–∫ show_car_class_selection_with_prices()  ‚Üê –ù–û–í–ò–ô –ö–û–î!
    ‚Üì
4. –°–ò–°–¢–ï–ú–ê –û–î–†–ê–ó–£ –ü–û–ö–ê–ó–£–Ñ –¶–Ü–ù–ò:
   üìè –í—ñ–¥—Å—Ç–∞–Ω—å: 3.8 –∫–º
   ‚è± –ß–∞—Å: 10 —Ö–≤
   üí∞ –¶—ñ–Ω–∏ –¥–ª—è –≤—Å—ñ—Ö –∫–ª–∞—Å—ñ–≤
    ‚Üì
5. –ö–ª—ñ—î–Ω—Ç –æ–±–∏—Ä–∞—î ‚Üí –ö–æ–º–µ–Ω—Ç–∞—Ä ‚Üí –û–ø–ª–∞—Ç–∞ ‚Üí –ü—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è
```

---

## üìä –°–¢–ê–¢–ò–°–¢–ò–ö–ê –ó–ú–Ü–ù

### start.py:
```
–ë—É–ª–æ: 903 —Ä—è–¥–∫–∏
–í–∏–¥–∞–ª–µ–Ω–æ: -208 —Ä—è–¥–∫—ñ–≤ (–¥—É–±–ª—ñ–∫–∞—Ç–∏)
–°—Ç–∞–ª–æ: 695 —Ä—è–¥–∫—ñ–≤
–ó–º–µ–Ω—à–µ–Ω–Ω—è: -23%
```

### saved_addresses.py:
```
–ë—É–ª–æ: 413 —Ä—è–¥–∫—ñ–≤
–î–æ–¥–∞–Ω–æ: +2 —Ä—è–¥–∫–∏ (–≤–∏–∫–ª–∏–∫ —Ñ—É–Ω–∫—Ü—ñ—ó)
–°—Ç–∞–ª–æ: 415 —Ä—è–¥–∫—ñ–≤
```

### order.py:
```
–ó–º—ñ–Ω–µ–Ω–æ: —Ñ—É–Ω–∫—Ü—ñ—è show_car_class_selection_with_prices()
–î–æ–¥–∞–Ω–æ: –ø–∞—Ä–∞–º–µ—Ç—Ä config_param
–ú–µ—Ç–∞: –ø—ñ–¥—Ç—Ä–∏–º–∫–∞ –≤–∏–∫–ª–∏–∫—É –∑ —ñ–Ω—à–∏—Ö –º–æ–¥—É–ª—ñ–≤
```

---

## ‚úÖ –†–ï–ó–£–õ–¨–¢–ê–¢

### –î–û (2 –ü–†–û–ë–õ–ï–ú–ò):
```
‚ùå NameError: SavedAddressStates
‚ùå –î—É–±–ª—é–≤–∞–Ω–Ω—è 208 —Ä—è–¥–∫—ñ–≤
‚ùå –ü—ñ—Å–ª—è –≤–∏–±–æ—Ä—É –∞–¥—Ä–µ—Å–∏ –Ω—ñ—á–æ–≥–æ –Ω–µ –≤—ñ–¥–±—É–≤–∞—î—Ç—å—Å—è
‚ùå –ö–ª—ñ—î–Ω—Ç –ù–ï –±–∞—á–∏—Ç—å —Ü—ñ–Ω–∏
```

### –ü–Ü–°–õ–Ø (–í–°–ï –ü–†–ê–¶–Æ–Ñ):
```
‚úÖ SavedAddressStates —Ç—ñ–ª—å–∫–∏ –≤ saved_addresses.py
‚úÖ –ù–µ–º–∞—î –¥—É–±–ª—é–≤–∞–Ω–Ω—è
‚úÖ –ü—ñ—Å–ª—è –≤–∏–±–æ—Ä—É –∞–¥—Ä–µ—Å–∏ –ø–æ–∫–∞–∑—É—é—Ç—å—Å—è —Ü—ñ–Ω–∏
‚úÖ –ö–ª—ñ—î–Ω—Ç –ë–ê–ß–ò–¢–¨ –≤—ñ–¥—Å—Ç–∞–Ω—å, —á–∞—Å —Ç–∞ —Ü—ñ–Ω–∏ –¥–ª—è –≤—Å—ñ—Ö –∫–ª–∞—Å—ñ–≤
‚úÖ UX –ø–æ–∫—Ä–∞—â–µ–Ω–∏–π
```

---

## üéØ –í–ò–°–ù–û–í–û–ö

**–ü—Ä–æ–±–ª–µ–º–∞ 1:** –î—É–±–ª—é–≤–∞–Ω–Ω—è –∫–æ–¥—É ‚Üí NameError  
**–†—ñ—à–µ–Ω–Ω—è 1:** –í–∏–¥–∞–ª–µ–Ω–æ 208 —Ä—è–¥–∫—ñ–≤ –¥—É–±–ª—ñ–∫–∞—Ç—ñ–≤  

**–ü—Ä–æ–±–ª–µ–º–∞ 2:** –ó–∞–≤–∏—Å–∞–Ω–Ω—è –ø—ñ—Å–ª—è –≤–∏–±–æ—Ä—É –∞–¥—Ä–µ—Å–∏  
**–†—ñ—à–µ–Ω–Ω—è 2:** –î–æ–¥–∞–Ω–æ –≤–∏–∫–ª–∏–∫ show_car_class_selection_with_prices()  

**–°—Ç–∞—Ç—É—Å:** ‚úÖ **–û–ë–ò –î–í–Ü –ü–†–û–ë–õ–ï–ú–ò –í–ò–ü–†–ê–í–õ–ï–ù–Ü**

---

**–î–∞—Ç–∞ –≤–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è:** 2025-10-17  
**Commit:** `b894c36`  
**Branch:** `fix-taxi-bot`  
**–ß–∞—Å –≤–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è:** 15 —Ö–≤–∏–ª–∏–Ω
