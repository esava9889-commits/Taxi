# üîß –í–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è FSM Strategy - Live Location –Ω–µ –ø—Ä–∞—Ü—é–≤–∞–ª–∞

**–î–∞—Ç–∞:** 2025-10-27  
**–ü—Ä–æ–±–ª–µ–º–∞:** –ü—ñ—Å–ª—è –Ω–∞–¥—Å–∏–ª–∞–Ω–Ω—è –≥–µ–æ–ª–æ–∫–∞—Ü—ñ—ó –Ω–µ –≤—ñ–¥–±—É–≤–∞–ª–æ—Å—å –Ω–∞–¥—Å–∏–ª–∞–Ω–Ω—è live location —ñ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è –Ω–µ —Å—Ç–∞–≤–∞–ª–æ –∞–∫—Ç–∏–≤–Ω–∏–º

## üêõ –ü—Ä–∏—á–∏–Ω–∞ –ø—Ä–æ–±–ª–µ–º–∏

### –ö–æ–Ω—Ñ–ª—ñ–∫—Ç FSM storage strategy

**MemoryStorage** –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î —Å—Ç—Ä–∞—Ç–µ–≥—ñ—é: `FSMStrategy.CHAT` = `(user_id, chat_id)`

#### –ü–æ—Å–ª—ñ–¥–æ–≤–Ω—ñ—Å—Ç—å –ø–æ–¥—ñ–π (–î–û –≤–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è):

```
1. –í–æ–¥—ñ–π –Ω–∞—Ç–∏—Å–∫–∞—î "‚úÖ –ü—Ä–∏–π–Ω—è—Ç–∏ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è" –≤ –ì–†–£–ü–Ü –≤–æ–¥—ñ—ó–≤
   ‚îî‚îÄ FSM —Å—Ç–∞–Ω –≤—Å—Ç–∞–Ω–æ–≤–ª—é—î—Ç—å—Å—è: (driver_id, GROUP_CHAT_ID)

2. –ë–æ—Ç –≤—ñ–¥–ø—Ä–∞–≤–ª—è—î –∑–∞–ø–∏—Ç –≥–µ–æ–ª–æ–∫–∞—Ü—ñ—ó –≤ –ü–†–ò–í–ê–¢–ù–ò–ô –ß–ê–¢ –≤–æ–¥—ñ—è
   ‚îî‚îÄ –í–æ–¥—ñ–π –Ω–∞—Ç–∏—Å–∫–∞—î "üìç –ù–∞–¥—ñ—Å–ª–∞—Ç–∏ –≥–µ–æ–ª–æ–∫–∞—Ü—ñ—é"

3. –ì–µ–æ–ª–æ–∫–∞—Ü—ñ—è –Ω–∞–¥—Å–∏–ª–∞—î—Ç—å—Å—è –≤ –ü–†–ò–í–ê–¢–ù–ò–ô –ß–ê–¢
   ‚îî‚îÄ FSM —à—É–∫–∞—î —Å—Ç–∞–Ω: (driver_id, PRIVATE_CHAT_ID)
   ‚îî‚îÄ ‚ùå –°–¢–ê–ù –ù–ï –ó–ù–ê–ô–î–ï–ù–û! (–±–æ –±—É–≤ –∑–±–µ—Ä–µ–∂–µ–Ω–∏–π –¥–ª—è GROUP_CHAT_ID)

4. –û–±—Ä–æ–±–Ω–∏–∫ handle_location_for_accept_order –ù–ï –°–ü–†–ê–¶–¨–û–í–£–Ñ
   ‚îî‚îÄ Live location –Ω–µ –Ω–∞–¥—Å–∏–ª–∞—î—Ç—å—Å—è
   ‚îî‚îÄ –ó–∞–º–æ–≤–ª–µ–Ω–Ω—è –∑–∞–ª–∏—à–∞—î—Ç—å—Å—è –≤ —Å—Ç–∞—Ç—É—Å—ñ pending
```

## ‚úÖ –†—ñ—à–µ–Ω–Ω—è

### –ó–º—ñ–Ω–µ–Ω–æ FSM Strategy –Ω–∞ USER

**–§–∞–π–ª:** `app/main.py` (—Ä—è–¥–∫–∏ 161-168)

#### –ë—É–ª–æ:
```python
bot = Bot(token=config.bot.token, default=DefaultBotProperties(parse_mode="HTML"))
dp = Dispatcher(storage=MemoryStorage())
```

#### –°—Ç–∞–ª–æ:
```python
from aiogram.fsm.strategy import FSMStrategy

bot = Bot(token=config.bot.token, default=DefaultBotProperties(parse_mode="HTML"))

# ‚≠ê FSM Strategy: GLOBAL_USER - –∑–±–µ—Ä—ñ–≥–∞—Ç–∏ —Å—Ç–∞–Ω —Ç—ñ–ª—å–∫–∏ –ø–æ user_id (–Ω–µ chat_id)
# –¶–µ –¥–æ–∑–≤–æ–ª—è—î –≤–æ–¥—ñ—é –Ω–∞—Ç–∏—Å–∫–∞—Ç–∏ "–ü—Ä–∏–π–Ω—è—Ç–∏" –≤ –≥—Ä—É–ø—ñ, –∞ –Ω–∞–¥—Å–∏–ª–∞—Ç–∏ –≥–µ–æ–ª–æ–∫–∞—Ü—ñ—é –≤ –ø—Ä–∏–≤–∞—Ç–Ω–∏–π —á–∞—Ç
dp = Dispatcher(
    storage=MemoryStorage(),
    fsm_strategy=FSMStrategy.GLOBAL_USER  # –¢—ñ–ª—å–∫–∏ user_id, –±–µ–∑ –ø—Ä–∏–≤'—è–∑–∫–∏ –¥–æ chat_id
)
```

### –Ø–∫ –ø—Ä–∞—Ü—é—î —Ç–µ–ø–µ—Ä:

```
1. –í–æ–¥—ñ–π –Ω–∞—Ç–∏—Å–∫–∞—î "‚úÖ –ü—Ä–∏–π–Ω—è—Ç–∏ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è" –≤ –ì–†–£–ü–Ü
   ‚îî‚îÄ FSM —Å—Ç–∞–Ω –≤—Å—Ç–∞–Ω–æ–≤–ª—é—î—Ç—å—Å—è: (driver_id) ‚Üê –±–µ–∑ chat_id!

2. –ë–æ—Ç –≤—ñ–¥–ø—Ä–∞–≤–ª—è—î –∑–∞–ø–∏—Ç –≥–µ–æ–ª–æ–∫–∞—Ü—ñ—ó –≤ –ü–†–ò–í–ê–¢–ù–ò–ô –ß–ê–¢

3. –ì–µ–æ–ª–æ–∫–∞—Ü—ñ—è –Ω–∞–¥—Å–∏–ª–∞—î—Ç—å—Å—è –≤ –ü–†–ò–í–ê–¢–ù–ò–ô –ß–ê–¢
   ‚îî‚îÄ FSM —à—É–∫–∞—î —Å—Ç–∞–Ω: (driver_id)
   ‚îî‚îÄ ‚úÖ –°–¢–ê–ù –ó–ù–ê–ô–î–ï–ù–û!

4. –û–±—Ä–æ–±–Ω–∏–∫ handle_location_for_accept_order –°–ü–†–ê–¶–¨–û–í–£–Ñ ‚úÖ
   ‚îú‚îÄ –ó–∞–º–æ–≤–ª–µ–Ω–Ω—è –ø—Ä–∏–π–º–∞—î—Ç—å—Å—è (accept_order)
   ‚îú‚îÄ Live location –≤—ñ–¥–ø—Ä–∞–≤–ª—è—î—Ç—å—Å—è –∫–ª—ñ—î–Ω—Ç—É
   ‚îú‚îÄ LiveLocationManager –∑–∞–ø—É—Å–∫–∞—î—Ç—å—Å—è
   ‚îú‚îÄ –ß–∞—Ç –æ—á–∏—â–∞—î—Ç—å—Å—è –≤—ñ–¥ —Ç–µ—Ö–Ω—ñ—á–Ω–∏—Ö –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å
   ‚îî‚îÄ –í–æ–¥—ñ–π –æ—Ç—Ä–∏–º—É—î –º–µ–Ω—é –∫–µ—Ä—É–≤–∞–Ω–Ω—è –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è–º
```

## üìä –ó–º—ñ–Ω–∏ –≤ –∫–æ–¥—ñ

### –ó–º—ñ–Ω–µ–Ω—ñ —Ñ–∞–π–ª–∏:
1. `app/main.py` - –¥–æ–¥–∞–Ω–æ FSMStrategy.USER

### –î–æ–¥–∞–Ω–æ:
- Import: `from aiogram.fsm.strategy import FSMStrategy`
- –ü–∞—Ä–∞–º–µ—Ç—Ä: `fsm_strategy=FSMStrategy.USER` –≤ Dispatcher

## üéØ –†–µ–∑—É–ª—å—Ç–∞—Ç

### –î–æ –≤–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è:
- ‚ùå –ì–µ–æ–ª–æ–∫–∞—Ü—ñ—è –Ω–µ –æ–±—Ä–æ–±–ª—è–ª–∞—Å—å
- ‚ùå Live location –Ω–µ –≤—ñ–¥–ø—Ä–∞–≤–ª—è–ª–æ—Å—å –∫–ª—ñ—î–Ω—Ç—É
- ‚ùå –ó–∞–º–æ–≤–ª–µ–Ω–Ω—è –∑–∞–ª–∏—à–∞–ª–æ—Å—å pending
- ‚ùå –í–æ–¥—ñ–π –Ω–µ –±–∞—á–∏–≤ –º–µ–Ω—é –∫–µ—Ä—É–≤–∞–Ω–Ω—è

### –ü—ñ—Å–ª—è –≤–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è:
- ‚úÖ –ì–µ–æ–ª–æ–∫–∞—Ü—ñ—è –æ–±—Ä–æ–±–ª—è—î—Ç—å—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ
- ‚úÖ Live location –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –≤—ñ–¥–ø—Ä–∞–≤–ª—è—î—Ç—å—Å—è –∫–ª—ñ—î–Ω—Ç—É
- ‚úÖ –ó–∞–º–æ–≤–ª–µ–Ω–Ω—è —Å—Ç–∞—î –∞–∫—Ç–∏–≤–Ω–∏–º
- ‚úÖ –í–æ–¥—ñ–π –æ—Ç—Ä–∏–º—É—î –º–µ–Ω—é –∫–µ—Ä—É–≤–∞–Ω–Ω—è –ø–æ—ó–∑–¥–∫–æ—é
- ‚úÖ LiveLocationManager –≤—ñ–¥—Å—Ç–µ–∂—É—î —Ä—É—Ö –≤–æ–¥—ñ—è 15 —Ö–≤–∏–ª–∏–Ω

## üîç –¢–µ—Ö–Ω—ñ—á–Ω—ñ –¥–µ—Ç–∞–ª—ñ

### FSM Strategy —Ç–∏–ø–∏ –≤ aiogram:

| Strategy | –ö–ª—é—á –∑–±–µ—Ä—ñ–≥–∞–Ω–Ω—è | –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è |
|----------|----------------|--------------|
| `CHAT` (default) | `(user_id, chat_id)` | –†—ñ–∑–Ω—ñ —Å—Ç–∞–Ω–∏ –≤ —Ä—ñ–∑–Ω–∏—Ö —á–∞—Ç–∞—Ö |
| `USER_IN_CHAT` | `(user_id, chat_id)` | –¢–µ —Å–∞–º–µ —â–æ CHAT (alias) |
| `GLOBAL_USER` | `(user_id)` | –ì–ª–æ–±–∞–ª—å–Ω–∏–π —Å—Ç–∞–Ω –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ |

### –ß–æ–º—É GLOBAL_USER –ø—ñ–¥—Ö–æ–¥–∏—Ç—å –¥–ª—è —Ç–∞–∫—Å—ñ-–±–æ—Ç–∞:

1. **–í–æ–¥—ñ–π –ø—Ä–∞—Ü—é—î –∑ –±–æ—Ç–æ–º –∑ —Ä—ñ–∑–Ω–∏—Ö —á–∞—Ç—ñ–≤:**
   - –ì—Ä—É–ø–∞ –≤–æ–¥—ñ—ó–≤ (–¥–ª—è –ø—Ä–∏–π–Ω—è—Ç—Ç—è –∑–∞–º–æ–≤–ª–µ–Ω—å)
   - –ü—Ä–∏–≤–∞—Ç–Ω–∏–π —á–∞—Ç (–¥–ª—è –∫–µ—Ä—É–≤–∞–Ω–Ω—è, –≥–µ–æ–ª–æ–∫–∞—Ü—ñ—ó)

2. **–°—Ç–∞–Ω –º–∞—î –±—É—Ç–∏ —î–¥–∏–Ω–∏–º:**
   - –í–æ–¥—ñ–π –Ω–µ –º–æ–∂–µ –æ–¥–Ω–æ—á–∞—Å–Ω–æ –±—É—Ç–∏ –≤ —Ä—ñ–∑–Ω–∏—Ö —Å—Ç–∞–Ω–∞—Ö
   - FSM –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è –¥–ª—è –ª—ñ–Ω—ñ–π–Ω–∏—Ö –ø—Ä–æ—Ü–µ—Å—ñ–≤ (–ø—Ä–∏–π–Ω—è—Ç—Ç—è ‚Üí –≥–µ–æ–ª–æ–∫–∞—Ü—ñ—è ‚Üí –∫–µ—Ä—É–≤–∞–Ω–Ω—è)

3. **–ë–µ–∑–ø–µ–∫–∞:**
   - –û–¥–∏–Ω –≤–æ–¥—ñ–π = –æ–¥–∏–Ω —Å—Ç–∞–Ω
   - –ù–µ–º–æ–∂–ª–∏–≤–æ —Å—Ç–≤–æ—Ä–∏—Ç–∏ –∫–æ–Ω—Ñ–ª—ñ–∫—Ç–∏ –º—ñ–∂ —á–∞—Ç–∞–º–∏

## üß™ –¢–µ—Å—Ç—É–≤–∞–Ω–Ω—è

### –†–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–∏–π –ø—Ä–æ—Ü–µ—Å —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è:

1. **–°—Ç–≤–æ—Ä–∏—Ç–∏ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è —è–∫ –∫–ª—ñ—î–Ω—Ç**
2. **–í–æ–¥—ñ–π –≤ –≥—Ä—É–ø—ñ –Ω–∞—Ç–∏—Å–∫–∞—î "‚úÖ –ü—Ä–∏–π–Ω—è—Ç–∏ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è"**
   - –ú–∞—î –ø—Ä–∏–π—Ç–∏ –∑–∞–ø–∏—Ç –≥–µ–æ–ª–æ–∫–∞—Ü—ñ—ó –≤ –ø—Ä–∏–≤–∞—Ç–Ω–∏–π —á–∞—Ç
3. **–í–æ–¥—ñ–π –Ω–∞–¥—Å–∏–ª–∞—î –≥–µ–æ–ª–æ–∫–∞—Ü—ñ—é –≤ –ø—Ä–∏–≤–∞—Ç–Ω–æ–º—É —á–∞—Ç—ñ**
   - ‚úÖ –ú–∞—î –Ω–∞–¥—ñ—Å–ª–∞—Ç–∏—Å—å live location –∫–ª—ñ—î–Ω—Ç—É
   - ‚úÖ –ó–∞–º–æ–≤–ª–µ–Ω–Ω—è –º–∞—î —Å—Ç–∞—Ç–∏ "accepted"
   - ‚úÖ –í–æ–¥—ñ–π –º–∞—î –æ—Ç—Ä–∏–º–∞—Ç–∏ –º–µ–Ω—é –∫–µ—Ä—É–≤–∞–Ω–Ω—è
   - ‚úÖ –¢–µ—Ö–Ω—ñ—á–Ω—ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –º–∞—é—Ç—å –≤–∏–¥–∞–ª–∏—Ç–∏—Å—å
4. **–ö–ª—ñ—î–Ω—Ç –æ—Ç—Ä–∏–º—É—î:**
   - –ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –ø—Ä–æ –ø—Ä–∏–π–Ω—è—Ç—Ç—è –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è
   - Live location –Ω–∞ –∫–∞—Ä—Ç—ñ (–æ–Ω–æ–≤–ª—é—î—Ç—å—Å—è –∫–æ–∂–Ω—ñ 20 —Å–µ–∫)
   - –Ü–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é –ø—Ä–æ –≤–æ–¥—ñ—è

## üìù –î–æ–¥–∞—Ç–∫–æ–≤—ñ –ø–µ—Ä–µ–≤–∞–≥–∏

### FSMStrategy.GLOBAL_USER –¥–∞—î:

1. **–°–ø—Ä–æ—â–µ–Ω–Ω—è –ª–æ–≥—ñ–∫–∏** - –Ω–µ –ø–æ—Ç—Ä—ñ–±–Ω–æ –¥—É–º–∞—Ç–∏ –ø—Ä–æ chat_id
2. **–£–Ω—ñ—Ñ—ñ–∫–∞—Ü—ñ—è** - –æ–¥–∏–Ω —Å—Ç–∞–Ω —É –≤—Å—ñ—Ö —á–∞—Ç–∞—Ö
3. **–ù–∞–¥—ñ–π–Ω—ñ—Å—Ç—å** - –Ω–µ–º–∞—î –∫–æ–Ω—Ñ–ª—ñ–∫—Ç—ñ–≤ –º—ñ–∂ —á–∞—Ç–∞–º–∏
4. **–ü–µ—Ä–µ–¥–±–∞—á—É–≤–∞–Ω—ñ—Å—Ç—å** - –≤–æ–¥—ñ–π –∑–∞–≤–∂–¥–∏ –≤ –æ–¥–Ω–æ–º—É —Å—Ç–∞–Ω—ñ

### –ü–æ—Ç–µ–Ω—Ü—ñ–π–Ω—ñ –æ–±–º–µ–∂–µ–Ω–Ω—è:

‚ö†Ô∏è **–£–≤–∞–≥–∞:** –Ø–∫—â–æ –≤–æ–¥—ñ–π –æ–¥–Ω–æ—á–∞—Å–Ω–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î –±–æ—Ç–∞ –≤ –∫—ñ–ª—å–∫–æ—Ö —á–∞—Ç–∞—Ö (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, –≤ –¥–≤–æ—Ö –≥—Ä—É–ø–∞—Ö), FSM state –±—É–¥–µ —Å–ø—ñ–ª—å–Ω–∏–π.

**–ê–ª–µ —Ü–µ –Ω–µ –ø—Ä–æ–±–ª–µ–º–∞ –¥–ª—è —Ç–∞–∫—Å—ñ-–±–æ—Ç–∞**, —Ç–æ–º—É —â–æ:
- –í–æ–¥—ñ–π –º–æ–∂–µ –ø—Ä–∞—Ü—é–≤–∞—Ç–∏ —Ç—ñ–ª—å–∫–∏ –≤ –æ–¥–Ω—ñ–π –≥—Ä—É–ø—ñ –≤–æ–¥—ñ—ó–≤
- –ü—Ä–æ—Ü–µ—Å –ø—Ä–∏–π–Ω—è—Ç—Ç—è –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è –ª—ñ–Ω—ñ–π–Ω–∏–π
- –ù–µ–º–æ–∂–ª–∏–≤–æ –æ–¥–Ω–æ—á–∞—Å–Ω–æ –ø—Ä–∏–π–º–∞—Ç–∏ –∫—ñ–ª—å–∫–∞ –∑–∞–º–æ–≤–ª–µ–Ω—å

---

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –í–∏–ø—Ä–∞–≤–ª–µ–Ω–æ  
**–¢–µ—Å—Ç—É–≤–∞–Ω–Ω—è:** –†–µ–∫–æ–º–µ–Ω–¥—É—î—Ç—å—Å—è –ø—Ä–æ—Ç–µ—Å—Ç—É–≤–∞—Ç–∏ –ø—Ä–æ—Ü–µ—Å –ø—Ä–∏–π–Ω—è—Ç—Ç—è –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è  
**Backward compatibility:** ‚úÖ –ó–º—ñ–Ω–∞ –Ω–µ –≤–ø–ª–∏–≤–∞—î –Ω–∞ —ñ–Ω—à—ñ —Ñ—É–Ω–∫—Ü—ñ—ó –±–æ—Ç–∞
