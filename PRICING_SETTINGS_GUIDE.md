# 📊 Повний контроль ціноутворення через панель адміна

## 🎯 Що змінилося?

Тепер **ВСІ** налаштування ціноутворення централізовані в панелі адміна. Ви можете налаштувати:

### 🚗 Множники класів авто
- **Економ** (за замовчуванням: x1.0)
- **Стандарт** (за замовчуванням: x1.3 = +30%)
- **Комфорт** (за замовчуванням: x1.6 = +60%)
- **Бізнес** (за замовчуванням: x2.0 = +100%)

### ⏰ Часові націнки
- **🌙 Нічний тариф** (23:00-06:00): за замовчуванням +50%
- **🔥 Піковий час** (7-9, 17-19): за замовчуванням +30%
- **🎉 Вихідні** (Пт-Нд 18-23): за замовчуванням +20%
- **📅 Понеділок вранці** (7-10): за замовчуванням +15%

### 🌧️ Погодні умови
- Вручну контрольована надбавка (за замовчуванням: 0%)
- Адмін вмикає при поганій погоді

### 📊 Рівні попиту (динамічна ціна)
- **🚫 Немає водіїв**: +50%
- **🔥🔥🔥 Дуже високий** (>3 замовлень на водія): +40%
- **🔥🔥 Високий** (>2 замовлень на водія): +25%
- **🔥 Середній** (>1.5 замовлень на водія): +15%
- **💚 Низький** (<0.3 замовлень на водія): **-10% (знижка!)**

## 🚀 Як використовувати?

### 1. Перший запуск

Після оновлення коду, запустіть скрипт ініціалізації:

```bash
python3 init_pricing_settings.py
```

Це створить початкові налаштування зі значеннями за замовчуванням.

### 2. Налаштування через бота

1. Відкрийте панель адміна в боті
2. Натисніть **⚙️ Налаштування**
3. Оберіть категорію для налаштування:
   - **🚗 Класи авто** - змінити множники для класів
   - **⏰ Часові націнки** - налаштувати нічний, піковий тариф, тощо
   - **🌧️ Погода** - увімкнути/вимкнути погодну надбавку
   - **📊 Попит** - налаштувати множники для різних рівнів попиту
   - **💳 Картка** - змінити картку для оплати комісії

4. Введіть нове значення та збережіть

## 📐 Як розраховується ціна?

### Формула розрахунку:

```
Базова ціна = base_fare + (відстань_км × per_km) + (час_хв × per_minute)

↓ (мінімум)

Базова ціна = max(Базова ціна, minimum)

↓ (клас авто)

Ціна з класом = Базова ціна × множник_класу

↓ (динамічні надбавки)

Фінальна ціна = Ціна з класом × (1 + часові_націнки/100) × (1 + погода/100) × (1 + попит/100)
```

### Приклад розрахунку:

**Вихідні дані:**
- Відстань: 10 км
- Час: 20 хвилин
- Базовий тариф: 40 грн + 8 грн/км + 2 грн/хв
- Клас: Стандарт (x1.3)
- Час: 19:00 (піковий +30%)
- Попит: Високий (+25%)
- Погода: Дощ (+20%)

**Розрахунок:**
1. Базова: 40 + (10×8) + (20×2) = **160 грн**
2. З класом: 160 × 1.3 = **208 грн**
3. Піковий: 208 × 1.3 = **270 грн**
4. Попит: 270 × 1.25 = **338 грн**
5. Погода: 338 × 1.2 = **405 грн** ✅

**Водій отримає:** 405 - комісія (2%) = **397 грн**

## 🔧 Технічні деталі

### Нові файли:
- `app/storage/db.py` - додано `PricingSettings`, `get_pricing_settings()`, `upsert_pricing_settings()`
- `app/handlers/pricing_settings_handlers.py` - обробники для панелі адміна
- `init_pricing_settings.py` - скрипт ініціалізації

### Оновлені файли:
- `app/storage/init_postgres.py` - додана таблиця `pricing_settings`
- `app/handlers/dynamic_pricing.py` - всі функції тепер приймають параметри з БД
- `app/handlers/car_classes.py` - `calculate_fare_with_class()` приймає кастомні множники
- `app/handlers/order.py` - використовує `get_pricing_settings()` для розрахунків
- `app/handlers/admin.py` - розширене меню налаштувань

### База даних:

Нова таблиця `pricing_settings`:
```sql
CREATE TABLE pricing_settings (
    id SERIAL PRIMARY KEY,
    economy_multiplier DOUBLE PRECISION NOT NULL DEFAULT 1.0,
    standard_multiplier DOUBLE PRECISION NOT NULL DEFAULT 1.3,
    comfort_multiplier DOUBLE PRECISION NOT NULL DEFAULT 1.6,
    business_multiplier DOUBLE PRECISION NOT NULL DEFAULT 2.0,
    night_percent DOUBLE PRECISION NOT NULL DEFAULT 50.0,
    peak_hours_percent DOUBLE PRECISION NOT NULL DEFAULT 30.0,
    weekend_percent DOUBLE PRECISION NOT NULL DEFAULT 20.0,
    monday_morning_percent DOUBLE PRECISION NOT NULL DEFAULT 15.0,
    weather_percent DOUBLE PRECISION NOT NULL DEFAULT 0.0,
    demand_very_high_percent DOUBLE PRECISION NOT NULL DEFAULT 40.0,
    demand_high_percent DOUBLE PRECISION NOT NULL DEFAULT 25.0,
    demand_medium_percent DOUBLE PRECISION NOT NULL DEFAULT 15.0,
    demand_low_discount_percent DOUBLE PRECISION NOT NULL DEFAULT 10.0,
    no_drivers_percent DOUBLE PRECISION NOT NULL DEFAULT 50.0,
    created_at TIMESTAMP WITH TIME ZONE NOT NULL,
    updated_at TIMESTAMP WITH TIME ZONE NOT NULL
);
```

## 💡 Поради

### Оптимальні налаштування для різних міст:

**Велике місто (Київ, Львів):**
- Піковий час: +40%
- Нічний: +60%
- Високий попит: +30%

**Середнє місто:**
- Піковий час: +25%
- Нічний: +40%
- Високий попит: +20%

**Мале місто:**
- Піковий час: +15%
- Нічний: +30%
- Високий попит: +15%

### Сезонні налаштування:

**Зима (грудень-лютий):**
- Погода: +30% (сніг, ожеледиця)
- Нічний: +70% (холодно)

**Літо (червень-серпень):**
- Вихідні: +30% (відпочинок)
- Погода: +15% (спека)

## 🎨 UX покращення

- 📊 Красивий огляд всіх налаштувань в одному екрані
- 🎯 Категоризація по типам (авто, час, погода, попит)
- 💬 Пояснення для кожного параметра
- ✅ Миттєве збереження змін
- 🔙 Зручна навігація між категоріями

## 📞 Підтримка

Якщо виникли питання або проблеми:
1. Перевірте чи запущено `init_pricing_settings.py`
2. Переконайтеся що таблиця `pricing_settings` створена
3. Перевірте логи бота на наявність помилок

---

**Створено:** 2025-10-26  
**Версія:** 1.0  
**Автор:** AI Assistant
