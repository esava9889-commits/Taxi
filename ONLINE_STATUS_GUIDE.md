# 🟢🔴 Перемикач Онлайн/Офлайн для Водія

## ✅ Реалізовано!

---

## 🎯 **Функціонал:**

### **В панелі водія тепер є:**

1. **Великі кнопки перемикання статусу:**
   - 🟢 **ПОЧАТИ ПРАЦЮВАТИ** (коли офлайн)
   - 🔴 **ПІТИ В ОФЛАЙН** (коли онлайн)

2. **Відображення статусу:**
   - `Статус: 🟢 Онлайн` або `Статус: 🔴 Офлайн`
   - `👥 Водіїв онлайн: X` - скільки водіїв онлайн в місті

3. **Кнопка оновлення:**
   - 🔄 **Оновити панель** - оновлює всі дані (заробіток, статус, кількість водіїв)

---

## 📱 **Як працює:**

### **1. Водій відкриває панель:**
```
Меню → 🚗 Панель водія
```

**Бачить:**
```
🚗 Панель водія

Статус: 🔴 Офлайн
Локація: ❌ Не встановлена
ПІБ: Іван Петренко
🏙 Місто: Кривий Ріг
👥 Водіїв онлайн: 5
🚙 Авто: Toyota Camry
🔢 Номер: AA1234BB

💰 Заробіток сьогодні: 0.00 грн
💸 Комісія до сплати: 0.00 грн
💵 Чистий заробіток: 0.00 грн
💝 Чайові (всього): 0.00 грн

🟢 ПОЧАТИ ПРАЦЮВАТИ  ← Велика кнопка
📊 Статистика за період
🔄 Оновити панель
```

---

### **2. Натискає "🟢 ПОЧАТИ ПРАЦЮВАТИ":**

**Сповіщення:**
```
✅ Ви онлайн! Водіїв онлайн у Кривий Ріг: 6
```

**Панель оновлюється:**
```
Статус: 🟢 Онлайн  ← Змінився!
👥 Водіїв онлайн: 6  ← +1

🔴 ПІТИ В ОФЛАЙН  ← Кнопка змінилась
📊 Статистика за період
🔄 Оновити панель
```

**Що відбувається:**
- ✅ Статус змінено на "онлайн"
- ✅ Водій починає отримувати замовлення
- ✅ Лічильник онлайн водіїв оновлено
- ✅ Час останньої активності записано

---

### **3. Натискає "🔴 ПІТИ В ОФЛАЙН":**

**Сповіщення:**
```
🔴 Ви офлайн. Ви не отримуватимете нові замовлення.
```

**Панель оновлюється:**
```
Статус: 🔴 Офлайн  ← Змінився!
👥 Водіїв онлайн: 5  ← -1

🟢 ПОЧАТИ ПРАЦЮВАТИ  ← Кнопка змінилась назад
```

**Що відбувається:**
- ✅ Статус змінено на "офлайн"
- ✅ Водій НЕ отримує нові замовлення
- ✅ Лічильник онлайн водіїв оновлено

---

### **4. Натискає "🔄 Оновити панель":**

**Сповіщення:**
```
✅ Оновлено!
```

**Що оновлюється:**
- 💰 Заробіток
- 💸 Комісія
- 💝 Чайові
- 👥 Кількість онлайн водіїв
- 🟢/🔴 Поточний статус
- 📍 Статус локації

---

## 🗄️ **База даних:**

### **Таблиця `drivers`:**
```sql
online INTEGER DEFAULT 0  -- 0 = офлайн, 1 = онлайн
last_seen_at TEXT         -- Час останньої активності
```

### **Функції:**
- `set_driver_online_status(driver_id, online: bool)` - змінити статус
- `get_online_drivers_count(city)` - підрахунок онлайн водіїв в місті

---

## 🔄 **Логіка роботи:**

### **Онлайн статус:**
```python
if driver.online:
    # Водій отримує замовлення
    # Показується в списку доступних
    # Враховується в підрахунку онлайн водіїв
else:
    # Водій НЕ отримує замовлення
    # НЕ показується клієнтам
    # НЕ враховується в підрахунку
```

### **При прийнятті замовлення:**
```python
# Тільки онлайн водії бачать замовлення в групі
# Тільки онлайн водії отримують особисті пропозиції (топ-3)
```

---

## 🎨 **Візуальна схема:**

```
┌─────────────────────────────────┐
│     🚗 Панель водія            │
├─────────────────────────────────┤
│ Статус: 🔴 Офлайн              │
│ 👥 Водіїв онлайн: 5            │
├─────────────────────────────────┤
│                                 │
│  🟢 ПОЧАТИ ПРАЦЮВАТИ  ← Клік   │
│                                 │
├─────────────────────────────────┤
│ 📊 Статистика за період        │
│ 🔄 Оновити панель              │
└─────────────────────────────────┘
           ↓
┌─────────────────────────────────┐
│     🚗 Панель водія            │
├─────────────────────────────────┤
│ Статус: 🟢 Онлайн ✅           │
│ 👥 Водіїв онлайн: 6 (+1)       │
├─────────────────────────────────┤
│                                 │
│  🔴 ПІТИ В ОФЛАЙН              │
│                                 │
├─────────────────────────────────┤
│ 📊 Статистика за період        │
│ 🔄 Оновити панель              │
└─────────────────────────────────┘
```

---

## 🚀 **Переваги:**

### **Для водія:**
- ✅ Швидке перемикання статусу
- ✅ Бачить скільки конкурентів онлайн
- ✅ Може йти на перерву без виходу з боту
- ✅ Не отримує замовлення коли офлайн

### **Для системи:**
- ✅ Точний підрахунок доступних водіїв
- ✅ Кращий розподіл замовлень
- ✅ Статистика активності водіїв

### **Для клієнтів:**
- ✅ Бачать тільки реально доступних водіїв
- ✅ Швидше отримують відповідь
- ✅ Менше скасувань

---

## 📊 **Статистика використання:**

### **Відстеження:**
- Скільки часу водій онлайн/офлайн
- В який час найбільше водіїв онлайн
- Середня тривалість онлайн сесії

### **Можливості (майбутнє):**
- Нагадування: "Ви офлайн вже 2 години"
- Бонуси за роботу в пікові години
- Статистика найактивніших водіїв

---

## 🔧 **Технічні деталі:**

### **Файл:** `app/handlers/driver_panel.py`

**Callback handlers:**
```python
@router.callback_query(F.data == "driver:status:online")
async def set_online(call: CallbackQuery):
    await set_driver_online_status(driver.id, True)
    # Показати кількість онлайн водіїв
    # Оновити панель
    
@router.callback_query(F.data == "driver:status:offline")
async def set_offline(call: CallbackQuery):
    await set_driver_online_status(driver.id, False)
    # Оновити панель

@router.callback_query(F.data == "driver:refresh")
async def refresh_panel(call: CallbackQuery):
    # Оновити всі дані
    # Показати актуальну інформацію
```

---

## ✅ **Тестування:**

### **Тест 1: Увімкнути онлайн**
1. Водій офлайн
2. Натискає "🟢 ПОЧАТИ ПРАЦЮВАТИ"
3. **Очікується:** 
   - Статус змінюється на 🟢 Онлайн
   - Лічильник водіїв +1
   - Кнопка змінюється на "🔴 ПІТИ В ОФЛАЙН"

### **Тест 2: Вимкнути онлайн**
1. Водій онлайн
2. Натискає "🔴 ПІТИ В ОФЛАЙН"
3. **Очікується:**
   - Статус змінюється на 🔴 Офлайн
   - Лічильник водіїв -1
   - Кнопка змінюється на "🟢 ПОЧАТИ ПРАЦЮВАТИ"

### **Тест 3: Оновлення панелі**
1. Водій робить кілька поїздок
2. Натискає "🔄 Оновити панель"
3. **Очікується:**
   - Заробіток оновлено
   - Комісія оновлена
   - Лічильник водіїв актуальний

---

## 📝 **Коміт:**

```
2766ca5 - feat: Додано перемикач онлайн/офлайн статусу в панелі водія

Зміни:
- Додано імпорт set_driver_online_status, get_online_drivers_count
- Великі кнопки статусу (ЗАГОЛОВНИМИ)
- Лічильник онлайн водіїв в місті
- Кнопка "Оновити панель"
- Обробник driver:refresh для оновлення даних
```

---

## 🎊 **Готово до використання!**

Водії тепер можуть:
- ✅ Швидко перемикати онлайн/офлайн
- ✅ Бачити кількість конкурентів
- ✅ Оновлювати панель одним кліком

**Запушено на GitHub: fix-taxi-bot** 🚀
