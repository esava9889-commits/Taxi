# üìè –í–ò–ü–†–ê–í–õ–ï–ù–ù–Ø –†–û–ó–†–ê–•–£–ù–ö–£ –í–Ü–î–°–¢–ê–ù–Ü –¢–ê –í–ê–†–¢–û–°–¢–Ü

## ‚ùå –ü–†–û–ë–õ–ï–ú–ê:

**–†–∞–Ω—ñ—à–µ:**
- –í—ñ–¥—Å—Ç–∞–Ω—å –∑–∞–≤–∂–¥–∏ = 5 –∫–º (–∑–∞–≥–ª—É—à–∫–∞)
- –ö—Ä–∏–≤–∏–π –†—ñ–≥ ‚Üí –ö–∏—ó–≤ (450 –∫–º) = 200 –≥—Ä–Ω –∑–∞–º—ñ—Å—Ç—å ~4500+ –≥—Ä–Ω
- –ö–ª—ñ—î–Ω—Ç —ñ –≤–æ–¥—ñ–π –ù–ï –±–∞—á–∏–ª–∏ –≤—ñ–¥—Å—Ç–∞–Ω—å –ø—Ä–∏ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—ñ

**–ö–æ–¥:**
```python
distance_m = 5000  # 5 –∫–º –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º ‚ùå
duration_s = 600   # 10 —Ö–≤ –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º ‚ùå
```

---

## ‚úÖ –†–Ü–®–ï–ù–ù–Ø:

### 1. –î–æ–¥–∞–Ω–æ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏ –≤ –ë–î

**–ù–æ–≤—ñ –ø–æ–ª—è –≤ —Ç–∞–±–ª–∏—Ü—ñ `orders`:**
- `pickup_lat` REAL - —à–∏—Ä–æ—Ç–∞ —Ç–æ—á–∫–∏ –ø–æ–¥–∞—á—ñ
- `pickup_lon` REAL - –¥–æ–≤–≥–æ—Ç–∞ —Ç–æ—á–∫–∏ –ø–æ–¥–∞—á—ñ
- `dest_lat` REAL - —à–∏—Ä–æ—Ç–∞ –ø—Ä–∏–∑–Ω–∞—á–µ–Ω–Ω—è
- `dest_lon` REAL - –¥–æ–≤–≥–æ—Ç–∞ –ø—Ä–∏–∑–Ω–∞—á–µ–Ω–Ω—è

### 2. –†–æ–∑—Ä–∞—Ö—É–Ω–æ–∫ –≤—ñ–¥—Å—Ç–∞–Ω—ñ —á–µ—Ä–µ–∑ Google Maps API

**–ü—Ä–∏ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—ñ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è:**
1. –ö–ª—ñ—î–Ω—Ç –Ω–∞–¥—Å–∏–ª–∞—î –≥–µ–æ–ª–æ–∫–∞—Ü—ñ—é –ê–ë–û –∞–¥—Ä–µ—Å—É
2. –Ø–∫—â–æ –≥–µ–æ–ª–æ–∫–∞—Ü—ñ—è ‚Üí –∑–±–µ—Ä—ñ–≥–∞—î–º–æ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏
3. –Ø–∫—â–æ –∞–¥—Ä–µ—Å–∞ ‚Üí –≥–µ–æ–∫–æ–¥—É—î–º–æ –≤ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏ (Geocoding API)
4. –†–æ–∑—Ä–∞—Ö–æ–≤—É—î–º–æ –≤—ñ–¥—Å—Ç–∞–Ω—å —á–µ—Ä–µ–∑ Distance Matrix API
5. **–ü–û–ö–ê–ó–£–Ñ–ú–û –ö–õ–Ü–Ñ–ù–¢–£:**
   ```
   üìè –í—ñ–¥—Å—Ç–∞–Ω—å: 450.3 –∫–º (~6 –≥–æ–¥)
   üí∞ –û—Ä—ñ—î–Ω—Ç–æ–≤–Ω–∞ –≤–∞—Ä—Ç—ñ—Å—Ç—å: ~4500 –≥—Ä–Ω
   ```

### 3. –í—ñ–¥—Å—Ç–∞–Ω—å –ø–æ–∫–∞–∑—É—î—Ç—å—Å—è –≤–æ–¥—ñ—é

**–£ –≥—Ä—É–ø—ñ –≤–æ–¥—ñ—ó–≤:**
```
üîî –ù–û–í–ï –ó–ê–ú–û–í–õ–ï–ù–ù–Ø #123

üèô –ú—ñ—Å—Ç–æ: –ö—Ä–∏–≤–∏–π –†—ñ–≥
üìç –ó–≤—ñ–¥–∫–∏: –≤—É–ª. –ú–µ—Ç–∞–ª—É—Ä–≥—ñ–≤ 1
üìç –ö—É–¥–∏: –ö–∏—ó–≤, –•—Ä–µ—â–∞—Ç–∏–∫ 1
üìè –í—ñ–¥—Å—Ç–∞–Ω—å: 450.3 –∫–º (~6 –≥–æ–¥)
üí∞ –û—Ä—ñ—î–Ω—Ç–æ–≤–Ω–∞ –≤–∞—Ä—Ç—ñ—Å—Ç—å: ~4500 –≥—Ä–Ω
```

### 4. –†–µ–∞–ª—å–Ω–∞ –≤–∞—Ä—Ç—ñ—Å—Ç—å –ø—Ä–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ñ

**–ü—Ä–∏ –Ω–∞—Ç–∏—Å–∫–∞–Ω–Ω—ñ "–ó–∞–≤–µ—Ä—à–∏—Ç–∏ –ø–æ—ó–∑–¥–∫—É":**
1. –ë–µ—Ä–µ–º–æ `distance_m` –∑ –ë–î (–∑–±–µ—Ä–µ–∂–µ–Ω—É –ø—Ä–∏ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—ñ)
2. –Ø–∫—â–æ –Ω–µ–º–∞—î –≤ –ë–î, –∞–ª–µ —î –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏ ‚Üí —Ä–æ–∑—Ä–∞—Ö–æ–≤—É—î–º–æ –∑–∞—Ä–∞–∑
3. Fallback –Ω–∞ 5 –∫–º —Ç—ñ–ª—å–∫–∏ —è–∫—â–æ –Ω–µ–º–∞—î –∂–æ–¥–Ω–∏—Ö –¥–∞–Ω–∏—Ö
4. –†–æ–∑—Ä–∞—Ö—É–Ω–æ–∫:
   ```python
   –≤–∞—Ä—Ç—ñ—Å—Ç—å = max(
       –º—ñ–Ω—ñ–º—É–º,
       –±–∞–∑–æ–≤–∏–π_—Ç–∞—Ä–∏—Ñ + (–∫–º √ó —Ü—ñ–Ω–∞_–∑–∞_–∫–º) + (—Ö–≤ √ó —Ü—ñ–Ω–∞_–∑–∞_—Ö–≤)
   )
   ```

---

## üîß –¢–ï–•–ù–Ü–ß–ù–Ü –ó–ú–Ü–ù–ò:

### –§–∞–π–ª–∏ —â–æ –∑–º—ñ–Ω–µ–Ω–æ:

#### 1. `app/storage/db.py`
- ‚úÖ –î–æ–¥–∞–Ω–æ –ø–æ–ª—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç —É `Order` dataclass
- ‚úÖ –î–æ–¥–∞–Ω–æ –∫–æ–ª–æ–Ω–∫–∏ –≤ `CREATE TABLE orders`
- ‚úÖ –û–Ω–æ–≤–ª–µ–Ω–æ `_ensure_columns` –¥–ª—è –º—ñ–≥—Ä–∞—Ü—ñ—ó
- ‚úÖ –û–Ω–æ–≤–ª–µ–Ω–æ `insert_order` - –∑–±–µ—Ä—ñ–≥–∞—î –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏
- ‚úÖ –û–Ω–æ–≤–ª–µ–Ω–æ –≤—Å—ñ SELECT –∑–∞–ø–∏—Ç–∏:
  - `fetch_recent_orders`
  - `get_order_by_id`
  - `get_user_order_history`
  - `get_driver_order_history`

#### 2. `app/handlers/order.py`
- ‚úÖ –Ü–º–ø–æ—Ä—Ç `get_distance_and_duration` —ñ `geocode_address`
- ‚úÖ –Ü–º–ø–æ—Ä—Ç `get_latest_tariff`
- ‚úÖ `show_confirmation` - —Ä–æ–∑—Ä–∞—Ö—É–Ω–æ–∫ –≤—ñ–¥—Å—Ç–∞–Ω—ñ —ñ –ø–æ–∫–∞–∑ –∫–ª—ñ—î–Ω—Ç—É
- ‚úÖ `confirm_order` - –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç —ñ –≤—ñ–¥—Å—Ç–∞–Ω—ñ –≤ –ë–î
- ‚úÖ –ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –≤ –≥—Ä—É–ø—É –≤–æ–¥—ñ—ó–≤ - –ø–æ–∫–∞–∑ –≤—ñ–¥—Å—Ç–∞–Ω—ñ —Ç–∞ –≤–∞—Ä—Ç–æ—Å—Ç—ñ

#### 3. `app/handlers/driver_panel.py`
- ‚úÖ `complete_trip` - –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è —Ä–µ–∞–ª—å–Ω–æ—ó –≤—ñ–¥—Å—Ç–∞–Ω—ñ –∑ –ë–î
- ‚úÖ Fallback —Ä–æ–∑—Ä–∞—Ö—É–Ω–æ–∫ —è–∫—â–æ –≤—ñ–¥—Å—Ç–∞–Ω—å –≤—ñ–¥—Å—É—Ç–Ω—è
- ‚úÖ –õ–æ–≥—É–≤–∞–Ω–Ω—è —Ä–æ–∑—Ä–∞—Ö—É–Ω–∫—ñ–≤

---

## üìã –ü–†–ò–ö–õ–ê–î –†–û–ë–û–¢–ò:

### –°—Ü–µ–Ω–∞—Ä—ñ–π: –ö—Ä–∏–≤–∏–π –†—ñ–≥ ‚Üí –ö–∏—ó–≤ (450 –∫–º)

**1. –ö–ª—ñ—î–Ω—Ç –∑–∞–º–æ–≤–ª—è—î —Ç–∞–∫—Å—ñ:**
```
üìã –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –¥–∞–Ω—ñ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è:

üë§ –ö–ª—ñ—î–Ω—Ç: –Ü–≤–∞–Ω –ü–µ—Ç—Ä–µ–Ω–∫–æ
üì± –¢–µ–ª–µ—Ñ–æ–Ω: +380501234567
üèô –ú—ñ—Å—Ç–æ: –ö—Ä–∏–≤–∏–π –†—ñ–≥

üìç –ó–≤—ñ–¥–∫–∏: –≤—É–ª. –ú–µ—Ç–∞–ª—É—Ä–≥—ñ–≤ 1
üìç –ö—É–¥–∏: –ö–∏—ó–≤, –•—Ä–µ—â–∞—Ç–∏–∫ 1
üí¨ –ö–æ–º–µ–Ω—Ç–∞—Ä: ‚Äî

üìè –í—ñ–¥—Å—Ç–∞–Ω—å: 450.3 –∫–º (~6 –≥–æ–¥ 15 —Ö–≤)
üí∞ –û—Ä—ñ—î–Ω—Ç–æ–≤–Ω–∞ –≤–∞—Ä—Ç—ñ—Å—Ç—å: 4503 –≥—Ä–Ω

–í—Å–µ –≤—ñ—Ä–Ω–æ?
```

**2. –í–æ–¥—ñ–π –±–∞—á–∏—Ç—å —É –≥—Ä—É–ø—ñ:**
```
üîî –ù–û–í–ï –ó–ê–ú–û–í–õ–ï–ù–ù–Ø #123

üèô –ú—ñ—Å—Ç–æ: –ö—Ä–∏–≤–∏–π –†—ñ–≥
üë§ –ö–ª—ñ—î–Ω—Ç: –Ü–≤–∞–Ω –ü–µ—Ç—Ä–µ–Ω–∫–æ
üì± –¢–µ–ª–µ—Ñ–æ–Ω: +380501234567

üìç –ó–≤—ñ–¥–∫–∏: –≤—É–ª. –ú–µ—Ç–∞–ª—É—Ä–≥—ñ–≤ 1
üìç –ö—É–¥–∏: –ö–∏—ó–≤, –•—Ä–µ—â–∞—Ç–∏–∫ 1
üìè –í—ñ–¥—Å—Ç–∞–Ω—å: 450.3 –∫–º (~6 –≥–æ–¥ 15 —Ö–≤)
üí∞ –û—Ä—ñ—î–Ω—Ç–æ–≤–Ω–∞ –≤–∞—Ä—Ç—ñ—Å—Ç—å: ~4503 –≥—Ä–Ω

üí¨ –ö–æ–º–µ–Ω—Ç–∞—Ä: ‚Äî

‚è∞ –ß–∞—Å: 18:45
```

**3. –ü—ñ—Å–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è –ø–æ—ó–∑–¥–∫–∏:**
```
‚úÖ –ü–æ—ó–∑–¥–∫—É –∑–∞–≤–µ—Ä—à–µ–Ω–æ!

üí∞ –í–∞—Ä—Ç—ñ—Å—Ç—å: 4503 –≥—Ä–Ω
üìç –í—ñ–¥—Å—Ç–∞–Ω—å: 450.3 –∫–º
‚è± –ß–∞—Å: 375 —Ö–≤

–ë—É–¥—å –ª–∞—Å–∫–∞, –æ—Ü—ñ–Ω—ñ—Ç—å –≤–æ–¥—ñ—è:
[‚≠êÔ∏è 5] [‚≠êÔ∏è 4] [‚≠êÔ∏è 3] [‚≠êÔ∏è 2] [‚≠êÔ∏è 1]
```

---

## üéØ –¢–ê–†–ò–§–ò (–ø—Ä–∏–∫–ª–∞–¥):

```python
base_fare = 50 –≥—Ä–Ω       # –±–∞–∑–æ–≤–∏–π —Ç–∞—Ä–∏—Ñ
per_km = 10 –≥—Ä–Ω          # –∑–∞ –∫—ñ–ª–æ–º–µ—Ç—Ä
per_minute = 0 –≥—Ä–Ω       # –∑–∞ —Ö–≤–∏–ª–∏–Ω—É (–æ–ø—Ü—ñ–æ–Ω–∞–ª—å–Ω–æ)
minimum = 50 –≥—Ä–Ω         # –º—ñ–Ω—ñ–º–∞–ª—å–Ω–∞ –≤–∞—Ä—Ç—ñ—Å—Ç—å
```

**–†–æ–∑—Ä–∞—Ö—É–Ω–æ–∫ –ö—Ä–∏–≤–∏–π –†—ñ–≥ ‚Üí –ö–∏—ó–≤:**
```
450.3 –∫–º √ó 10 –≥—Ä–Ω/–∫–º = 4503 –≥—Ä–Ω
max(50 –≥—Ä–Ω –º—ñ–Ω—ñ–º—É–º, 50 + 4503) = 4553 –≥—Ä–Ω
```

---

## ‚öôÔ∏è –ù–ê–õ–ê–®–¢–£–í–ê–ù–ù–Ø:

### Google Maps API Key (–æ–±–æ–≤'—è–∑–∫–æ–≤–æ –¥–ª—è —Ç–æ—á–Ω–∏—Ö —Ä–æ–∑—Ä–∞—Ö—É–Ω–∫—ñ–≤)

**1. –û—Ç—Ä–∏–º–∞—Ç–∏ API –∫–ª—é—á:**
- https://console.cloud.google.com/
- Enable APIs: Distance Matrix API, Geocoding API
- Create credentials ‚Üí API key

**2. –î–æ–¥–∞—Ç–∏ –≤ `.env`:**
```bash
GOOGLE_MAPS_API_KEY=AIzaSyC...–≤–∞—à_–∫–ª—é—á
```

**3. Render Environment Variables:**
```
GOOGLE_MAPS_API_KEY = AIzaSyC...–≤–∞—à_–∫–ª—é—á
```

### –ë–µ–∑ API –∫–ª—é—á–∞:

- ‚ö†Ô∏è –í—ñ–¥—Å—Ç–∞–Ω—å –Ω–µ —Ä–æ–∑—Ä–∞—Ö–æ–≤—É—î—Ç—å—Å—è
- Fallback –Ω–∞ 5 –∫–º
- –ü–æ–∫–∞–∑ –ª–∏—à–µ –∞–¥—Ä–µ—Å –±–µ–∑ –≤—ñ–¥—Å—Ç–∞–Ω—ñ
- –í–∞—Ä—Ç—ñ—Å—Ç—å –±—É–¥–µ –º—ñ–Ω—ñ–º–∞–ª—å–Ω–æ—é

---

## üîç –î–Ü–ê–ì–ù–û–°–¢–ò–ö–ê:

### –õ–æ–≥–∏ –ø–æ–∫–∞–∑—É—é—Ç—å —Ä–æ–∑—Ä–∞—Ö—É–Ω–∫–∏:

```
INFO - üìè –†–æ–∑—Ä–∞—Ö–æ–≤–∞–Ω–æ –≤—ñ–¥—Å—Ç–∞–Ω—å –¥–ª—è –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è #123: 450.3 –∫–º
INFO - Order #123: Distance=450.3km, Duration=375min, Fare=4553.00–≥—Ä–Ω
```

### –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –≤ –ë–î:

```sql
SELECT id, distance_m, duration_s, fare_amount 
FROM orders 
WHERE id = 123;

-- –†–µ–∑—É–ª—å—Ç–∞—Ç:
-- id | distance_m | duration_s | fare_amount
-- 123| 450300     | 22500      | 4553.00
```

---

## ‚úÖ –ü–ï–†–ï–í–ê–ì–ò:

1. ‚úÖ **–¢–æ—á–Ω–∏–π —Ä–æ–∑—Ä–∞—Ö—É–Ω–æ–∫** - —Ä–µ–∞–ª—å–Ω–∞ –≤—ñ–¥—Å—Ç–∞–Ω—å —á–µ—Ä–µ–∑ Google Maps
2. ‚úÖ **–ü—Ä–æ–∑–æ—Ä—ñ—Å—Ç—å** - –∫–ª—ñ—î–Ω—Ç –±–∞—á–∏—Ç—å –≤–∞—Ä—Ç—ñ—Å—Ç—å –î–û –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è
3. ‚úÖ **–Ü–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω—ñ—Å—Ç—å** - –≤–æ–¥—ñ–π –∑–Ω–∞—î –≤—ñ–¥—Å—Ç–∞–Ω—å —ñ –∑–∞—Ä–æ–±—ñ—Ç–æ–∫
4. ‚úÖ **–°–ø—Ä–∞–≤–µ–¥–ª–∏–≤—ñ—Å—Ç—å** - –æ–ø–ª–∞—Ç–∞ –ø–æ —Ñ–∞–∫—Ç—É –∫—ñ–ª–æ–º–µ—Ç—Ä—ñ–≤
5. ‚úÖ **–ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü—ñ—è** - –Ω–µ –ø–æ—Ç—Ä—ñ–±–Ω–æ –≤—Ä—É—á–Ω—É –≤–≤–æ–¥–∏—Ç–∏ –≤—ñ–¥—Å—Ç–∞–Ω—å
6. ‚úÖ **–Ü—Å—Ç–æ—Ä—ñ—è** - –≤—Å—ñ –¥–∞–Ω—ñ –∑–±–µ—Ä—ñ–≥–∞—é—Ç—å—Å—è –≤ –ë–î

---

## üöÄ –ù–ê–°–¢–£–ü–ù–Ü –ö–†–û–ö–ò:

1. **–ù–∞–ª–∞—à—Ç—É–≤–∞—Ç–∏ —Ç–∞—Ä–∏—Ñ–∏** —á–µ—Ä–µ–∑ –∞–¥–º—ñ–Ω-–ø–∞–Ω–µ–ª—å:
   - –ë–∞–∑–∞: 50 –≥—Ä–Ω
   - –ó–∞ –∫–º: 10 –≥—Ä–Ω
   - –ú—ñ–Ω—ñ–º—É–º: 50 –≥—Ä–Ω

2. **–î–æ–¥–∞—Ç–∏ Google Maps API key** –≤ Render:
   - Environment Variables ‚Üí GOOGLE_MAPS_API_KEY

3. **–ü—Ä–æ—Ç–µ—Å—Ç—É–≤–∞—Ç–∏:**
   - –ó–∞–º–æ–≤–ª–µ–Ω–Ω—è –≤ –º–µ–∂–∞—Ö –º—ñ—Å—Ç–∞ (5-10 –∫–º)
   - –ó–∞–º–æ–≤–ª–µ–Ω–Ω—è –º—ñ–∂ –º—ñ—Å—Ç–∞–º–∏ (100+ –∫–º)
   - –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —â–æ –≤—ñ–¥—Å—Ç–∞–Ω—å –ø–æ–∫–∞–∑—É—î—Ç—å—Å—è

---

**–¢–µ–ø–µ—Ä –∫–æ–∂–µ–Ω –∫—ñ–ª–æ–º–µ—Ç—Ä –≤—Ä–∞—Ö–æ–≤—É—î—Ç—å—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ!** üìè‚úÖ
