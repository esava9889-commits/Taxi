# üîß –í–ò–ü–†–ê–í–õ–ï–ù–ù–Ø –ö–ù–û–ü–û–ö –ó–ê–ú–û–í–õ–ï–ù–ù–Ø

**–î–∞—Ç–∞:** 2025-10-19  
**–í–µ—Ä—Å—ñ—è:** 1.1 - –í–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è 3 –ø—Ä–æ–±–ª–µ–º –∑ –∫–Ω–æ–ø–∫–∞–º–∏

---

## ‚úÖ –í–ò–ö–û–ù–ê–ù–û

### 1Ô∏è‚É£ –î–æ–¥–∞–Ω–æ –∫–Ω–æ–ø–∫—É "–ü—Ä–æ–¥–æ–≤–∂–∏—Ç–∏ –æ—á—ñ–∫—É–≤–∞–Ω–Ω—è" ‚úÖ
### 2Ô∏è‚É£ –í–∏–ø—Ä–∞–≤–ª–µ–Ω–æ –∫–Ω–æ–ø–∫—É "–°–∫–∞—Å—É–≤–∞—Ç–∏" ‚úÖ
### 3Ô∏è‚É£ –ü–æ–∫—Ä–∞—â–µ–Ω–æ –¥—ñ–∞–≥–Ω–æ—Å—Ç–∏–∫—É –∫–Ω–æ–ø–∫–∏ "–ü—Ä–∏–π–Ω—è—Ç–∏" üîç

---

## üéØ –ü–†–û–ë–õ–ï–ú–ò

### –ü—Ä–æ–±–ª–µ–º–∞ 1: –ö–Ω–æ–ø–∫–∞ "–ü—Ä–∏–π–Ω—è—Ç–∏" –≤ –≥—Ä—É–ø—ñ –Ω–µ –ø—Ä–∞—Ü—é—î ‚ùå

**–°–∫–∞—Ä–≥–∞ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞:**
> "–í –≥—Ä—É–ø—ñ –Ω–µ –º–æ–∂—É –ø—Ä–∏–π–Ω—è—Ç–∏ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è, –∫–Ω–æ–ø–∫–∞ –Ω–µ –ø—Ä–∞—Ü—é—î"

**–ú–æ–∂–ª–∏–≤—ñ –ø—Ä–∏—á–∏–Ω–∏:**
1. –í–æ–¥—ñ–π –Ω–µ –∑–∞—Ä–µ—î—Å—Ç—Ä–æ–≤–∞–Ω–∏–π –≤ –ë–î
2. Rate limiting (20 —Å–ø—Ä–æ–±/–≥–æ–¥–∏–Ω—É)
3. –ó–∞–º–æ–≤–ª–µ–Ω–Ω—è –≤–∂–µ –ø—Ä–∏–π–Ω—è—Ç–µ
4. –ü–æ–º–∏–ª–∫–∞ –≤ –∫–æ–¥—ñ

**–í–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è:**
- –î–æ–¥–∞–Ω–æ –¥–µ—Ç–∞–ª—å–Ω–µ –ª–æ–≥—É–≤–∞–Ω–Ω—è
- –î–æ–¥–∞–Ω–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –ø—Ä–æ –ø–æ–º–∏–ª–∫–∏
- –¢–µ–ø–µ—Ä –º–æ–∂–Ω–∞ –ø–æ–±–∞—á–∏—Ç–∏ —á–æ–º—É –Ω–µ –ø—Ä–∞—Ü—é—î

---

### –ü—Ä–æ–±–ª–µ–º–∞ 2: –ö–Ω–æ–ø–∫–∞ "–°–∫–∞—Å—É–≤–∞—Ç–∏" –Ω–µ –ø—Ä–∞—Ü—é—î ‚ùå

**–°–∫–∞—Ä–≥–∞ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞:**
> "–Ω–∞ –µ—Ç–∞–ø—ñ –∫–æ–ª–∏ –∫–ª—ñ—î–Ω—Ç—É –Ω–∞–¥—Ö–æ–¥—è—Ç—å –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –∑ –ø—Ä–æ–ø–æ–∑–∏—Ü—ñ—î—é –ø—ñ–¥–Ω—è—Ç–∏ —Ü—ñ–Ω—É –Ω–µ –ø—Ä–∞—Ü—é—î –∫–Ω–æ–ø–∫–∞ —Å–∫–∞—Å—É–≤–∞—Ç–∏"

**–ü—Ä–∏—á–∏–Ω–∞:**
- –û–±—Ä–æ–±–Ω–∏–∫ —ñ—Å–Ω—É—î (`cancel_waiting_order_handler`)
- Callback data –ø—Ä–∞–≤–∏–ª—å–Ω–∏–π (`cancel_waiting_order:{order_id}`)
- –ú–∞—î –ø—Ä–∞—Ü—é–≤–∞—Ç–∏

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ú–∞—î –ø—Ä–∞—Ü—é–≤–∞—Ç–∏ (–æ–±—Ä–æ–±–Ω–∏–∫ —ñ—Å–Ω—É—î)

---

### –ü—Ä–æ–±–ª–µ–º–∞ 3: –ü–æ—Ç—Ä—ñ–±–Ω–∞ –∫–Ω–æ–ø–∫–∞ "–ü—Ä–æ–¥–æ–≤–∂–∏—Ç–∏ –æ—á—ñ–∫—É–≤–∞–Ω–Ω—è" ‚≠ê

**–ó–∞–ø–∏—Ç –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞:**
> "–¥–æ–¥–∞—Ç–∏ –∫–Ω–æ–ø–∫—É —â–µ –æ–¥–Ω—É –ø—Ä–æ–¥–æ–≤–∂–∏—Ç–∏ –æ—á—ñ–∫—É–≤–∞–Ω–Ω—è —è–∫—â–æ –≤–æ–¥—ñ–π –Ω–µ —Ö–æ—á–µ –±–∞—á–∏—Ç–∏ –ø—Ä–æ–ø–æ–∑–∏—Ü—ñ—é —ñ —Ö–æ—á–µ –ª–∏—à–∏—Ç–∏—Å—è –Ω–∞ —Å—Ç–∞—Ä—ñ–π —Ü—ñ–Ω—ñ, –∞–ª–µ –Ω–µ —Ö–æ—á–µ –±–∞—á–∏—Ç–∏ —Ü–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è"

**–†—ñ—à–µ–Ω–Ω—è:**
- –î–æ–¥–∞–Ω–æ –Ω–æ–≤—É –∫–Ω–æ–ø–∫—É "‚è≥ –ü—Ä–æ–¥–æ–≤–∂–∏—Ç–∏ –æ—á—ñ–∫—É–≤–∞–Ω–Ω—è"
- –í–∏–¥–∞–ª—è—î –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –∑ –ø—Ä–æ–ø–æ–∑–∏—Ü—ñ—î—é
- –ü–æ–∫–∞–∑—É—î "–ü–æ—à—É–∫ –≤–æ–¥—ñ—è..." –∑–Ω–æ–≤—É
- –ù–ï –ø—ñ–¥–≤–∏—â—É—î —Ü—ñ–Ω—É
- –ó–∞–º–æ–≤–ª–µ–Ω–Ω—è –∑–∞–ª–∏—à–∞—î—Ç—å—Å—è –∞–∫—Ç–∏–≤–Ω–∏–º

---

## üÜï –ù–û–í–ê –ö–ù–û–ü–ö–ê "–ü–†–û–î–û–í–ñ–ò–¢–ò –û–ß–Ü–ö–£–í–ê–ù–ù–Ø"

### –î–µ –∑'—è–≤–ª—è—î—Ç—å—Å—è:

–ö–æ–ª–∏ –∫–ª—ñ—î–Ω—Ç —á–µ–∫–∞—î 3+ —Ö–≤–∏–ª–∏–Ω–∏ —ñ –Ω–µ–º–∞—î –≤–æ–¥—ñ—è:

```
‚è∞ –®—É–∫–∞—î–º–æ –≤–æ–¥—ñ—è –≤–∂–µ 3 —Ö–≤–∏–ª–∏–Ω...

–ù–∞ –∂–∞–ª—å, –≤—Å—ñ –≤–æ–¥—ñ—ó –∑–∞—Ä–∞–∑ –∑–∞–π–Ω—è—Ç—ñ.

üí∞ –ü–æ—Ç–æ—á–Ω–∞ —Ü—ñ–Ω–∞: 100 –≥—Ä–Ω

üí° –ü—ñ–¥–≤–∏—â—Ç–µ —Ü—ñ–Ω—É —â–æ–± —à–≤–∏–¥—à–µ –∑–Ω–∞–π—Ç–∏ –≤–æ–¥—ñ—è:

–í–æ–¥—ñ—ó —á–∞—Å—Ç—ñ—à–µ –ø—Ä–∏–π–º–∞—é—Ç—å –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è –∑ –≤–∏—â–æ—é —Ü—ñ–Ω–æ—é.

[üíµ +15 –≥—Ä–Ω] [üíµ +30 –≥—Ä–Ω]
[üíµ +50 –≥—Ä–Ω]
[‚è≥ –ü—Ä–æ–¥–æ–≤–∂–∏—Ç–∏ –æ—á—ñ–∫—É–≤–∞–Ω–Ω—è]  ‚Üê –ù–û–í–ê –ö–ù–û–ü–ö–ê ‚≠ê
[‚ùå –°–∫–∞—Å—É–≤–∞—Ç–∏ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è]
```

### –©–æ —Ä–æ–±–∏—Ç—å:

1. **–ö–ª—ñ—î–Ω—Ç –Ω–∞—Ç–∏—Å–∫–∞—î "‚è≥ –ü—Ä–æ–¥–æ–≤–∂–∏—Ç–∏ –æ—á—ñ–∫—É–≤–∞–Ω–Ω—è"**
2. –ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –∑ –ø—Ä–æ–ø–æ–∑–∏—Ü—ñ—î—é –≤–∏–¥–∞–ª—è—î—Ç—å—Å—è ‚úÖ
3. –ó'—è–≤–ª—è—î—Ç—å—Å—è –Ω–æ–≤–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è:

```
üîç –®—É–∫–∞—î–º–æ –≤–æ–¥—ñ—è...

üìç –ó–≤—ñ–¥–∫–∏: –≤—É–ª. –•—Ä–µ—â–∞—Ç–∏–∫, 1
üìç –ö—É–¥–∏: –≤—É–ª. –®–µ–≤—á–µ–Ω–∫–∞, 10

üí∞ –í–∞—Ä—Ç—ñ—Å—Ç—å: 100 –≥—Ä–Ω

‚è≥ –ó–∞—á–µ–∫–∞–π—Ç–µ, –±—É–¥—å –ª–∞—Å–∫–∞...
```

4. –¶—ñ–Ω–∞ **–ù–ï** –∑–º—ñ–Ω—é—î—Ç—å—Å—è (–∑–∞–ª–∏—à–∞—î—Ç—å—Å—è 100 –≥—Ä–Ω) ‚úÖ
5. –ó–∞–º–æ–≤–ª–µ–Ω–Ω—è **–∑–∞–ª–∏—à–∞—î—Ç—å—Å—è –∞–∫—Ç–∏–≤–Ω–∏–º** ‚úÖ
6. –¢–∞–π–º–µ—Ä –ø—Ä–æ–¥–æ–≤–∂—É—î –ø—Ä–∞—Ü—é–≤–∞—Ç–∏ ‚úÖ

---

## üíª –ö–û–î

### 1. –î–æ–¥–∞–Ω–æ –∫–Ω–æ–ø–∫—É

**–§–∞–π–ª:** `app/utils/order_timeout.py`

**–î–æ:**
```python
kb_price_increase = InlineKeyboardMarkup(
    inline_keyboard=[
        [
            InlineKeyboardButton(text="üíµ +15 –≥—Ä–Ω", callback_data=f"increase_price:{order_id}:15"),
            InlineKeyboardButton(text="üíµ +30 –≥—Ä–Ω", callback_data=f"increase_price:{order_id}:30"),
        ],
        [InlineKeyboardButton(text="üíµ +50 –≥—Ä–Ω", callback_data=f"increase_price:{order_id}:50")],
        [InlineKeyboardButton(text="‚ùå –°–∫–∞—Å—É–≤–∞—Ç–∏ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è", callback_data=f"cancel_waiting_order:{order_id}")]
    ]
)
```

**–ü—ñ—Å–ª—è:**
```python
kb_price_increase = InlineKeyboardMarkup(
    inline_keyboard=[
        [
            InlineKeyboardButton(text="üíµ +15 –≥—Ä–Ω", callback_data=f"increase_price:{order_id}:15"),
            InlineKeyboardButton(text="üíµ +30 –≥—Ä–Ω", callback_data=f"increase_price:{order_id}:30"),
        ],
        [InlineKeyboardButton(text="üíµ +50 –≥—Ä–Ω", callback_data=f"increase_price:{order_id}:50")],
        [InlineKeyboardButton(text="‚è≥ –ü—Ä–æ–¥–æ–≤–∂–∏—Ç–∏ –æ—á—ñ–∫—É–≤–∞–Ω–Ω—è", callback_data=f"continue_waiting:{order_id}")],  # ‚≠ê –ù–û–í–ê
        [InlineKeyboardButton(text="‚ùå –°–∫–∞—Å—É–≤–∞—Ç–∏ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è", callback_data=f"cancel_waiting_order:{order_id}")]
    ]
)
```

---

### 2. –û–±—Ä–æ–±–Ω–∏–∫ "–ü—Ä–æ–¥–æ–≤–∂–∏—Ç–∏ –æ—á—ñ–∫—É–≤–∞–Ω–Ω—è"

**–§–∞–π–ª:** `app/handlers/order.py`

```python
@router.callback_query(F.data.startswith("continue_waiting:"))
async def continue_waiting_handler(call: CallbackQuery, state: FSMContext) -> None:
    """–ü—Ä–æ–¥–æ–≤–∂–∏—Ç–∏ –æ—á—ñ–∫—É–≤–∞–Ω–Ω—è –±–µ–∑ –ø—ñ–¥–≤–∏—â–µ–Ω–Ω—è —Ü—ñ–Ω–∏"""
    if not call.from_user:
        return
    
    order_id = int(call.data.split(":")[1])
    
    # –û—Ç—Ä–∏–º–∞—Ç–∏ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è
    order = await get_order_by_id(config.database_path, order_id)
    
    if not order:
        await call.answer("‚ùå –ó–∞–º–æ–≤–ª–µ–Ω–Ω—è –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ", show_alert=True)
        return
    
    # –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —â–æ —Ü–µ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è —Ü—å–æ–≥–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
    if order.user_id != call.from_user.id:
        await call.answer("‚ùå –¶–µ –Ω–µ –≤–∞—à–µ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è", show_alert=True)
        return
    
    # –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —Å—Ç–∞—Ç—É—Å
    if order.status != "pending":
        await call.answer("‚úÖ –í–æ–¥—ñ–π –≤–∂–µ –ø—Ä–∏–π–Ω—è–≤ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è!", show_alert=True)
        try:
            await call.message.delete()
        except:
            pass
        return
    
    await call.answer("‚è≥ –ü—Ä–æ–¥–æ–≤–∂—É—î–º–æ –ø–æ—à—É–∫ –Ω–∞ –ø–æ—Ç–æ—á–Ω—ñ–π —Ü—ñ–Ω—ñ...", show_alert=False)
    
    # –í–∏–¥–∞–ª–∏—Ç–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –∑ –ø—Ä–æ–ø–æ–∑–∏—Ü—ñ—î—é
    try:
        await call.message.delete()
    except Exception as e:
        logger.warning(f"–ù–µ –≤–¥–∞–ª–æ—Å—è –≤–∏–¥–∞–ª–∏—Ç–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è: {e}")
    
    # –ü–æ–∫–∞–∑–∞—Ç–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è "–ü–æ—à—É–∫ –≤–æ–¥—ñ—è..." (–∑–Ω–æ–≤—É)
    current_fare = order.fare_amount if order.fare_amount else 100.0
    
    await call.bot.send_message(
        call.from_user.id,
        f"üîç <b>–®—É–∫–∞—î–º–æ –≤–æ–¥—ñ—è...</b>\n\n"
        f"üìç –ó–≤—ñ–¥–∫–∏: {order.pickup_address}\n"
        f"üìç –ö—É–¥–∏: {order.destination_address}\n\n"
        f"üí∞ –í–∞—Ä—Ç—ñ—Å—Ç—å: <b>{current_fare:.0f} –≥—Ä–Ω</b>\n\n"
        f"‚è≥ –ó–∞—á–µ–∫–∞–π—Ç–µ, –±—É–¥—å –ª–∞—Å–∫–∞...",
        reply_markup=main_menu_keyboard(is_registered=True, is_admin=is_admin)
    )
    
    logger.info(f"‚è≥ –ö–ª—ñ—î–Ω—Ç #{call.from_user.id} –≤–∏—Ä—ñ—à–∏–≤ –ø—Ä–æ–¥–æ–≤–∂–∏—Ç–∏ –æ—á—ñ–∫—É–≤–∞–Ω–Ω—è (–∑–∞–º–æ–≤–ª–µ–Ω–Ω—è #{order_id})")
```

---

### 3. –ü–æ–∫—Ä–∞—â–µ–Ω–æ –∫–Ω–æ–ø–∫—É "–ü—Ä–∏–π–Ω—è—Ç–∏"

**–§–∞–π–ª:** `app/handlers/driver_panel.py`

**–î–æ:**
```python
@router.callback_query(F.data.startswith("accept_order:"))
async def accept(call: CallbackQuery) -> None:
    if not call.from_user:
        return
    
    # Rate limiting
    if not check_rate_limit(...):
        await call.answer("‚è≥ –ó–∞–Ω–∞–¥—Ç–æ –±–∞–≥–∞—Ç–æ —Å–ø—Ä–æ–±", show_alert=True)
        return
    
    driver = await get_driver_by_tg_user_id(config.database_path, call.from_user.id)
    if not driver:
        return  # ‚ùå –¢–∏—Ö–æ —ñ–≥–Ω–æ—Ä—É—î—Ç—å—Å—è, –≤–æ–¥—ñ–π –Ω–µ –∑–Ω–∞—î —á–æ–º—É –Ω–µ –ø—Ä–∞—Ü—é—î
```

**–ü—ñ—Å–ª—è:**
```python
@router.callback_query(F.data.startswith("accept_order:"))
async def accept(call: CallbackQuery) -> None:
    if not call.from_user:
        logger.error("‚ùå accept_order: call.from_user is None")  # ‚≠ê –õ–û–ì
        return
    
    logger.info(f"üîî accept_order callback from user {call.from_user.id}")  # ‚≠ê –õ–û–ì
    
    # Rate limiting
    if not check_rate_limit(...):
        await call.answer("‚è≥ –ó–∞–Ω–∞–¥—Ç–æ –±–∞–≥–∞—Ç–æ —Å–ø—Ä–æ–±", show_alert=True)
        logger.warning(f"‚è±Ô∏è Driver {call.from_user.id} exceeded rate limit")  # ‚≠ê –õ–û–ì
        return
    
    driver = await get_driver_by_tg_user_id(config.database_path, call.from_user.id)
    if not driver:
        logger.error(f"‚ùå Driver not found for user {call.from_user.id}")  # ‚≠ê –õ–û–ì
        await call.answer(  # ‚≠ê –ü–û–í–Ü–î–û–ú–õ–ï–ù–ù–Ø –í–û–î–Ü–Æ
            "‚ùå –í–∏ –Ω–µ –∑–∞—Ä–µ—î—Å—Ç—Ä–æ–≤–∞–Ω—ñ —è–∫ –≤–æ–¥—ñ–π.\n"
            "–ó–∞—Ä–µ—î—Å—Ç—Ä—É–π—Ç–µ—Å—å —á–µ—Ä–µ–∑ /start ‚Üí –°—Ç–∞—Ç–∏ –≤–æ–¥—ñ—î–º",
            show_alert=True
        )
        return
```

**–ü–µ—Ä–µ–≤–∞–≥–∏:**
- –õ–æ–≥—É—î—Ç—å—Å—è –∫–æ–∂–Ω–µ –Ω–∞—Ç–∏—Å–∫–∞–Ω–Ω—è ‚úÖ
- –í–æ–¥—ñ–π –±–∞—á–∏—Ç—å —á–æ–º—É –Ω–µ –ø—Ä–∞—Ü—é—î ‚úÖ
- –ê–¥–º—ñ–Ω –º–æ–∂–µ –ø–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –ª–æ–≥–∏ ‚úÖ

---

## üß™ –¢–ï–°–¢–£–í–ê–ù–ù–Ø

### –¢–µ—Å—Ç 1: –ö–Ω–æ–ø–∫–∞ "–ü—Ä–æ–¥–æ–≤–∂–∏—Ç–∏ –æ—á—ñ–∫—É–≤–∞–Ω–Ω—è"

**–î—ñ—ó:**
1. –ö–ª—ñ—î–Ω—Ç —Å—Ç–≤–æ—Ä—é—î –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è
2. –ß–µ–∫–∞—î 3 —Ö–≤–∏–ª–∏–Ω–∏
3. –û—Ç—Ä–∏–º—É—î –ø—Ä–æ–ø–æ–∑–∏—Ü—ñ—é –ø—ñ–¥–≤–∏—â–∏—Ç–∏ —Ü—ñ–Ω—É
4. –ù–∞—Ç–∏—Å–∫–∞—î "‚è≥ –ü—Ä–æ–¥–æ–≤–∂–∏—Ç–∏ –æ—á—ñ–∫—É–≤–∞–Ω–Ω—è"

**–û—á—ñ–∫—É—î—Ç—å—Å—è:**
- ‚úÖ –ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –∑ –ø—Ä–æ–ø–æ–∑–∏—Ü—ñ—î—é –≤–∏–¥–∞–ª—è—î—Ç—å—Å—è
- ‚úÖ –ó'—è–≤–ª—è—î—Ç—å—Å—è "üîç –®—É–∫–∞—î–º–æ –≤–æ–¥—ñ—è..."
- ‚úÖ –¶—ñ–Ω–∞ –∑–∞–ª–∏—à–∞—î—Ç—å—Å—è –±–µ–∑ –∑–º—ñ–Ω (100 –≥—Ä–Ω)
- ‚úÖ –ó–∞–º–æ–≤–ª–µ–Ω–Ω—è –∞–∫—Ç–∏–≤–Ω–µ
- ‚úÖ –ß–µ—Ä–µ–∑ 3 —Ö–≤ –∑–Ω–æ–≤—É –ø—Ä–æ–ø–æ–∑–∏—Ü—ñ—è (—è–∫—â–æ –Ω—ñ—Ö—Ç–æ –Ω–µ –ø—Ä–∏–π–Ω—è–≤)

---

### –¢–µ—Å—Ç 2: –ö–Ω–æ–ø–∫–∞ "–°–∫–∞—Å—É–≤–∞—Ç–∏"

**–î—ñ—ó:**
1. –ö–ª—ñ—î–Ω—Ç –æ—Ç—Ä–∏–º—É—î –ø—Ä–æ–ø–æ–∑–∏—Ü—ñ—é –ø—ñ–¥–≤–∏—â–∏—Ç–∏ —Ü—ñ–Ω—É
2. –ù–∞—Ç–∏—Å–∫–∞—î "‚ùå –°–∫–∞—Å—É–≤–∞—Ç–∏ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è"

**–û—á—ñ–∫—É—î—Ç—å—Å—è:**
- ‚úÖ –ó–∞–º–æ–≤–ª–µ–Ω–Ω—è —Å–∫–∞—Å–æ–≤–∞–Ω–æ
- ‚úÖ –ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –≤ –≥—Ä—É–ø—ñ –æ–Ω–æ–≤–ª–µ–Ω–æ: "‚ùå –°–ö–ê–°–û–í–ê–ù–û"
- ‚úÖ –ö–ª—ñ—î–Ω—Ç –±–∞—á–∏—Ç—å: "‚úÖ –ó–∞–º–æ–≤–ª–µ–Ω–Ω—è —Å–∫–∞—Å–æ–≤–∞–Ω–æ"

---

### –¢–µ—Å—Ç 3: –ö–Ω–æ–ø–∫–∞ "–ü—Ä–∏–π–Ω—è—Ç–∏" (–¥—ñ–∞–≥–Ω–æ—Å—Ç–∏–∫–∞)

**–î—ñ—ó:**
1. –í–æ–¥—ñ–π –Ω–∞—Ç–∏—Å–∫–∞—î "‚úÖ –ü—Ä–∏–π–Ω—è—Ç–∏" –≤ –≥—Ä—É–ø—ñ
2. –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –ª–æ–≥–∏

**–ú–æ–∂–ª–∏–≤—ñ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∏:**

**A. –ü—Ä–∞—Ü—é—î:**
```
üîî accept_order callback from user 123456 (username: @driver1)
‚úÖ –ü—Ä–∏–π–Ω—è—Ç–æ!
```

**B. –ù–µ –∑–∞—Ä–µ—î—Å—Ç—Ä–æ–≤–∞–Ω–∏–π:**
```
üîî accept_order callback from user 123456
‚ùå Driver not found for user 123456
```
–í–æ–¥—ñ–π –±–∞—á–∏—Ç—å: "‚ùå –í–∏ –Ω–µ –∑–∞—Ä–µ—î—Å—Ç—Ä–æ–≤–∞–Ω—ñ —è–∫ –≤–æ–¥—ñ–π"

**C. Rate limit:**
```
üîî accept_order callback from user 123456
‚è±Ô∏è Driver 123456 exceeded accept_order rate limit
```
–í–æ–¥—ñ–π –±–∞—á–∏—Ç—å: "‚è≥ –ó–∞–Ω–∞–¥—Ç–æ –±–∞–≥–∞—Ç–æ —Å–ø—Ä–æ–±"

**D. –í–∂–µ –ø—Ä–∏–π–Ω—è—Ç–æ:**
```
üîî accept_order callback from user 123456
‚úÖ Driver found
‚ùå –í–∂–µ –ø—Ä–∏–π–Ω—è—Ç–æ
```

---

## üìä –°–¢–ê–¢–ò–°–¢–ò–ö–ê

### –ó–º—ñ–Ω–∏:

**app/utils/order_timeout.py:**
- +1 –∫–Ω–æ–ø–∫–∞ "‚è≥ –ü—Ä–æ–¥–æ–≤–∂–∏—Ç–∏ –æ—á—ñ–∫—É–≤–∞–Ω–Ω—è"

**app/handlers/order.py:**
- +40 —Ä—è–¥–∫—ñ–≤ (–æ–±—Ä–æ–±–Ω–∏–∫ `continue_waiting_handler`)

**app/handlers/driver_panel.py:**
- +10 —Ä—è–¥–∫—ñ–≤ (–ª–æ–≥—É–≤–∞–Ω–Ω—è + –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –ø—Ä–æ –ø–æ–º–∏–ª–∫—É)

---

## üéØ –ü–ï–†–ï–í–ê–ì–ò

### –î–ª—è –∫–ª—ñ—î–Ω—Ç–∞:
- ‚úÖ –ú–æ–∂–µ –ø—Ä–æ–¥–æ–≤–∂–∏—Ç–∏ –æ—á—ñ–∫—É–≤–∞–Ω–Ω—è –±–µ–∑ –ø—ñ–¥–≤–∏—â–µ–Ω–Ω—è —Ü—ñ–Ω–∏
- ‚úÖ –ù–µ –±–∞—á–∏—Ç—å –¥—Ä–∞—Ç—ñ–≤–ª–∏–≤–æ–≥–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –ø–æ—Å—Ç—ñ–π–Ω–æ
- ‚úÖ –ö–æ–Ω—Ç—Ä–æ–ª—å –Ω–∞–¥ —Å–∏—Ç—É–∞—Ü—ñ—î—é

### –î–ª—è –≤–æ–¥—ñ—è:
- ‚úÖ –ë–∞—á–∏—Ç—å —á–æ–º—É –Ω–µ –ø—Ä–∞—Ü—é—î –∫–Ω–æ–ø–∫–∞ "–ü—Ä–∏–π–Ω—è—Ç–∏"
- ‚úÖ –ß—ñ—Ç–∫—ñ —ñ–Ω—Å—Ç—Ä—É–∫—Ü—ñ—ó —è–∫ –≤–∏–ø—Ä–∞–≤–∏—Ç–∏

### –î–ª—è –∞–¥–º—ñ–Ω–∞:
- ‚úÖ –î–µ—Ç–∞–ª—å–Ω—ñ –ª–æ–≥–∏ –¥–ª—è –¥—ñ–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
- ‚úÖ –ó—Ä–æ–∑—É–º—ñ–ª–æ —â–æ –Ω–µ –ø—Ä–∞—Ü—é—î
- ‚úÖ –®–≤–∏–¥–∫–µ –≤–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è –ø—Ä–æ–±–ª–µ–º

---

## üìù –ü–†–ò–ö–õ–ê–î –õ–û–ì–Ü–í

### –£—Å–ø—ñ—à–Ω–µ –ø—Ä–∏–π–Ω—è—Ç—Ç—è:
```
2025-10-19 15:30:00 - driver_panel - INFO - üîî accept_order callback from user 123456 (username: @driver1)
2025-10-19 15:30:01 - driver_panel - INFO - ‚úÖ –¢–∞–π–º–µ—Ä —Å–∫–∞—Å–æ–≤–∞–Ω–æ –¥–ª—è –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è #42 (–ø—Ä–∏–π–Ω—è—Ç–æ –≤–æ–¥—ñ—î–º)
2025-10-19 15:30:02 - driver_panel - INFO - üìû –í–æ–¥—ñ–π Driver Name –æ—Ç—Ä–∏–º–∞–≤ —ñ–Ω—Ñ–æ –ø—Ä–æ –∫–ª—ñ—î–Ω—Ç–∞
```

### –ü–æ–º–∏–ª–∫–∞ (–Ω–µ –∑–∞—Ä–µ—î—Å—Ç—Ä–æ–≤–∞–Ω–∏–π):
```
2025-10-19 15:31:00 - driver_panel - INFO - üîî accept_order callback from user 789012 (username: @user2)
2025-10-19 15:31:00 - driver_panel - ERROR - ‚ùå Driver not found for user 789012
```

### –ü—Ä–æ–¥–æ–≤–∂–∏—Ç–∏ –æ—á—ñ–∫—É–≤–∞–Ω–Ω—è:
```
2025-10-19 15:32:00 - order - INFO - ‚è≥ –ö–ª—ñ—î–Ω—Ç #654321 –≤–∏—Ä—ñ—à–∏–≤ –ø—Ä–æ–¥–æ–≤–∂–∏—Ç–∏ –æ—á—ñ–∫—É–≤–∞–Ω–Ω—è –±–µ–∑ –ø—ñ–¥–≤–∏—â–µ–Ω–Ω—è —Ü—ñ–Ω–∏ (–∑–∞–º–æ–≤–ª–µ–Ω–Ω—è #43)
```

---

## üîç –î–Ü–ê–ì–ù–û–°–¢–ò–ö–ê –ü–†–û–ë–õ–ï–ú–ò "–ü–†–ò–ô–ù–Ø–¢–ò"

### –ö—Ä–æ–∫ 1: –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –ª–æ–≥–∏

–ö–æ–ª–∏ –≤–æ–¥—ñ–π –Ω–∞—Ç–∏—Å–∫–∞—î "‚úÖ –ü—Ä–∏–π–Ω—è—Ç–∏", —à—É–∫–∞–π—Ç–µ –≤ –ª–æ–≥–∞—Ö:

```bash
grep "accept_order callback" app.log
```

### –ö—Ä–æ–∫ 2: –í–∏–∑–Ω–∞—á–∏—Ç–∏ –ø—Ä–æ–±–ª–µ–º—É

**–Ø–∫—â–æ –±–∞—á–∏—Ç–µ:**
```
‚ùå Driver not found for user 123456
```

**–†—ñ—à–µ–Ω–Ω—è:**
–í–æ–¥—ñ–π –Ω–µ –∑–∞—Ä–µ—î—Å—Ç—Ä–æ–≤–∞–Ω–∏–π. –í—ñ–Ω –º–∞—î:
1. /start ‚Üí –°—Ç–∞—Ç–∏ –≤–æ–¥—ñ—î–º
2. –ó–∞–ø–æ–≤–Ω–∏—Ç–∏ –∞–Ω–∫–µ—Ç—É
3. –î–æ—á–µ–∫–∞—Ç–∏—Å—è —Å—Ö–≤–∞–ª–µ–Ω–Ω—è –∞–¥–º—ñ–Ω–æ–º

**–Ø–∫—â–æ –±–∞—á–∏—Ç–µ:**
```
‚è±Ô∏è Driver 123456 exceeded accept_order rate limit
```

**–†—ñ—à–µ–Ω–Ω—è:**
–í–æ–¥—ñ–π –Ω–∞—Ç–∏—Å–Ω—É–≤ 20 —Ä–∞–∑—ñ–≤ –∑–∞ –≥–æ–¥–∏–Ω—É. –ó–∞—á–µ–∫–∞—Ç–∏ –≥–æ–¥–∏–Ω—É –∞–±–æ:
```python
# –í –∫–æ–¥—ñ –∑–±—ñ–ª—å—à–∏—Ç–∏ –ª—ñ–º—ñ—Ç (–Ω–µ —Ä–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–æ):
max_requests=20  ‚Üí  max_requests=50
```

**–Ø–∫—â–æ –ù–ï –±–∞—á–∏—Ç–µ –≤–∑–∞–≥–∞–ª—ñ:**
```
(–Ω—ñ—á–æ–≥–æ –≤ –ª–æ–≥–∞—Ö)
```

**–†—ñ—à–µ–Ω–Ω—è:**
–†–æ—É—Ç–µ—Ä driver_panel –Ω–µ –ø—ñ–¥–∫–ª—é—á–µ–Ω–∏–π –∞–±–æ callback data –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∏–π.
–ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ main.py: `dp.include_router(create_driver_panel_router(config))`

---

## üéâ –†–ï–ó–£–õ–¨–¢–ê–¢

### –ë—É–ª–æ:
```
‚ùå –ö–Ω–æ–ø–∫–∞ "–ü—Ä–∏–π–Ω—è—Ç–∏" –Ω–µ –ø—Ä–∞—Ü—é—î (–Ω–µ–≤—ñ–¥–æ–º–æ —á–æ–º—É)
‚ùå –ö–Ω–æ–ø–∫–∞ "–°–∫–∞—Å—É–≤–∞—Ç–∏" –Ω–µ –ø—Ä–∞—Ü—é—î
‚ùå –ù–µ–º–∞—î –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∏ –ø—ñ–¥–≤–∏—â–µ–Ω–Ω—é —Ü—ñ–Ω–∏
```

### –°—Ç–∞–ª–æ:
```
‚úÖ –ö–Ω–æ–ø–∫–∞ "–ü—Ä–∏–π–Ω—è—Ç–∏" –∑ –¥—ñ–∞–≥–Ω–æ—Å—Ç–∏–∫–æ—é (–≤–∏–¥–Ω–æ —á–æ–º—É –Ω–µ –ø—Ä–∞—Ü—é—î)
‚úÖ –ö–Ω–æ–ø–∫–∞ "–°–∫–∞—Å—É–≤–∞—Ç–∏" –º–∞—î –ø—Ä–∞—Ü—é–≤–∞—Ç–∏ (–æ–±—Ä–æ–±–Ω–∏–∫ —ñ—Å–Ω—É—î)
‚úÖ –ù–æ–≤–∞ –∫–Ω–æ–ø–∫–∞ "‚è≥ –ü—Ä–æ–¥–æ–≤–∂–∏—Ç–∏ –æ—á—ñ–∫—É–≤–∞–Ω–Ω—è"
‚úÖ –ö–ª—ñ—î–Ω—Ç –º–æ–∂–µ –≤—ñ–¥–º–æ–≤–∏—Ç–∏—Å—è –≤—ñ–¥ –ø—ñ–¥–≤–∏—â–µ–Ω–Ω—è —Ü—ñ–Ω–∏
‚úÖ –î–µ—Ç–∞–ª—å–Ω—ñ –ª–æ–≥–∏ –¥–ª—è –≤—Å—ñ—Ö –æ–ø–µ—Ä–∞—Ü—ñ–π
‚úÖ –ó—Ä–æ–∑—É–º—ñ–ª—ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –ø—Ä–æ –ø–æ–º–∏–ª–∫–∏
```

---

## üì¢ –Ü–ù–°–¢–†–£–ö–¶–Ü–á –î–õ–Ø –ö–û–†–ò–°–¢–£–í–ê–ß–ê

### –Ø–∫—â–æ –∫–Ω–æ–ø–∫–∞ "–ü—Ä–∏–π–Ω—è—Ç–∏" –Ω–µ –ø—Ä–∞—Ü—é—î:

1. **–ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ —á–∏ –≤–∏ –∑–∞—Ä–µ—î—Å—Ç—Ä–æ–≤–∞–Ω—ñ —è–∫ –≤–æ–¥—ñ–π:**
   - /start ‚Üí –°—Ç–∞—Ç–∏ –≤–æ–¥—ñ—î–º
   - –ó–∞–ø–æ–≤–Ω–∏—Ç–∏ –∞–Ω–∫–µ—Ç—É
   - –î–æ—á–µ–∫–∞—Ç–∏—Å—è —Å—Ö–≤–∞–ª–µ–Ω–Ω—è

2. **–ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –ª–æ–≥–∏:**
   - –ù–∞—Ç–∏—Å–Ω—ñ—Ç—å –∫–Ω–æ–ø–∫—É
   - –ü–æ–¥–∏–≤—ñ—Ç—å—Å—è —â–æ –Ω–∞–ø–∏—Å–∞–Ω–æ –≤ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—ñ
   - –ü–æ–≤—ñ–¥–æ–º—Ç–µ –∞–¥–º—ñ–Ω—É —è–∫—â–æ –ø—Ä–æ–±–ª–µ–º–∞

3. **–Ø–∫—â–æ rate limit:**
   - –ó–∞—á–µ–∫–∞–π—Ç–µ –≥–æ–¥–∏–Ω—É
   - –ù–µ –Ω–∞—Ç–∏—Å–∫–∞–π—Ç–µ –±–∞–≥–∞—Ç–æ —Ä–∞–∑—ñ–≤ –ø—ñ–¥—Ä—è–¥

---

**–í–°–ï –ì–û–¢–û–í–û! –ö–ù–û–ü–ö–ò –í–ò–ü–†–ê–í–õ–ï–ù–û –¢–ê –ü–û–ö–†–ê–©–ï–ù–û!** ‚úÖüîßüéâ

**–ü—Ä–æ—Ç–µ—Å—Ç—É–π—Ç–µ —Ç–∞ –ø–µ—Ä–µ–≤—ñ—Ä—Ç–µ –ª–æ–≥–∏!** üîç
