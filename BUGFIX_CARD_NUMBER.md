# üêõ –í–ò–ü–†–ê–í–õ–ï–ù–ù–Ø: AttributeError card_number

**–î–∞—Ç–∞:** 2025-10-17  
**Commit:** 172951e ‚Üí (–Ω–æ–≤–∏–π)  
**–¢–∏–ø:** –ö—Ä–∏—Ç–∏—á–Ω–µ –≤–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è

---

## ‚ùå –ü–†–û–ë–õ–ï–ú–ê

–ö–æ–ª–∏ –≤–æ–¥—ñ–π –Ω–∞—Ç–∏—Å–∫–∞—î –Ω–∞ "üíº –ì–∞–º–∞–Ω–µ—Ü—å" —É —Å–≤–æ—î–º—É –∫–∞–±—ñ–Ω–µ—Ç—ñ:

```
AttributeError: 'Driver' object has no attribute 'card_number'
```

**–ú—ñ—Å—Ü–µ –ø–æ–º–∏–ª–∫–∏:**
- `app/handlers/driver_panel.py` ‚Üí —Ñ—É–Ω–∫—Ü—ñ—è `wallet_handler()`
- –†—è–¥–æ–∫: `if driver.card_number:`

---

## üîç –ü–†–ò–ß–ò–ù–ê

**–ö–ª–∞—Å `Driver` –Ω–µ –º–∞–≤ –∞—Ç—Ä–∏–±—É—Ç–∞ `card_number`:**

```python
# db.py (–ë–£–õ–û):
@dataclass
class Driver:
    id: Optional[int]
    tg_user_id: int
    # ... —ñ–Ω—à—ñ –ø–æ–ª—è
    car_class: str = "economy"
    # ‚ùå –ù–µ–º–∞—î card_number!
```

**driver_panel.py –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞–≤ –π–æ–≥–æ:**
```python
# driver_panel.py:
if driver.card_number:  # ‚ùå AttributeError!
    text = f"üí≥ –ö–∞—Ä—Ç–∫–∞: {driver.card_number}"
```

---

## ‚úÖ –í–ò–ü–†–ê–í–õ–ï–ù–ù–Ø

### 1Ô∏è‚É£ –î–æ–¥–∞–Ω–æ –∞—Ç—Ä–∏–±—É—Ç –¥–æ –∫–ª–∞—Å—É Driver

```python
# db.py (–°–¢–ê–õ–û):
@dataclass
class Driver:
    # ... —ñ—Å–Ω—É—é—á—ñ –ø–æ–ª—è
    car_class: str = "economy"
    card_number: Optional[str] = None  # ‚úÖ –î–æ–¥–∞–Ω–æ!
```

### 2Ô∏è‚É£ –î–æ–¥–∞–Ω–æ –∫–æ–ª–æ–Ω–∫—É –≤ CREATE TABLE

```python
# db.py - init_database():
CREATE TABLE IF NOT EXISTS drivers (
    # ... —ñ—Å–Ω—É—é—á—ñ –∫–æ–ª–æ–Ω–∫–∏
    car_class TEXT NOT NULL DEFAULT 'economy',
    card_number TEXT  -- ‚úÖ –î–æ–¥–∞–Ω–æ!
)
```

### 3Ô∏è‚É£ –û–Ω–æ–≤–ª–µ–Ω–æ –í–°–Ü SELECT –∑–∞–ø–∏—Ç–∏

**–û–Ω–æ–≤–ª–µ–Ω–æ 4 —Ñ—É–Ω–∫—Ü—ñ—ó:**

```python
# fetch_pending_drivers()
SELECT ..., car_class, card_number FROM drivers  -- +2 –ø–æ–ª—è

# get_driver_by_id()
SELECT ..., car_class, card_number FROM drivers WHERE id = ?

# get_driver_by_tg_user_id()
SELECT ..., car_class, card_number FROM drivers WHERE tg_user_id = ?

# get_online_drivers()
SELECT ..., car_class, card_number FROM drivers WHERE online = 1
```

### 4Ô∏è‚É£ –û–Ω–æ–≤–ª–µ–Ω–æ Driver() –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä–∏

```python
# –ë—É–ª–æ:
Driver(
    id=row[0],
    # ... row[1-15]
    last_seen_at=row[15],
    # ‚ùå –ù–µ–º–∞—î car_class, card_number
)

# –°—Ç–∞–ª–æ:
Driver(
    id=row[0],
    # ... row[1-15]
    last_seen_at=row[15],
    car_class=row[16] if row[16] else "economy",  # ‚úÖ
    card_number=row[17],  # ‚úÖ
)
```

### 5Ô∏è‚É£ –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∞ –º—ñ–≥—Ä–∞—Ü—ñ—è

```python
# db.py - –Ω–æ–≤–∞ —Ñ—É–Ω–∫—Ü—ñ—è:
async def ensure_driver_columns(db_path: str):
    """–ú—ñ–≥—Ä–∞—Ü—ñ—è: –¥–æ–¥–∞—Ç–∏ card_number —è–∫—â–æ –Ω–µ–º–∞—î"""
    # –ü–µ—Ä–µ–≤—ñ—Ä—è—î —á–∏ —ñ—Å–Ω—É—î –∫–æ–ª–æ–Ω–∫–∞
    # –Ø–∫—â–æ –Ω–µ–º–∞—î - –¥–æ–¥–∞—î —á–µ—Ä–µ–∑ ALTER TABLE
```

```python
# main.py:
async def main():
    await init_db(config.database_path)
    # ‚Üë –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –≤–∏–∫–ª–∏–∫–∞—î ensure_driver_columns()
```

---

## üìä –©–û –ó–ú–Ü–ù–ò–õ–û–°–¨

| –§–∞–π–ª | –†—è–¥–∫—ñ–≤ –∑–º—ñ–Ω–µ–Ω–æ | –©–æ –¥–æ–¥–∞–Ω–æ |
|------|---------------|-----------|
| `db.py` | ~60 | +1 –∞—Ç—Ä–∏–±—É—Ç, +1 –∫–æ–ª–æ–Ω–∫–∞, 4 —Ñ—É–Ω–∫—Ü—ñ—ó –æ–Ω–æ–≤–ª–µ–Ω–æ, +1 –º—ñ–≥—Ä–∞—Ü—ñ—è |
| `main.py` | 0 | (–∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ —á–µ—Ä–µ–∑ init_db) |
| `migration_add_card_number.py` | +44 | –†—É—á–Ω–∞ –º—ñ–≥—Ä–∞—Ü—ñ—è (–æ–ø—Ü—ñ–æ–Ω–∞–ª—å–Ω–æ) |

---

## üéØ –†–ï–ó–£–õ–¨–¢–ê–¢

### –î–û:
```
–í–æ–¥—ñ–π –Ω–∞—Ç–∏—Å–∫–∞—î "üíº –ì–∞–º–∞–Ω–µ—Ü—å"
    ‚Üì
‚ùå AttributeError: 'Driver' object has no attribute 'card_number'
–ë–û–¢ –ü–ê–î–ê–Ñ
```

### –ü–Ü–°–õ–Ø:
```
–í–æ–¥—ñ–π –Ω–∞—Ç–∏—Å–∫–∞—î "üíº –ì–∞–º–∞–Ω–µ—Ü—å"
    ‚Üì
‚úÖ –ü–æ–∫–∞–∑—É—î—Ç—å—Å—è:
   üíº –í–∞—à –≥–∞–º–∞–Ω–µ—Ü—å
   üí≥ –ö–∞—Ä—Ç–∫–∞ –¥–ª—è –æ–ø–ª–∞—Ç–∏: (–Ω–µ –¥–æ–¥–∞–Ω–æ)
   
   –∞–±–æ
   
   üí≥ –ö–∞—Ä—Ç–∫–∞: 1234 5678 9012 3456
   ‚ÑπÔ∏è –¶—è –∫–∞—Ä—Ç–∫–∞ –ø–æ–∫–∞–∑—É—î—Ç—å—Å—è –∫–ª—ñ—î–Ω—Ç–∞–º
```

---

## üß™ –¢–ï–°–¢–£–í–ê–ù–ù–Ø

### –¢–µ—Å—Ç 1: –ù–æ–≤–∏–π –≤–æ–¥—ñ–π
```
1. –ó–∞—Ä–µ—î—Å—Ç—Ä—É–≤–∞—Ç–∏—Å—å —è–∫ –≤–æ–¥—ñ–π ‚úÖ
2. –í—ñ–¥–∫—Ä–∏—Ç–∏ "üíº –ì–∞–º–∞–Ω–µ—Ü—å" ‚úÖ
3. –î–æ–¥–∞—Ç–∏ –Ω–æ–º–µ—Ä –∫–∞—Ä—Ç–∫–∏: 1234567890123456 ‚úÖ
4. –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —â–æ –∑–±–µ—Ä–µ–∂–µ–Ω–æ ‚úÖ
```

### –¢–µ—Å—Ç 2: –Ü—Å–Ω—É—é—á–∏–π –≤–æ–¥—ñ–π (–±–µ–∑ –∫–∞—Ä—Ç–∫–∏)
```
1. driver.card_number = None
2. –í—ñ–¥–∫—Ä–∏—Ç–∏ "üíº –ì–∞–º–∞–Ω–µ—Ü—å" ‚úÖ
3. –ü–æ–∫–∞–∑—É—î "–Ω–µ –¥–æ–¥–∞–Ω–æ" ‚úÖ
4. –î–æ–¥–∞—Ç–∏ –∫–∞—Ä—Ç–∫—É ‚úÖ
```

### –¢–µ—Å—Ç 3: –ö–ª—ñ—î–Ω—Ç –±–∞—á–∏—Ç—å –∫–∞—Ä—Ç–∫—É
```
1. –ö–ª—ñ—î–Ω—Ç —Å—Ç–≤–æ—Ä—é—î –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è
2. –û–±–∏—Ä–∞—î "üí≥ –û–ø–ª–∞—Ç–∞ –∫–∞—Ä—Ç–∫–æ—é"
3. –í–æ–¥—ñ–π –ø—Ä–∏–π–º–∞—î
4. –ö–ª—ñ—î–Ω—Ç –±–∞—á–∏—Ç—å:
   üí≥ –ö–∞—Ä—Ç–∫–∞ –¥–ª—è –æ–ø–ª–∞—Ç–∏: 1234 5678 9012 3456 ‚úÖ
```

---

## üìù –ú–Ü–ì–†–ê–¶–Ü–Ø –Ü–°–ù–£–Æ–ß–ò–• –ë–î

**–ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ:** –ü—Ä–∏ —Å—Ç–∞—Ä—Ç—ñ –±–æ—Ç–∞ –≤–∏–∫–ª–∏–∫–∞—î—Ç—å—Å—è `ensure_driver_columns()`

**–í—Ä—É—á–Ω—É (—è–∫—â–æ –ø–æ—Ç—Ä—ñ–±–Ω–æ):**
```bash
python migration_add_card_number.py data/taxi.db
```

**–ù–∞ Render:** –ù—ñ—á–æ–≥–æ —Ä–æ–±–∏—Ç–∏ –Ω–µ –ø–æ—Ç—Ä—ñ–±–Ω–æ - –º—ñ–≥—Ä–∞—Ü—ñ—è –≤—ñ–¥–±—É–¥–µ—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –ø—Ä–∏ –¥–µ–ø–ª–æ—ó!

---

## ‚úÖ CHECKLIST

- [x] –î–æ–¥–∞–Ω–æ `card_number` –¥–æ –∫–ª–∞—Å—É `Driver`
- [x] –î–æ–¥–∞–Ω–æ –∫–æ–ª–æ–Ω–∫—É –≤ `CREATE TABLE drivers`
- [x] –û–Ω–æ–≤–ª–µ–Ω–æ 4 SELECT –∑–∞–ø–∏—Ç–∏
- [x] –û–Ω–æ–≤–ª–µ–Ω–æ 4 Driver() –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä–∏
- [x] –î–æ–¥–∞–Ω–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω—É –º—ñ–≥—Ä–∞—Ü—ñ—é
- [x] –°—Ç–≤–æ—Ä–µ–Ω–æ —Ä—É—á–Ω–∏–π –º—ñ–≥—Ä–∞—Ü—ñ–π–Ω–∏–π —Å–∫—Ä–∏–ø—Ç
- [x] –ü—Ä–æ—Ç–µ—Å—Ç–æ–≤–∞–Ω–æ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å
- [x] –°—Ç–≤–æ—Ä–µ–Ω–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü—ñ—é

---

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ì–û–¢–û–í–û –î–û –î–ï–ü–õ–û–Æ  
**–ù–∞—Å—Ç—É–ø–Ω–∏–π –∫—Ä–æ–∫:** Git push ‚Üí Render redeploy ‚Üí –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∞ –º—ñ–≥—Ä–∞—Ü—ñ—è –ë–î
