# –ú—ñ–≥—Ä–∞—Ü—ñ—ó PostgreSQL –¥–ª—è –æ–Ω–æ–≤–ª–µ–Ω–Ω—è —Å—Ö–µ–º–∏ –ë–î

**–î–∞—Ç–∞:** 2025-10-19  
**–ö–æ–º—ñ—Ç:** a31396f  
**–ü—Ä–æ–±–ª–µ–º–∞:** `asyncpg.exceptions.UndefinedColumnError: column "to_user_id" does not exist`

## –ü—Ä–æ–±–ª–µ–º–∞

–ü—Ä–∏ —Å–ø—Ä–æ–±—ñ —Å—Ç–≤–æ—Ä–∏—Ç–∏ —ñ–Ω–¥–µ–∫—Å –Ω–∞ –∫–æ–ª–æ–Ω–∫—É `ratings.to_user_id`, –≤–∏–Ω–∏–∫–∞–ª–∞ –ø–æ–º–∏–ª–∫–∞, —Ç–æ–º—É —â–æ:
- –¢–∞–±–ª–∏—Ü—è `ratings` –≤–∂–µ —ñ—Å–Ω—É–≤–∞–ª–∞ –∑—ñ —Å—Ç–∞—Ä–æ—é —Å—Ö–µ–º–æ—é
- –°—Ç–∞—Ä–∞ —Å—Ö–µ–º–∞ –º–∞–ª–∞ –∫–æ–ª–æ–Ω–∫—É `driver_user_id`
- –ù–æ–≤–∞ —Å—Ö–µ–º–∞ –º–∞—î –∫–æ–ª–æ–Ω–∫–∏ `from_user_id` —Ç–∞ `to_user_id`
- `CREATE INDEX IF NOT EXISTS` –Ω–µ —Å—Ç–≤–æ—Ä—é—î —ñ–Ω–¥–µ–∫—Å, —è–∫—â–æ –∫–æ–ª–æ–Ω–∫–∏ –Ω–µ —ñ—Å–Ω—É—î

## –†—ñ—à–µ–Ω–Ω—è

–î–æ–¥–∞–Ω–æ —Å–∏—Å—Ç–µ–º—É –º—ñ–≥—Ä–∞—Ü—ñ–π –≤ `init_postgres.py`, —è–∫–∞:
1. –ü–µ—Ä–µ–≤—ñ—Ä—è—î —ñ—Å–Ω—É–≤–∞–Ω–Ω—è —Ç–∞–±–ª–∏—Ü—å
2. –ü–µ—Ä–µ–≤—ñ—Ä—è—î —ñ—Å–Ω—É–≤–∞–Ω–Ω—è –∫–æ–ª–æ–Ω–æ–∫
3. –í–∏–∫–æ–Ω—É—î –Ω–µ–æ–±—Ö—ñ–¥–Ω—ñ –∑–º—ñ–Ω–∏ —Å—Ö–µ–º–∏ (ALTER TABLE)
4. –ë–µ–∑–ø–µ—á–Ω–æ —Å—Ç–≤–æ—Ä—é—î —ñ–Ω–¥–µ–∫—Å–∏

## –ú—ñ–≥—Ä–∞—Ü—ñ—ó

### –ú—ñ–≥—Ä–∞—Ü—ñ—è 1: –¢–∞–±–ª–∏—Ü—è `ratings`

**–ü—Ä–æ–±–ª–µ–º–∞:** –°—Ç–∞—Ä–∞ –∫–æ–ª–æ–Ω–∫–∞ `driver_user_id` ‚Üí –ù–æ–≤—ñ –∫–æ–ª–æ–Ω–∫–∏ `from_user_id` —Ç–∞ `to_user_id`

**–†—ñ—à–µ–Ω–Ω—è:**
```sql
-- –ü–µ—Ä–µ–π–º–µ–Ω—É–≤–∞—Ç–∏ driver_user_id –Ω–∞ to_user_id
ALTER TABLE ratings RENAME COLUMN driver_user_id TO to_user_id;

-- –î–æ–¥–∞—Ç–∏ –Ω–æ–≤—É –∫–æ–ª–æ–Ω–∫—É from_user_id
ALTER TABLE ratings ADD COLUMN from_user_id BIGINT;

-- –ó–∞–ø–æ–≤–Ω–∏—Ç–∏ –¥–∞–Ω—ñ (—Ç–∏–º—á–∞—Å–æ–≤–æ –∫–æ–ø—ñ—é–≤–∞—Ç–∏ –∑ to_user_id)
UPDATE ratings SET from_user_id = to_user_id WHERE from_user_id IS NULL;

-- –ó—Ä–æ–±–∏—Ç–∏ –∫–æ–ª–æ–Ω–∫—É –æ–±–æ–≤'—è–∑–∫–æ–≤–æ—é
ALTER TABLE ratings ALTER COLUMN from_user_id SET NOT NULL;
```

### –ú—ñ–≥—Ä–∞—Ü—ñ—è 2: –¢–∞–±–ª–∏—Ü—è `client_ratings`

**–ü—Ä–æ–±–ª–µ–º–∞:** –í—ñ–¥—Å—É—Ç–Ω—è –∫–æ–ª–æ–Ω–∫–∞ `driver_id`

**–†—ñ—à–µ–Ω–Ω—è:**
```sql
-- –î–æ–¥–∞—Ç–∏ –∫–æ–ª–æ–Ω–∫—É driver_id
ALTER TABLE client_ratings ADD COLUMN driver_id INTEGER;
```

## –ë–µ–∑–ø–µ—á–Ω–µ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è —ñ–Ω–¥–µ–∫—Å—ñ–≤

–î–æ–¥–∞–Ω–æ —Ñ—É–Ω–∫—Ü—ñ—é `create_index_safe()`, —è–∫–∞:
1. –ü–µ—Ä–µ–≤—ñ—Ä—è—î —á–∏ —ñ—Å–Ω—É—î —Ç–∞–±–ª–∏—Ü—è
2. –ü–µ—Ä–µ–≤—ñ—Ä—è—î —á–∏ —ñ—Å–Ω—É—î –∫–æ–ª–æ–Ω–∫–∞
3. –°—Ç–≤–æ—Ä—é—î —ñ–Ω–¥–µ–∫—Å —Ç—ñ–ª—å–∫–∏ —è–∫—â–æ –∫–æ–ª–æ–Ω–∫–∞ —ñ—Å–Ω—É—î
4. –õ–æ–≥—É—î –ø–æ–ø–µ—Ä–µ–¥–∂–µ–Ω–Ω—è —è–∫—â–æ –∫–æ–ª–æ–Ω–∫–∞ –≤—ñ–¥—Å—É—Ç–Ω—è

```python
async def create_index_safe(index_name: str, table: str, column: str):
    try:
        # –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —á–∏ —ñ—Å–Ω—É—î –∫–æ–ª–æ–Ω–∫–∞
        exists = await conn.fetchval(f"""
            SELECT EXISTS (
                SELECT FROM information_schema.columns 
                WHERE table_name = '{table}' AND column_name = '{column}'
            )
        """)
        if exists:
            await conn.execute(f"CREATE INDEX IF NOT EXISTS {index_name} ON {table}({column})")
        else:
            logger.warning(f"‚ö†Ô∏è –ö–æ–ª–æ–Ω–∫–∞ {table}.{column} –Ω–µ —ñ—Å–Ω—É—î, –ø—Ä–æ–ø—É—Å–∫–∞—é —ñ–Ω–¥–µ–∫—Å")
    except Exception as e:
        logger.warning(f"‚ö†Ô∏è –ù–µ –≤–¥–∞–ª–æ—Å—è —Å—Ç–≤–æ—Ä–∏—Ç–∏ —ñ–Ω–¥–µ–∫—Å {index_name}: {e}")
```

## –ü—Ä–æ—Ü–µ—Å –º—ñ–≥—Ä–∞—Ü—ñ—ó

–ü—Ä–∏ –∫–æ–∂–Ω–æ–º—É –∑–∞–ø—É—Å–∫—É `init_postgres_db()`:

1. **–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –º—ñ–≥—Ä–∞—Ü—ñ–π** (–∑–∞–≤–∂–¥–∏ –ø–µ—Ä—à–æ—é)
   ```
   üîÑ –ü–µ—Ä–µ–≤—ñ—Ä—è—é –Ω–µ–æ–±—Ö—ñ–¥–Ω—ñ—Å—Ç—å –º—ñ–≥—Ä–∞—Ü—ñ–π...
   ```

2. **–í–∏–∫–æ–Ω–∞–Ω–Ω—è –º—ñ–≥—Ä–∞—Ü—ñ–π** (—è–∫—â–æ –ø–æ—Ç—Ä—ñ–±–Ω–æ)
   ```
   üîÑ –ú—ñ–≥—Ä–∞—Ü—ñ—è ratings: –ø–µ—Ä–µ–π–º–µ–Ω—É–≤–∞–Ω–Ω—è driver_user_id...
   ‚úÖ –ö–æ–ª–æ–Ω–∫–∞ driver_user_id –ø–µ—Ä–µ–π–º–µ–Ω–æ–≤–∞–Ω–∞ –Ω–∞ to_user_id
   üîÑ –ú—ñ–≥—Ä–∞—Ü—ñ—è ratings: –¥–æ–¥–∞–≤–∞–Ω–Ω—è from_user_id...
   ‚úÖ –ö–æ–ª–æ–Ω–∫–∞ from_user_id –¥–æ–¥–∞–Ω–∞
   ```

3. **–°—Ç–≤–æ—Ä–µ–Ω–Ω—è –Ω–æ–≤–∏—Ö —Ç–∞–±–ª–∏—Ü—å** (—è–∫—â–æ –Ω–µ —ñ—Å–Ω—É—é—Ç—å)
   ```
   üêò –°—Ç–≤–æ—Ä—é—é —Ç–∞–±–ª–∏—Ü—ñ –≤ PostgreSQL...
   ```

4. **–°—Ç–≤–æ—Ä–µ–Ω–Ω—è —ñ–Ω–¥–µ–∫—Å—ñ–≤** (–±–µ–∑–ø–µ—á–Ω–æ)
   ```
   üîç –°—Ç–≤–æ—Ä—é—é —ñ–Ω–¥–µ–∫—Å–∏...
   ‚úÖ –í—Å—ñ —Ç–∞–±–ª–∏—Ü—ñ —Ç–∞ —ñ–Ω–¥–µ–∫—Å–∏ PostgreSQL —Å—Ç–≤–æ—Ä–µ–Ω–æ!
   ```

## –ü–µ—Ä–µ–≤–∞–≥–∏ —Ü—å–æ–≥–æ –ø—ñ–¥—Ö–æ–¥—É

‚úÖ **–ë–µ–∑–ø–µ—á–Ω—ñ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è:** –ú—ñ–≥—Ä–∞—Ü—ñ—ó –≤–∏–∫–æ–Ω—É—é—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –ø—Ä–∏ deploy  
‚úÖ **–ù–µ–º–∞—î –≤—Ç—Ä–∞—Ç–∏ –¥–∞–Ω–∏—Ö:** –î–∞–Ω—ñ –∑–±–µ—Ä—ñ–≥–∞—é—Ç—å—Å—è –ø—Ä–∏ –ø–µ—Ä–µ–π–º–µ–Ω—É–≤–∞–Ω–Ω—ñ –∫–æ–ª–æ–Ω–æ–∫  
‚úÖ **Graceful degradation:** –ü–æ–º–∏–ª–∫–∏ –º—ñ–≥—Ä–∞—Ü—ñ–π –Ω–µ –∑—É–ø–∏–Ω—è—é—Ç—å –∑–∞–ø—É—Å–∫ –±–æ—Ç–∞  
‚úÖ **–õ–æ–≥—É–≤–∞–Ω–Ω—è:** –í—Å—ñ –¥—ñ—ó –ª–æ–≥—É—é—Ç—å—Å—è –¥–ª—è –º–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥—É  
‚úÖ **–Ü–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω—ñ—Å—Ç—å:** –ú–æ–∂–Ω–∞ –∑–∞–ø—É—Å–∫–∞—Ç–∏ –±–∞–≥–∞—Ç–æ —Ä–∞–∑—ñ–≤ - —Å–ø—Ä–∞—Ü—é—î —Ç—ñ–ª—å–∫–∏ —Ä–∞–∑  

## –¢–µ—Å—Ç—É–≤–∞–Ω–Ω—è

### –°—Ü–µ–Ω–∞—Ä—ñ–π 1: –ü–µ—Ä—à–∏–π –∑–∞–ø—É—Å–∫ (–Ω–æ–≤—ñ —Ç–∞–±–ª–∏—Ü—ñ)
```
üîÑ –ü–µ—Ä–µ–≤—ñ—Ä—è—é –Ω–µ–æ–±—Ö—ñ–¥–Ω—ñ—Å—Ç—å –º—ñ–≥—Ä–∞—Ü—ñ–π...
‚úÖ –ú—ñ–≥—Ä–∞—Ü—ñ—ó –∑–∞–≤–µ—Ä—à–µ–Ω–æ!
üêò –°—Ç–≤–æ—Ä—é—é —Ç–∞–±–ª–∏—Ü—ñ –≤ PostgreSQL...
‚úÖ –í—Å—ñ —Ç–∞–±–ª–∏—Ü—ñ —Ç–∞ —ñ–Ω–¥–µ–∫—Å–∏ PostgreSQL —Å—Ç–≤–æ—Ä–µ–Ω–æ!
```

### –°—Ü–µ–Ω–∞—Ä—ñ–π 2: –û–Ω–æ–≤–ª–µ–Ω–Ω—è —ñ—Å–Ω—É—é—á–∏—Ö —Ç–∞–±–ª–∏—Ü—å
```
üîÑ –ü–µ—Ä–µ–≤—ñ—Ä—è—é –Ω–µ–æ–±—Ö—ñ–¥–Ω—ñ—Å—Ç—å –º—ñ–≥—Ä–∞—Ü—ñ–π...
üîÑ –ú—ñ–≥—Ä–∞—Ü—ñ—è ratings: –ø–µ—Ä–µ–π–º–µ–Ω—É–≤–∞–Ω–Ω—è driver_user_id...
‚úÖ –ö–æ–ª–æ–Ω–∫–∞ driver_user_id –ø–µ—Ä–µ–π–º–µ–Ω–æ–≤–∞–Ω–∞ –Ω–∞ to_user_id
üîÑ –ú—ñ–≥—Ä–∞—Ü—ñ—è ratings: –¥–æ–¥–∞–≤–∞–Ω–Ω—è from_user_id...
‚úÖ –ö–æ–ª–æ–Ω–∫–∞ from_user_id –¥–æ–¥–∞–Ω–∞
‚úÖ –ú—ñ–≥—Ä–∞—Ü—ñ—ó –∑–∞–≤–µ—Ä—à–µ–Ω–æ!
üêò –°—Ç–≤–æ—Ä—é—é —Ç–∞–±–ª–∏—Ü—ñ –≤ PostgreSQL...
‚úÖ –í—Å—ñ —Ç–∞–±–ª–∏—Ü—ñ —Ç–∞ —ñ–Ω–¥–µ–∫—Å–∏ PostgreSQL —Å—Ç–≤–æ—Ä–µ–Ω–æ!
```

### –°—Ü–µ–Ω–∞—Ä—ñ–π 3: –°—Ö–µ–º–∞ –≤–∂–µ –æ–Ω–æ–≤–ª–µ–Ω–∞
```
üîÑ –ü–µ—Ä–µ–≤—ñ—Ä—è—é –Ω–µ–æ–±—Ö—ñ–¥–Ω—ñ—Å—Ç—å –º—ñ–≥—Ä–∞—Ü—ñ–π...
‚úÖ –ú—ñ–≥—Ä–∞—Ü—ñ—ó –∑–∞–≤–µ—Ä—à–µ–Ω–æ!
üêò –°—Ç–≤–æ—Ä—é—é —Ç–∞–±–ª–∏—Ü—ñ –≤ PostgreSQL...
‚úÖ –í—Å—ñ —Ç–∞–±–ª–∏—Ü—ñ —Ç–∞ —ñ–Ω–¥–µ–∫—Å–∏ PostgreSQL —Å—Ç–≤–æ—Ä–µ–Ω–æ!
```

## –ú–∞–π–±—É—Ç–Ω—ñ –º—ñ–≥—Ä–∞—Ü—ñ—ó

–î–ª—è –¥–æ–¥–∞–≤–∞–Ω–Ω—è –Ω–æ–≤–∏—Ö –º—ñ–≥—Ä–∞—Ü—ñ–π:

1. –î–æ–¥–∞—Ç–∏ –Ω–æ–≤–∏–π –±–ª–æ–∫ try-except –≤ —Ä–æ–∑–¥—ñ–ª "–ú–Ü–ì–†–ê–¶–Ü–á –¥–ª—è —ñ—Å–Ω—É—é—á–∏—Ö —Ç–∞–±–ª–∏—Ü—å"
2. –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —ñ—Å–Ω—É–≤–∞–Ω–Ω—è —Ç–∞–±–ª–∏—Ü—ñ
3. –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —ñ—Å–Ω—É–≤–∞–Ω–Ω—è –∫–æ–ª–æ–Ω–æ–∫
4. –í–∏–∫–æ–Ω–∞—Ç–∏ –Ω–µ–æ–±—Ö—ñ–¥–Ω—ñ ALTER TABLE
5. –õ–æ–≥—É–≤–∞—Ç–∏ –¥—ñ—ó

**–ü—Ä–∏–∫–ª–∞–¥:**
```python
# –ú—ñ–≥—Ä–∞—Ü—ñ—è 3: orders - –¥–æ–¥–∞—Ç–∏ –Ω–æ–≤—É –∫–æ–ª–æ–Ω–∫—É
try:
    check = await conn.fetchval("""
        SELECT EXISTS (
            SELECT FROM information_schema.tables 
            WHERE table_name = 'orders'
        )
    """)
    
    if check:
        has_column = await conn.fetchval("""
            SELECT EXISTS (
                SELECT FROM information_schema.columns 
                WHERE table_name = 'orders' AND column_name = 'new_column'
            )
        """)
        
        if not has_column:
            logger.info("üîÑ –ú—ñ–≥—Ä–∞—Ü—ñ—è orders: –¥–æ–¥–∞–≤–∞–Ω–Ω—è new_column...")
            await conn.execute("ALTER TABLE orders ADD COLUMN new_column TEXT")
            logger.info("‚úÖ –ö–æ–ª–æ–Ω–∫–∞ new_column –¥–æ–¥–∞–Ω–∞")
except Exception as e:
    logger.warning(f"‚ö†Ô∏è –ü–æ–º–∏–ª–∫–∞ –º—ñ–≥—Ä–∞—Ü—ñ—ó orders: {e}")
```

## –°—Ç–∞—Ç—É—Å

| –ú—ñ–≥—Ä–∞—Ü—ñ—è | –°—Ç–∞—Ç—É—Å | –û–ø–∏—Å |
|----------|--------|------|
| ratings: driver_user_id ‚Üí to_user_id | ‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω–æ | –ü–µ—Ä–µ–π–º–µ–Ω—É–≤–∞–Ω–Ω—è –∫–æ–ª–æ–Ω–∫–∏ |
| ratings: –¥–æ–¥–∞—Ç–∏ from_user_id | ‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω–æ | –ù–æ–≤–∞ –∫–æ–ª–æ–Ω–∫–∞ |
| client_ratings: –¥–æ–¥–∞—Ç–∏ driver_id | ‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω–æ | –ù–æ–≤–∞ –∫–æ–ª–æ–Ω–∫–∞ |
| –ë–µ–∑–ø–µ—á–Ω—ñ —ñ–Ω–¥–µ–∫—Å–∏ | ‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω–æ | –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –ø–µ—Ä–µ–¥ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è–º |

**–í—Å—ñ –º—ñ–≥—Ä–∞—Ü—ñ—ó –≥–æ—Ç–æ–≤—ñ –¥–æ production!** üöÄ
